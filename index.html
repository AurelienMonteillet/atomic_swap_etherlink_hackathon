<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etherlink x Jstz | Atomic Swap</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ether: {
                            green: '#80F89B', // Etherlink Brand Green (approx)
                            dark: '#020202',
                            card: '#111111',
                            border: '#222222',
                            text: '#e2e8f0'
                        },
                        jstz: {
                            accent: '#FFD700' // Gold/Yellow for Jstz
                        }
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'Inter', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Load Jstz Client SDK -->
    <script type="module">
        // Try to load Jstz SDK and expose it globally
        try {
            const JstzModule = await import('https://esm.sh/@jstz-dev/jstz-client@0.1.1-alpha.5');
            window.JstzClient = JstzModule.default || JstzModule.Jstz || JstzModule;
            console.log('[JSTZ SDK] Loaded successfully:', window.JstzClient);
        } catch (e) {
            console.warn('[JSTZ SDK] Failed to load from esm.sh:', e);
            window.JstzClient = null;
        }
    </script>
    
    <!-- Jstz Wallet Extension Integration -->
    <script>
        // Jstz Signer Extension Types and Functions
        const JstzSignerEventTypes = {
            SIGN: 'JSTZ_SIGN_REQUEST_TO_EXTENSION',
            GET_ADDRESS: 'JSTZ_GET_ADDRESS_REQUEST_TO_EXTENSION',
            SIGN_RESPONSE: 'JSTZ_SIGN_RESPONSE_FROM_EXTENSION',
            GET_ADDRESS_RESPONSE: 'JSTZ_GET_ADDRESS_RESPONSE_FROM_EXTENSION'
        };

        // Check if Jstz extension is installed
        function isJstzExtensionInstalled() {
            try {
                return typeof window.jstzCallSignerExtension === 'function';
            } catch (e) {
                return false;
            }
        }
        
        // Check if Jstz SDK is loaded
        function isJstzSdkLoaded() {
            return !!window.JstzClient;
        }

        // Request address from Jstz wallet extension
        async function getJstzAddress() {
            if (!isJstzExtensionInstalled()) {
                throw new Error('Jstz wallet extension not installed. Please install from: https://github.com/jstz-dev/dev-wallet/releases');
            }
            
            try {
                const response = await window.jstzCallSignerExtension({
                    type: JstzSignerEventTypes.GET_ADDRESS
                });
                return response.data;
            } catch (error) {
                throw new Error(`Failed to get Jstz address: ${error.message}`);
            }
        }

        // Request signature from Jstz wallet extension
        async function requestJstzSignature(operation) {
            if (!isJstzExtensionInstalled()) {
                throw new Error('Jstz wallet extension not installed');
            }
            
            try {
                const response = await window.jstzCallSignerExtension({
                    type: JstzSignerEventTypes.SIGN,
                    content: operation
                });
                return response.data;
            } catch (error) {
                throw new Error(`Failed to sign Jstz operation: ${error.message}`);
            }
        }

        // Inject and poll Jstz operation
        async function injectJstzOperation(operation, signature, rpcUrl = 'https://privatenet.jstz.info') {
            const response = await fetch(`${rpcUrl}/operations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    inner: operation,
                    signature: signature
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Jstz injection failed: ${errorText}`);
            }
            
            return await response.json();
        }

        // Poll for operation result
        async function pollJstzOperation(operationHash, rpcUrl = 'https://privatenet.jstz.info', maxAttempts = 30) {
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    const response = await fetch(`${rpcUrl}/operations/${operationHash}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'applied' || result.status === 'failed') {
                            return result;
                        }
                    }
                } catch (e) {
                    // Continue polling
                }
                await new Promise(r => setTimeout(r, 1000));
            }
            throw new Error('Operation polling timeout');
        }
    </script>
    <!-- Automated Test Suite (run runAllTests() in console) -->
    <script src="test-scenarios.js"></script>

    <style>
        body {
            background-color: #020202;
            /* Etherlink-style diagonal glow */
            background-image: 
                radial-gradient(circle at 20% 0%, rgba(128, 248, 155, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 100%, rgba(128, 248, 155, 0.05) 0%, transparent 50%);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #80F89B; }

        .glass-card {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .neon-text {
            text-shadow: 0 0 20px rgba(128, 248, 155, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #80F89B;
            box-shadow: 0 0 15px rgba(128, 248, 155, 0.1);
        }

        .btn-primary {
            background: #80F89B;
            color: #000;
            font-weight: 600;
            letter-spacing: -0.02em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: 0.5s;
        }
        .btn-primary:hover::after {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(128, 248, 155, 0.3);
            background: #6ee786;
        }

        .step-line-bg {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
            transform: translateY(-50%);
        }
        .step-progress {
            position: absolute;
            top: 50%;
            left: 0;
            height: 1px;
            background: #80F89B;
            box-shadow: 0 0 10px rgba(128, 248, 155, 0.5);
            z-index: 0;
            transform: translateY(-50%);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
        }
        
        .step-dot.active {
            background: #80F89B;
            color: #000;
            border-color: #80F89B;
            box-shadow: 0 0 20px rgba(128, 248, 155, 0.3);
            transform: scale(1.1);
        }

        .step-dot.completed {
            background: #000;
            color: #80F89B;
            border-color: #80F89B;
        }

        .step-label {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: #666;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .step-dot.active + .step-label {
            color: #80F89B;
            text-shadow: 0 0 10px rgba(128, 248, 155, 0.3);
        }
        .step-dot.completed + .step-label {
            color: #e2e8f0;
        }

        /* Secret Blur */
        .secret-blur {
            filter: blur(8px);
            cursor: pointer;
            transition: filter 0.3s;
            user-select: none;
        }
        .secret-blur:hover, .secret-blur.revealed {
            filter: blur(0);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="w-full border-b border-white/5 bg-ether-card/50 backdrop-blur-md fixed top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
                    <!-- Logo -->
                    <img src="/image.png" alt="Atomic Swap Logo" class="h-10 w-auto object-contain" style="max-height: 48px;">
                    <span class="text-xl font-bold tracking-tight text-white">Etherlink <span class="text-gray-500 mx-1">x</span> <span class="text-jstz-accent">Jstz</span></span>
                </div>
                
                <div class="hidden md:flex items-center space-x-4">
                    <!-- Help/Docs Button -->
                    <a href="https://github.com/AurelienMonteillet/atomic_swap_etherlink_hackathon#readme" target="_blank" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20 hover:border-blue-500/50 transition text-blue-400 text-xs font-medium">
                        <i class="fa-solid fa-book"></i>
                        <span>How to Use</span>
                    </a>
                    
                    <!-- GitHub Link -->
                    <a href="https://github.com/AurelienMonteillet/atomic_swap_etherlink_hackathon" target="_blank" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-white/20 transition text-gray-400 hover:text-white text-xs font-medium" title="View on GitHub">
                        <i class="fa-brands fa-github"></i>
                        <span>GitHub</span>
                    </a>
                    
                    <div id="network-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-white/10 cursor-pointer hover:border-ether-green/50 transition" onclick="switchToEtherlink(128123)" title="Click to switch to Etherlink Testnet">
                        <div id="network-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                        <span id="network-name" class="text-xs text-gray-400">Not Connected</span>
                    </div>
                    
                    <!-- Notification Bell -->
                    <div id="notification-bell" class="relative cursor-pointer p-2 rounded-lg hover:bg-white/10 transition" onclick="toggleNotifications()" title="Notifications">
                        <i class="fa-solid fa-bell text-gray-400 hover:text-white transition"></i>
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center animate-pulse">0</span>
                        
                        <!-- Notification Dropdown -->
                        <div id="notification-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-ether-dark border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden">
                            <div class="p-3 border-b border-white/10 flex items-center justify-between">
                                <span class="text-sm font-bold text-white"><i class="fa-solid fa-bell mr-2"></i>Notifications</span>
                                <button onclick="clearAllNotifications(event)" class="text-xs text-gray-400 hover:text-white">Clear all</button>
                            </div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto">
                                <div class="p-4 text-center text-gray-500 text-sm">
                                    <i class="fa-regular fa-bell-slash text-2xl mb-2 block"></i>
                                    No notifications yet
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="wallet-etherlink" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition text-sm font-medium">
                        <i class="fa-brands fa-ethereum text-ether-green"></i>
                        <span id="wallet-etherlink-text">Connect Etherlink</span>
                        <span id="wallet-balance" class="hidden text-ether-green font-mono text-xs"></span>
                    </button>
                    <button id="wallet-jstz" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition text-sm font-medium">
                        <i class="fa-solid fa-bolt text-jstz-accent"></i>
                        <span id="wallet-jstz-text">Connect Jstz</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow pt-24 pb-12 px-4 flex flex-col items-center justify-center relative overflow-hidden">
        
        <!-- Decorative Elements -->
        <div class="absolute top-1/4 left-10 w-64 h-64 bg-green-500/10 rounded-full blur-3xl animate-pulse-slow"></div>
        <div class="absolute bottom-1/4 right-10 w-96 h-96 bg-yellow-500/5 rounded-full blur-3xl animate-pulse-slow" style="animation-delay: 1.5s;"></div>

        <!-- Getting Started Banner -->
        <div class="w-full max-w-6xl mb-6 z-10">
            <div class="bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-jstz-accent/10 border border-white/10 rounded-2xl p-4 backdrop-blur-sm">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-rocket text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold text-sm mb-1">First time here? üëã</h3>
                            <p class="text-gray-400 text-xs leading-relaxed">
                                This is a <span class="text-ether-green font-medium">trustless atomic swap</span> between Etherlink and Jstz. 
                                You'll need an <span class="text-white">EVM wallet</span> (MetaMask, Rabby, etc.) + <span class="text-jstz-accent">Jstz Wallet</span> to complete a swap.
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <a href="https://github.com/AurelienMonteillet/atomic_swap_etherlink_hackathon#-quick-start-5-minutes" target="_blank" 
                           class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-400 hover:to-purple-400 text-white text-xs font-bold transition-all shadow-lg hover:shadow-blue-500/25">
                            <i class="fa-solid fa-play"></i>
                            Quick Start Guide
                        </a>
                        <a href="https://github.com/AurelienMonteillet/atomic_swap_etherlink_hackathon" target="_blank"
                           class="flex items-center gap-2 px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 hover:text-white text-xs font-medium transition-all">
                            <i class="fa-brands fa-github"></i>
                            View Code
                        </a>
                    </div>
                </div>
                
                <!-- Quick Setup Steps -->
                <div class="mt-4 pt-4 border-t border-white/5">
                    <div class="flex flex-wrap items-center gap-3 text-xs">
                        <span class="text-gray-500">Setup:</span>
                        <a href="https://faucet.etherlink.com" target="_blank" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-ether-green/10 text-ether-green hover:bg-ether-green/20 transition">
                            <i class="fa-solid fa-faucet"></i>
                            Get Test XTZ
                        </a>
                        <a href="https://jstz.tezos.com/installation" target="_blank" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-jstz-accent/10 text-jstz-accent hover:bg-jstz-accent/20 transition">
                            <i class="fa-solid fa-terminal"></i>
                            Install Jstz CLI
                        </a>
                        <a href="https://github.com/jstz-dev/dev-wallet/releases" target="_blank" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-purple-500/10 text-purple-400 hover:bg-purple-500/20 transition">
                            <i class="fa-solid fa-puzzle-piece"></i>
                            Jstz Wallet Extension
                        </a>
                        <a href="https://github.com/AurelienMonteillet/atomic_swap_etherlink_hackathon#-complete-atomic-swap-test" target="_blank" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white transition">
                            <i class="fa-solid fa-list-check"></i>
                            Full Test Guide
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-8 z-10">
            
            <!-- Left Column: Swap Interface -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                
                <!-- Progress Stepper -->
                <div class="glass-card rounded-2xl p-8 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em]">Swap Status</h3>
                        <div class="flex items-center gap-2 text-[10px] text-gray-500">
                            <div class="w-1.5 h-1.5 rounded-full bg-ether-green animate-pulse"></div>
                            LIVE
                        </div>
                    </div>

                    <div class="relative px-4 pb-4">
                        <div class="step-line-bg"></div>
                        <div class="step-progress" id="progress-bar"></div>
                        
                        <div class="flex justify-between items-center relative z-10">
                            <div class="relative group cursor-default" id="step-1">
                                <div class="step-dot">1</div>
                                <span class="step-label">Initiate</span>
                            </div>
                            <div class="relative group cursor-default" id="step-2">
                                <div class="step-dot">2</div>
                                <span class="step-label">Participate</span>
                            </div>
                            <div class="relative group cursor-default" id="step-3">
                                <div class="step-dot">3</div>
                                <span class="step-label">Redeem</span>
                            </div>
                            <div class="relative group cursor-default" id="step-4">
                                <div class="step-dot">4</div>
                                <span class="step-label">Complete</span>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Main Swap Card -->
                <div class="glass-card rounded-2xl p-1">
                    <!-- Tabs -->
                    <div class="grid grid-cols-4 gap-1 p-1 bg-black/20 rounded-t-xl">
                        <button onclick="setTab('create')" id="tab-create" class="flex-1 py-3 rounded-lg text-sm font-semibold text-white bg-ether-border shadow-lg transition-all">
                            Initiate
                        </button>
                        <button onclick="setTab('join')" id="tab-join" class="flex-1 py-3 rounded-lg text-sm font-semibold text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                            Join
                        </button>
                        <button onclick="setTab('redeem')" id="tab-redeem" class="flex-1 py-3 rounded-lg text-sm font-semibold text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                            Redeem
                        </button>
                        <button onclick="setTab('myswaps')" id="tab-myswaps" class="flex-1 py-3 rounded-lg text-sm font-semibold text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                            My Swaps
                        </button>
                    </div>

                    <div class="p-6 sm:p-8">
                        
                        <!-- INITIATE & JOIN CONTENT -->
                        <div id="initiate-join-content" class="space-y-6">
                            <!-- Chain Selection -->
                            <div class="grid grid-cols-2 gap-4 p-1 bg-black/20 rounded-xl">
                            <button onclick="setChain('etherlink')" id="chain-etherlink" class="relative py-3 rounded-lg border border-ether-green bg-ether-green/10 text-white transition-all group overflow-hidden">
                                <div class="flex items-center justify-center gap-2 relative z-10">
                                    <i class="fa-brands fa-ethereum text-ether-green"></i>
                                    <span class="text-sm font-bold">From Etherlink</span>
                                    <i class="fa-solid fa-arrow-right text-gray-500 text-xs"></i>
                                    <i class="fa-solid fa-layer-group text-gray-500 text-xs"></i>
                                </div>
                                <div class="absolute inset-0 bg-ether-green/5 opacity-0 group-hover:opacity-100 transition"></div>
                            </button>
                            <button onclick="setChain('jstz')" id="chain-jstz" class="relative py-3 rounded-lg border border-transparent text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                                <div class="flex items-center justify-center gap-2 relative z-10">
                                    <i class="fa-solid fa-layer-group text-jstz-accent"></i>
                                    <span class="text-sm font-bold">From Jstz</span>
                                    <i class="fa-solid fa-arrow-right text-gray-500 text-xs"></i>
                                    <i class="fa-brands fa-ethereum text-gray-500 text-xs"></i>
                                </div>
                            </button>
                        </div>

                        <!-- Secret Generator Section -->
                        <div id="secret-section" class="p-5 rounded-xl bg-gradient-to-br from-white/5 to-transparent border border-white/5 relative overflow-hidden group transition-all duration-300">
                            <div class="absolute top-0 right-0 p-3 opacity-50 group-hover:opacity-100 transition">
                                <i class="fa-solid fa-lock text-ether-green"></i>
                            </div>
                            <label class="text-xs font-bold text-ether-green uppercase tracking-widest mb-3 block">
                                <i class="fa-solid fa-key mr-1"></i> Cryptographic Proof
                            </label>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="proof-inputs">
                                <div id="secret-container">
                                    <span class="text-[10px] text-gray-400 uppercase block mb-1">Secret (Preimage) - <span class="text-red-400">Keep Safe</span></span>
                                    <div class="relative">
                                        <input type="text" id="secret-input" class="w-full input-field rounded-lg p-3 text-sm font-mono text-white secret-blur" readonly value="Generating...">
                                        <button onclick="copyToClipboard('secret-input')" class="absolute right-2 top-2 text-gray-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                </div>
                                <div id="hash-container">
                                    <span class="text-[10px] text-gray-400 uppercase block mb-1">HashLock (Public)</span>
                                    <div class="relative flex gap-2">
                                        <input type="text" id="hash-input" class="w-full input-field rounded-lg p-3 text-sm font-mono text-gray-300" readonly value="Waiting...">
                                        <button id="copy-hash-btn" onclick="copyToClipboard('hash-input')" class="absolute right-10 top-2 text-gray-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                                        <button id="verify-swap-btn" onclick="verifyAliceSwapDetails()" class="hidden px-3 py-2 rounded-lg bg-blue-500/20 border border-blue-500/30 text-blue-400 hover:bg-blue-500/30 text-xs font-bold whitespace-nowrap transition">
                                            <i class="fa-solid fa-magnifying-glass mr-1"></i> Verify
                                        </button>
                                        <button id="verify-jstz-btn" onclick="verifyViaJstzWallet()" class="hidden px-3 py-2 rounded-lg bg-purple-500/20 border border-purple-500/30 text-purple-400 hover:bg-purple-500/30 text-xs font-bold whitespace-nowrap transition animate-pulse">
                                            <i class="fa-solid fa-wallet mr-1"></i> Connect Jstz to Verify
                                        </button>
                                        <button id="skip-verify-btn" onclick="skipJstzVerification()" class="hidden px-3 py-2 rounded-lg bg-orange-500/20 border border-orange-500/30 text-orange-400 hover:bg-orange-500/30 text-xs font-bold whitespace-nowrap transition" title="For CLI users who verified manually">
                                            <i class="fa-solid fa-terminal mr-1"></i> I verified via CLI
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alice Swap Details (shown after verification in Join mode) -->
                            <div id="alice-swap-details" class="hidden mt-4 p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-purple-500/10 border border-blue-500/20">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">
                                        <i class="fa-solid fa-circle-check mr-1"></i> Alice's Swap Found
                                    </span>
                                    <span id="alice-swap-status" class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/20 text-green-400">OPEN</span>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-xs">
                                    <div>
                                        <span class="text-gray-500 block">Amount Locked</span>
                                        <span id="alice-swap-amount" class="text-white font-bold text-lg">-- XTZ</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Expires In</span>
                                        <span id="alice-swap-expiry" class="text-white font-mono">--:--:--</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Sender (Alice)</span>
                                        <span id="alice-swap-sender" class="text-gray-300 font-mono text-[10px]">0x...</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Chain</span>
                                        <span id="alice-swap-chain" class="text-ether-green font-medium">Etherlink</span>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t border-white/10 flex items-center justify-between">
                                    <p class="text-xs text-gray-400">
                                        <i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-1"></i>
                                        Review the amount before matching!
                                    </p>
                                    <button onclick="cancelJoinSwap()" class="text-xs text-red-400 hover:text-red-300 underline">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <button id="regen-secret-btn" onclick="generateNewSecret()" class="mt-3 text-xs text-gray-400 hover:text-white underline decoration-dotted underline-offset-4">
                                Generate New Secret
                            </button>
                        </div>

                        <!-- Input Fields -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="relative">
                                    <label class="block text-sm text-gray-400 mb-1">Asset</label>
                                    <div onclick="toggleTokenSelector()" class="flex items-center gap-2 input-field rounded-lg p-3 cursor-pointer hover:bg-white/10 transition">
                                        <img src="https://cryptologos.cc/logos/tezos-xtz-logo.svg?v=026" class="w-6 h-6 rounded-full bg-white p-0.5" id="asset-icon">
                                        <span class="font-bold text-white" id="asset-symbol">XTZ</span>
                                        <i class="fa-solid fa-chevron-down ml-auto text-xs text-gray-500"></i>
                                    </div>
                                    <!-- Token Dropdown -->
                                    <div id="token-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-ether-card border border-white/10 rounded-lg shadow-xl z-50 flex-col max-h-60 overflow-y-auto">
                                        <!-- Tokens will be rendered here by JS -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Amount</label>
                                    <input type="number" id="amount-input" placeholder="0.00" class="w-full input-field rounded-lg p-3 text-white font-mono focus:outline-none">
                                    <div id="selected-token-balance" class="text-xs text-gray-500 mt-1">Balance: -- </div>
                                </div>
                            </div>

                <div>
                    <label id="counterparty-label" class="block text-sm text-gray-400 mb-1 flex items-center gap-1">
                        <span id="counterparty-label-text">Recipient Address</span>
                        <span id="counterparty-required" class="text-red-400 text-xs">(required)</span>
                        <div class="relative group">
                            <span class="w-4 h-4 inline-flex items-center justify-center rounded-full bg-white/10 text-[10px] text-gray-400 cursor-help hover:bg-white/20 transition">?</span>
                            <div id="counterparty-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 border border-white/20 rounded-lg text-xs text-gray-300 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 shadow-xl">
                                <div class="font-semibold text-white mb-1">üîê Security: Who can claim YOUR locked funds?</div>
                                <p id="counterparty-tooltip-text">Enter the address of the person who will claim the funds you are locking.</p>
                                <div class="absolute top-full left-1/2 -translate-x-1/2 border-8 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </label>
                    <div class="relative">
                        <input type="text" id="counterparty-input" placeholder="Loading..." class="w-full input-field rounded-lg p-3 text-white font-mono text-sm focus:outline-none pr-24">
                        <span id="counterparty-format-hint" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">0x...</span>
                    </div>
                    <p id="counterparty-error" class="text-red-400 text-xs mt-1 hidden">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                        <span id="counterparty-error-text">Invalid address format</span>
                    </p>
                    <p id="counterparty-help" class="text-gray-500 text-xs mt-1">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        <span id="counterparty-help-text">This person will be able to claim your locked funds with the secret.</span>
                    </p>
                </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Timelock (Mins)</label>
                                    <input type="number" id="timelock-input" value="60" class="w-full input-field rounded-lg p-3 text-white font-mono focus:outline-none">
                                </div>
                                <div class="flex items-end">
                                    <div class="text-xs text-gray-500 mb-3">
                                        <i class="fa-regular fa-clock mr-1"></i> Funds revert if not claimed.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button onclick="executeAction()" id="main-action-btn" class="btn-primary w-full py-4 rounded-xl text-lg shadow-[0_0_20px_rgba(57,255,20,0.2)] flex items-center justify-center gap-2 group">
                            <span>Initiate Swap</span>
                            <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                        </div> <!-- End initiate-join-content -->

                        <!-- REDEEM / REFUND CONTENT -->
                        <div id="redeem-content" class="hidden space-y-6">
                            <div class="bg-black/20 rounded-xl p-4 border border-white/5">
                                <p class="text-sm text-gray-400 mb-4 text-center">
                                    <i class="fa-solid fa-circle-info mr-2"></i>
                                    Enter the Swap ID (HashLock) to claim or refund funds.
                                </p>
                                
                                <!-- Swap ID Input -->
                                <div class="mb-4">
                                    <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                        Swap ID / HashLock
                                        <div class="relative group">
                                            <span class="w-3 h-3 inline-flex items-center justify-center rounded-full bg-white/10 text-[8px] text-gray-400 cursor-help">?</span>
                                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 border border-white/20 rounded text-[10px] text-gray-300 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                                The HashLock used when initiating the swap
                                            </div>
                                        </div>
                                    </label>
                                    <input type="text" id="swap-id-input" placeholder="0x..." class="w-full input-field rounded-lg p-3 text-white font-mono text-sm focus:outline-none">
                                </div>
                                
                                <!-- Secret Input -->
                                <div class="mb-6">
                                    <label class="block text-xs text-gray-400 mb-1 flex items-center gap-1">
                                        Secret (Required for Claim)
                                        <div class="relative group">
                                            <span class="w-3 h-3 inline-flex items-center justify-center rounded-full bg-white/10 text-[8px] text-gray-400 cursor-help">?</span>
                                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 border border-white/20 rounded text-[10px] text-gray-300 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                                The preimage/secret revealed by Alice to claim funds
                                            </div>
                                        </div>
                                    </label>
                                    <input type="text" id="secret-input-claim" placeholder="0x..." class="w-full input-field rounded-lg p-3 text-white font-mono text-sm focus:outline-none">
                                </div>

                                <!-- Connected Chain Indicator -->
                                <div id="redeem-chain-indicator" class="mb-4 p-3 rounded-xl border border-white/10 bg-white/5">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400">Action will be executed on:</span>
                                        <span id="redeem-chain-badge" class="px-3 py-1 rounded-lg text-xs font-bold">
                                            Not Connected
                                        </span>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="claimSwap()" id="claim-btn" class="py-4 px-4 rounded-xl bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-semibold flex flex-col items-center justify-center gap-1 transition-all shadow-lg shadow-green-500/20 group">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-hand-holding-dollar text-lg"></i>
                                            <span id="claim-btn-text">Claim Funds</span>
                                        </div>
                                        <span id="claim-btn-chain" class="text-[10px] opacity-70 font-normal">Connect wallet first</span>
                                    </button>
                                    
                                    <button onclick="refundSwap()" id="refund-btn" class="py-4 px-4 rounded-xl bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-semibold flex flex-col items-center justify-center gap-1 transition-all shadow-lg shadow-red-500/20 group">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-rotate-left text-lg"></i>
                                            <span id="refund-btn-text">Refund</span>
                                        </div>
                                        <span id="refund-btn-chain" class="text-[10px] opacity-70 font-normal">Connect wallet first</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- MY SWAPS CONTENT -->
                        <div id="myswaps-content" class="hidden space-y-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">
                                    <i class="fa-solid fa-clock-rotate-left mr-2 text-purple-400"></i>
                                    Your Active Swaps
                                </h3>
                                <button onclick="loadMySwaps()" class="text-xs px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition">
                                    <i class="fa-solid fa-refresh mr-1"></i> Refresh
                                </button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="swaps-loading" class="hidden text-center py-8">
                                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-purple-400 mb-2"></i>
                                <p class="text-gray-500 text-sm">Loading your swaps...</p>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="swaps-empty" class="text-center py-8 bg-black/20 rounded-xl border border-dashed border-white/10">
                                <i class="fa-solid fa-inbox text-3xl text-gray-600 mb-2"></i>
                                <p class="text-gray-500 text-sm">No active swaps found</p>
                                <p class="text-gray-600 text-xs mt-1">Initiate or join a swap to see it here</p>
                            </div>
                            
                            <!-- Swaps List -->
                            <div id="swaps-list" class="space-y-3">
                                <!-- Swap cards will be inserted here -->
                            </div>
                        </div>

                    </div>
                </div>
        </div>

            <!-- Right Column: Info & Console -->
            <div class="lg:col-span-5 flex flex-col gap-6">
                
                <!-- Network Status - Clickable links to deployed contracts -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-sm font-mono text-gray-400 mb-4 uppercase tracking-wider">Deployed Contracts</h3>
            
                    <div class="flex items-center justify-between relative">
                        <!-- Left: Etherlink Contract -->
                        <a href="https://testnet.explorer.etherlink.com/address/0x22CD807FAb2E902E62ECaD7bd97bfDD8fD69ccC4" target="_blank" class="text-center z-10 group cursor-pointer">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 group-hover:border-green-500/50 flex items-center justify-center mx-auto mb-2 shadow-lg relative overflow-hidden transition-all group-hover:scale-105">
                                <div class="absolute inset-0 bg-green-500/10 group-hover:bg-green-500/20 transition"></div>
                                <i class="fa-brands fa-ethereum text-2xl text-green-400"></i>
                            </div>
                            <div class="text-sm font-bold text-gray-200 group-hover:text-green-400 transition">Etherlink</div>
                            <div class="text-[10px] text-green-500 flex items-center justify-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                Live
                                <i class="fa-solid fa-external-link text-[8px] opacity-0 group-hover:opacity-100 transition"></i>
                            </div>
                        </a>

                        <!-- Center: Animation -->
                        <div class="flex-1 h-px bg-slate-700 mx-4 relative">
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center z-20">
                                <i class="fa-solid fa-arrow-right-arrow-left text-gray-500 text-xs"></i>
                            </div>
                            <div class="absolute top-0 left-0 h-full w-full bg-gradient-to-r from-green-500/30 via-transparent to-yellow-500/30 animate-pulse"></div>
                        </div>

                        <!-- Right: Jstz Contract -->
                        <a href="https://privatenet.dashboard.jstz.info/smart-functions/KT1HCuUJm1rZWqnicoXFHu7H3TP8912G1qmn" target="_blank" class="text-center z-10 group cursor-pointer" title="KT1HCuUJm1rZWqnicoXFHu7H3TP8912G1qmn">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 group-hover:border-jstz-accent/50 flex items-center justify-center mx-auto mb-2 shadow-lg relative overflow-hidden transition-all group-hover:scale-105">
                                <div class="absolute inset-0 bg-yellow-500/10 group-hover:bg-yellow-500/20 transition"></div>
                                <i class="fa-solid fa-layer-group text-2xl text-jstz-accent"></i>
                            </div>
                            <div class="text-sm font-bold text-gray-200 group-hover:text-jstz-accent transition">Jstz</div>
                            <div class="text-[10px] text-jstz-accent flex items-center justify-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-jstz-accent animate-pulse"></span>
                                Live
                                <i class="fa-solid fa-external-link text-[8px] opacity-0 group-hover:opacity-100 transition"></i>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Contract addresses -->
                    <div class="mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-2 text-[9px] font-mono text-gray-500">
                        <div class="truncate" title="0x22CD807FAb2E902E62ECaD7bd97bfDD8fD69ccC4">
                            <span class="text-gray-600">ETH:</span> 0x103b4...2Cd7
                        </div>
                        <div class="truncate text-right" title="KT1HCuUJm1rZWqnicoXFHu7H3TP8912G1qmn">
                            <span class="text-gray-600">JSTZ:</span> KT18pc...S8Bz
                        </div>
                    </div>
                </div>

                <!-- Terminal / Logs -->
                <div class="glass-card rounded-2xl flex flex-col flex-grow overflow-hidden h-96 lg:h-auto border-t-4 border-t-ether-green">
                    <div class="bg-black/40 p-3 flex items-center justify-between border-b border-white/5">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                        </div>
                        <div class="text-[10px] font-mono text-gray-500">swap_daemon.js</div>
                    </div>
                    <div id="terminal-body" class="p-4 font-mono text-xs space-y-2 overflow-y-auto flex-grow bg-black/20 max-h-[400px]">
                        <div class="text-gray-500">Last login: <span id="login-time"></span> on tty1</div>
                        <div class="text-green-500/50">Initializing atomic swap protocol...</div>
                        <div class="text-green-500/50">Loaded JS environment.</div>
                        <div class="text-white">> Ready.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 bg-black/20 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-xs text-gray-500">Built for Etherlink Internal Hackathon</p>
        </div>
    </footer>

    <script>
        // --- REAL CONTRACT INTEGRATION ---

        // Contract Configuration - Per Network
        const NETWORK_CONFIG = {
            // Hardhat Local
            31337: {
                name: 'Hardhat Local',
                rpcUrl: 'http://127.0.0.1:8545',
                htlcAddress: '0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0',
                explorer: null
            },
            // Etherlink Testnet (Ghostnet) - SHA-256 compatible - HARDENED v2.0
            128123: {
                name: 'Etherlink Testnet',
                rpcUrl: 'https://node.ghostnet.etherlink.com',
                htlcAddress: '0x22CD807FAb2E902E62ECaD7bd97bfDD8fD69ccC4',
                explorer: 'https://testnet.explorer.etherlink.com'
            },
            // Etherlink Mainnet
            42793: {
                name: 'Etherlink Mainnet',
                rpcUrl: 'https://node.mainnet.etherlink.com',
                htlcAddress: null, // TODO: Deploy and fill this
                explorer: 'https://explorer.etherlink.com'
            }
        };

        // Default to testnet for real testing
        const DEFAULT_CHAIN_ID = 128123; // Etherlink Testnet

        const CONFIG = {
            // Current Etherlink config (will be updated based on connected network)
            etherlink: {
                contractAddress: NETWORK_CONFIG[DEFAULT_CHAIN_ID]?.htlcAddress || '0x5FbDB2315678afecb367f032d93F642f64180aa3',
                rpcUrl: NETWORK_CONFIG[DEFAULT_CHAIN_ID]?.rpcUrl || 'http://127.0.0.1:8545',
                chainId: DEFAULT_CHAIN_ID,
                abi: [
                    "function initiateSwap(address recipient, bytes32 hashLock, uint256 expiration) external payable returns (bytes32)",
                    "function claimSwap(bytes32 swapId, bytes calldata secret) external returns (bool)",
                    "function refundSwap(bytes32 swapId) external returns (bool)",
                    "function getSwap(bytes32 swapId) external view returns (address recipient, address sender, uint256 amount, uint256 expiration, bytes32 hashLock, uint8 status)",
                    "function swapPresent(bytes32 swapId) external view returns (bool)",
                    "event SwapInitiated(bytes32 indexed swapId, address payable sender, address recipient, uint256 amount, bytes32 hashLock, uint256 expiration)",
                    "event SwapClaimed(bytes32 indexed swapId, address claimer, bytes secret)",
                    "event SwapRefunded(bytes32 indexed swapId, address sender, uint256 amount)"
                ]
            },
            // Jstz HTLC Smart Function
            jstz: {
                // Jstz Privatenet - accessible to everyone
                rpcUrl: 'https://privatenet.jstz.info',
                network: 'privatenet',
                functionAddress: 'jstz://htlc/',
                contractAddress: 'KT1HCuUJm1rZWqnicoXFHu7H3TP8912G1qmn'
            }
        };

        // ERC20 ABI for token interactions
        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];

        // Network Chain IDs
        const CHAIN_IDS = {
            HARDHAT_LOCAL: 31337,
            ETHERLINK_MAINNET: 42793,
            ETHERLINK_TESTNET: 128123
        };

        // Etherlink Tokens - Simplified for POC
        // Only XTZ (native) and WXTZ (wrapped) for atomic swap demonstration
        const TOKENS = {
            XTZ: {
                symbol: 'XTZ',
                name: 'Tezos (Native)',
                address: null, // Native token
                decimals: 18,
                icon: 'https://cryptologos.cc/logos/tezos-xtz-logo.svg?v=026',
                isNative: true,
                chains: [CHAIN_IDS.HARDHAT_LOCAL, CHAIN_IDS.ETHERLINK_MAINNET, CHAIN_IDS.ETHERLINK_TESTNET]
            },
            WXTZ: {
                symbol: 'WXTZ',
                name: 'Wrapped XTZ',
                // Addresses per network
                addresses: {
                    [CHAIN_IDS.ETHERLINK_MAINNET]: '0xc9B53AB2679f573e480d01e0f49e2B5CFB7a3EAb',
                    [CHAIN_IDS.ETHERLINK_TESTNET]: '0xB1Ea698633d57705e93b0E40c1077d46CD6A51d8'
                },
                decimals: 18,
                icon: 'https://cryptologos.cc/logos/tezos-xtz-logo.svg?v=026',
                isNative: false,
                chains: [CHAIN_IDS.ETHERLINK_MAINNET, CHAIN_IDS.ETHERLINK_TESTNET]
            }
        };

        // Helper to get token address for current network
        function getTokenAddress(tokenSymbol) {
            const token = TOKENS[tokenSymbol];
            if (!token || token.isNative) return null;
            
            // If token has per-network addresses
            if (token.addresses && state.currentChainId) {
                return token.addresses[state.currentChainId] || null;
            }
            // Fallback to single address
            return token.address || null;
        }

        // State
        const state = {
            mode: 'create', // 'create' | 'join'
            step: 1,
            secret: null,
            secretBytes: null,
            hash: null,
            chain: 'etherlink', // 'etherlink' (From Etherlink) | 'jstz' (From Jstz)
            connectedWallet: null, // 'etherlink' | 'jstz' | null
            etherlinkWallet: null,
            etherlinkAddress: null,
            jstzAddress: null,
            provider: null,
            signer: null,
            contract: null,
            currentSwapId: null,
            selectedToken: 'XTZ', // Default token
            tokenBalances: {},
            tokenSelectorOpen: false,
            currentChainId: null, // Current network chain ID
            aliceSwapVerified: false, // Whether Alice's swap was verified in Join mode
            aliceSwapData: null, // Alice's swap data from verification
            jstzBalance: null, // Jstz balance for connected wallet
            pendingJstzVerifyHashlock: null, // Hashlock pending verification via Jstz wallet
            notifications: [], // Notification list
            jstzSwaps: [], // Swaps on Jstz
            notificationCheckInterval: null, // Interval for checking notifications
            counterpartyPollingInterval: null, // Interval for checking counterparty lock
            pendingSwapChain: null // 'etherlink' or 'jstz' - where Alice initiated
        };

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
        }
        
        function addNotification(type, title, message, swapId = null, chain = 'etherlink') {
            const notification = {
                id: Date.now(),
                type, // 'warning', 'success', 'error', 'info'
                title,
                message,
                swapId,
                chain,
                timestamp: Date.now(),
                read: false
            };
            
            state.notifications.unshift(notification);
            updateNotificationUI();
            
            // Also log to terminal
            log(`üîî ${title}: ${message}`, type === 'warning' ? 'warning' : type === 'error' ? 'error' : 'info');
        }
        
        function updateNotificationUI() {
            const badge = document.getElementById('notification-badge');
            const list = document.getElementById('notification-list');
            const unreadCount = state.notifications.filter(n => !n.read).length;
            
            // Update badge
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
            
            // Update list
            if (state.notifications.length === 0) {
                list.innerHTML = `
                    <div class="p-4 text-center text-gray-500 text-sm">
                        <i class="fa-regular fa-bell-slash text-2xl mb-2 block"></i>
                        No notifications yet
                    </div>
                `;
            } else {
                list.innerHTML = state.notifications.slice(0, 10).map(n => {
                    const timeAgo = getTimeAgo(n.timestamp);
                    const iconClass = n.type === 'warning' ? 'fa-triangle-exclamation text-yellow-400' :
                                     n.type === 'error' ? 'fa-circle-xmark text-red-400' :
                                     n.type === 'success' ? 'fa-circle-check text-green-400' :
                                     'fa-circle-info text-blue-400';
                    const bgClass = n.read ? 'bg-transparent' : 'bg-white/5';
                    const chainBadge = n.chain === 'jstz' ? 
                        '<span class="px-1.5 py-0.5 rounded text-[9px] bg-jstz-accent/20 text-jstz-accent">Jstz</span>' :
                        '<span class="px-1.5 py-0.5 rounded text-[9px] bg-ether-green/20 text-ether-green">Etherlink</span>';
                    
                    return `
                        <div class="p-3 border-b border-white/5 ${bgClass} hover:bg-white/10 transition cursor-pointer" onclick="markNotificationRead(${n.id})">
                            <div class="flex items-start gap-2">
                                <i class="fa-solid ${iconClass} mt-0.5"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-white truncate">${n.title}</span>
                                        ${chainBadge}
                                    </div>
                                    <p class="text-xs text-gray-400 line-clamp-2">${n.message}</p>
                                    <span class="text-[10px] text-gray-500 mt-1 block">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function markNotificationRead(id) {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                updateNotificationUI();
                
                // If swap notification, go to My Swaps tab
                if (notification.swapId) {
                    setTab('myswaps');
                }
            }
        }
        
        function clearAllNotifications(event) {
            event.stopPropagation();
            state.notifications = [];
            updateNotificationUI();
        }
        
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        // Check for swap alerts (expiration, claims)
        async function checkSwapAlerts() {
            const now = Math.floor(Date.now() / 1000);
            const allSwaps = [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
            
            for (const swap of allSwaps) {
                const remaining = swap.expiration - now;
                const swapKey = `${swap.chain || 'etherlink'}-${swap.hashLock || swap.swapId}`;
                
                // Alert if expiring soon (< 5 minutes) and still OPEN
                if (remaining > 0 && remaining < 300 && swap.status === 0 || swap.status === 'OPEN') {
                    const alreadyNotified = state.notifications.some(n => 
                        n.swapId === swapKey && n.type === 'warning' && n.title.includes('Expiring')
                    );
                    
                    if (!alreadyNotified) {
                        addNotification(
                            'warning',
                            '‚è∞ Swap Expiring Soon!',
                            `Your swap of ${swap.amount} XTZ expires in ${Math.floor(remaining / 60)} minutes. Take action now!`,
                            swapKey,
                            swap.chain || 'etherlink'
                        );
                    }
                }
                
                // Check if counterparty claimed (for Etherlink swaps)
                if (swap.chain !== 'jstz' && swap.status === 1 && !swap.notifiedClaimed) {
                    swap.notifiedClaimed = true;
                    addNotification(
                        'success',
                        'üéâ Swap Claimed!',
                        `The counterparty claimed the swap. Secret is now revealed - you can claim your funds!`,
                        swapKey,
                        'etherlink'
                    );
                }
            }
        }

        // Utils
        const log = (msg, type = 'info') => {
            const term = document.getElementById('terminal-body');
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString([], {hour12: false});
            
            let color = 'text-gray-300';
            if (type === 'success') color = 'text-ether-green';
            if (type === 'error') color = 'text-red-400';
            if (type === 'warning') color = 'text-yellow-400';
            if (type === 'system') color = 'text-blue-400';

            line.className = `${color} hover:bg-white/5 p-0.5 rounded`;
            line.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
            
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;
        };

        // Helper: Log transaction with explorer link
        const logTx = (txHash, message = 'Transaction') => {
            const networkConfig = NETWORK_CONFIG[state.currentChainId];
            const explorer = networkConfig?.explorer;
            if (explorer) {
                const txUrl = `${explorer}/tx/${txHash}`;
                log(`${message}: <a href="${txUrl}" target="_blank" class="text-ether-green hover:underline">${txHash.substring(0, 18)}... üîó</a>`, 'success');
            } else {
                log(`${message}: ${txHash}`, 'success');
            }
        };

        document.getElementById('login-time').innerText = new Date().toDateString();

        // Generate secret using SHA-256 for cross-chain compatibility (Etherlink + Jstz)
        function generateNewSecret() {
            // Generate 32 random bytes as secret
            const randomBytes = ethers.utils.randomBytes(32);
            const secret = ethers.utils.hexlify(randomBytes);
            
            // Hash using SHA-256 (cross-chain compatible with Solidity and Jstz)
            const hash = ethers.utils.sha256(randomBytes);
            
            state.secret = secret;
            state.secretBytes = randomBytes;
            state.hash = hash;
            
            document.getElementById('secret-input').value = secret;
            document.getElementById('hash-input').value = hash;
            
            log(`Generated new Preimage/Hash pair.`, 'system');
            log(`Hash: ${hash.substring(0, 18)}...`, 'system');
        }

        // Connect to Etherlink (EVM wallet or local)
        async function connectEtherlink() {
            try {
                console.log('[DEBUG] Starting Etherlink connection...');
                
                if (typeof window.ethereum !== 'undefined') {
                    // Use EVM wallet (MetaMask, Rabby, etc.)
                    console.log('[DEBUG] EVM wallet detected, requesting accounts...');
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    state.provider = new ethers.providers.Web3Provider(window.ethereum);
                    state.signer = state.provider.getSigner();
                    state.etherlinkAddress = await state.signer.getAddress();
                    console.log('[DEBUG] Connected address:', state.etherlinkAddress);
                    log(`EVM wallet connected: ${state.etherlinkAddress.substring(0, 6)}...${state.etherlinkAddress.slice(-4)}`, 'success');
                } else {
                    // Fallback to local Hardhat node
                    console.log('[DEBUG] No EVM wallet, falling back to local node');
                    state.provider = new ethers.providers.JsonRpcProvider(CONFIG.etherlink.rpcUrl);
                    state.signer = state.provider.getSigner(0);
                    state.etherlinkAddress = await state.signer.getAddress();
                    log(`Connected to local node: ${state.etherlinkAddress.substring(0, 6)}...${state.etherlinkAddress.slice(-4)}`, 'success');
                }
                
                // Get current chain ID
                const network = await state.provider.getNetwork();
                state.currentChainId = network.chainId;
                console.log('[DEBUG] Connected to chainId:', state.currentChainId);
                
                // Log network info
                const networkConfig = NETWORK_CONFIG[state.currentChainId];
                const networkName = networkConfig?.name || getNetworkName(state.currentChainId);
                log(`Network: ${networkName} (chainId: ${state.currentChainId})`, 'info');
                
                // Update network badge in header
                updateNetworkBadge(state.currentChainId, networkName);
                
                // Check if we're on the wrong network
                const isEtherlinkNetwork = [128123, 42793, 31337].includes(state.currentChainId);
                if (!isEtherlinkNetwork) {
                    log(`‚ö†Ô∏è Wrong network! You are on ${networkName} (chainId: ${state.currentChainId})`, 'warning');
                    log(`Click the network badge to switch to Etherlink Testnet`, 'system');
                    console.log('[DEBUG] Wrong network detected. Expected Etherlink (128123, 42793, or 31337), got:', state.currentChainId);
                }
                
                // Get HTLC contract address for this network
                const htlcAddress = networkConfig?.htlcAddress;
                if (!htlcAddress) {
                    log(`‚ö†Ô∏è HTLC contract not deployed on ${networkName}!`, 'warning');
                    log(`Deploy with: npx hardhat run scripts/deploy.js --network etherlinkTestnet`, 'system');
                    console.log('[DEBUG] No HTLC address for chainId:', state.currentChainId);
                }
                
                // Initialize contract (if address exists)
                if (htlcAddress) {
                    state.contract = new ethers.Contract(
                        htlcAddress,
                        CONFIG.etherlink.abi,
                        state.signer
                    );
                    log(`HTLC Contract: ${htlcAddress.substring(0, 10)}...`, 'success');
                    console.log('[DEBUG] Contract initialized at:', htlcAddress);
                } else {
                    state.contract = null;
                }
                
                // Fetch and log balance
                await fetchAndLogBalance();
                
                // Update UI to reflect connected wallet
                updateWalletConnectionUI('etherlink');
                
                return true;
            } catch (error) {
                console.error('[DEBUG] Connection error:', error);
                log(`Etherlink connection failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        /**
         * Update UI based on which wallet is connected
         * Disables the other wallet button and grays out incompatible options
         */
        function updateWalletConnectionUI(connectedWallet) {
            const etherlinkBtn = document.getElementById('wallet-etherlink');
            const jstzBtn = document.getElementById('wallet-jstz');
            const chainEtherlinkBtn = document.getElementById('chain-etherlink');
            const chainJstzBtn = document.getElementById('chain-jstz');
            
            if (connectedWallet === 'etherlink') {
                // Etherlink wallet connected
                state.connectedWallet = 'etherlink';
                updateRedeemChainIndicator();
                
                // Disable Jstz wallet button
                if (jstzBtn) {
                    jstzBtn.disabled = true;
                    jstzBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    jstzBtn.title = 'Disconnect Etherlink first';
                }
                
                // Gray out Jstz chain option
                if (chainJstzBtn) {
                    chainJstzBtn.classList.add('opacity-40', 'pointer-events-none');
                    chainJstzBtn.title = 'Connect Jstz wallet to use this';
                }
                if (chainEtherlinkBtn) {
                    chainEtherlinkBtn.classList.remove('opacity-40', 'pointer-events-none');
                    chainEtherlinkBtn.title = '';
                }
                
                // Auto-select Etherlink chain
                if (state.chain !== 'etherlink') {
                    setChain('etherlink');
                }
                
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
                log('üîó ETHERLINK MODE ACTIVATED (You are ALICE)', 'success');
                log('üìç Direction: Etherlink ‚Üí Jstz', 'info');
                log('', 'system');
                log('‚úÖ You can INITIATE a new swap:', 'success');
                log('   1. Click "Initiate" to generate a hash', 'system');
                log('   2. Click "Initiate Swap" to lock your XTZ', 'system');
                log('   3. Share the HASH with Bob', 'system');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
                
            } else if (connectedWallet === 'jstz') {
                // Jstz wallet connected
                state.connectedWallet = 'jstz';
                updateRedeemChainIndicator();
                
                // Disable Etherlink wallet button
                if (etherlinkBtn) {
                    etherlinkBtn.disabled = true;
                    etherlinkBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    etherlinkBtn.title = 'Disconnect Jstz first';
                }
                
                // Gray out Etherlink chain option
                if (chainEtherlinkBtn) {
                    chainEtherlinkBtn.classList.add('opacity-40', 'pointer-events-none');
                    chainEtherlinkBtn.title = 'Connect Etherlink wallet to use this';
                }
                if (chainJstzBtn) {
                    chainJstzBtn.classList.remove('opacity-40', 'pointer-events-none');
                    chainJstzBtn.title = '';
                }
                
                // Auto-select Jstz chain
                if (state.chain !== 'jstz') {
                    setChain('jstz');
                }
                
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
                log('üîó JSTZ MODE ACTIVATED (You are BOB)', 'warning');
                log('üìç Direction: Jstz ‚Üí Etherlink', 'info');
                log('', 'system');
                log('‚ö†Ô∏è IMPORTANT: To initiate a swap from Jstz:', 'warning');
                log('   Alice must have locked funds on Etherlink first!', 'info');
                log('   Use "Join" and paste Alice\'s hash.', 'system');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'system');
                
            } else {
                // No wallet connected - enable both
                state.connectedWallet = null;
                updateRedeemChainIndicator();
                
                // Re-enable both wallet buttons
                if (etherlinkBtn) {
                    etherlinkBtn.disabled = false;
                    etherlinkBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    etherlinkBtn.title = '';
                }
                if (jstzBtn) {
                    jstzBtn.disabled = false;
                    jstzBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    jstzBtn.title = '';
                }
                
                // Re-enable both chain options and reset to default (Etherlink active)
                if (chainEtherlinkBtn) {
                    chainEtherlinkBtn.classList.remove('opacity-40', 'pointer-events-none');
                    chainEtherlinkBtn.title = '';
                }
                if (chainJstzBtn) {
                    chainJstzBtn.classList.remove('opacity-40', 'pointer-events-none');
                    chainJstzBtn.title = '';
                }
                
                // Reset to default chain selection
                setChain('etherlink');
            }
        }
        
        /**
         * Disconnect wallet and reset UI
         */
        // Connect Jstz wallet programmatically
        // allowDualConnection: true to allow both wallets for polling
        async function connectJstz(allowDualConnection = true) {
            const btn = document.getElementById('wallet-jstz');
            const textEl = document.getElementById('wallet-jstz-text');
            
            // Already connected?
            if (state.jstzAddress) {
                return true;
            }
            
            // Check if other wallet is connected (skip if dual connection allowed)
            if (state.etherlinkAddress && !allowDualConnection) {
                log('‚ö†Ô∏è Disconnect Etherlink wallet first', 'warning');
                return false;
            }
            
            try {
                if (isJstzExtensionInstalled()) {
                    log('üîê Connecting to Jstz wallet extension...', 'warning');
                    
                    const addressData = await getJstzAddress();
                    console.log('[JSTZ] Address response:', addressData);
                    
                    // Handle different response formats
                    if (typeof addressData === 'string') {
                        state.jstzAddress = addressData;
                    } else if (addressData && typeof addressData === 'object') {
                        state.jstzAddress = addressData.address || addressData.accountAddress || addressData.data?.address || JSON.stringify(addressData);
                    } else {
                        throw new Error('Invalid address response from wallet');
                    }
                    
                    // Safely create short address
                    const addr = String(state.jstzAddress);
                    const shortAddr = addr.length > 10 ? `${addr.substring(0, 6)}...${addr.slice(-3)}` : addr;
                    if (textEl) textEl.innerText = shortAddr;
                    if (btn) btn.classList.add('border-jstz-accent', 'text-jstz-accent', 'bg-jstz-accent/10');
                    
                    log(`Connected to Jstz: ${addr.substring(0, 12)}...`, 'success');
                    
                    // Fetch Jstz balance
                    fetchJstzBalance();
                    
                    // If Etherlink is also connected, we're in dual mode (for polling)
                    if (state.etherlinkAddress) {
                        log('‚úÖ Dual wallet mode: Both Etherlink & Jstz connected!', 'success');
                        // Don't change the main connected wallet, just add Jstz for reading
                    } else {
                        // Update network badge for Jstz
                        const networkName = CONFIG.jstz.network === 'privatenet' ? 'Jstz Privatenet' : 'Jstz Sandbox';
                        updateNetworkBadge(`jstz-${CONFIG.jstz.network}`, networkName);
                        
                        // Update UI
                        updateWalletConnectionUI('jstz');
                    }
                    
                    return true;
                } else {
                    log('‚ùå Jstz wallet extension not detected', 'error');
                    log('Install from: https://github.com/jstz-dev/dev-wallet/releases', 'info');
                    return false;
                }
            } catch (error) {
                console.error('[JSTZ] Connection error:', error);
                log(`‚ùå Failed to connect Jstz wallet: ${error.message}`, 'error');
                return false;
            }
        }
        
        function disconnectWallet() {
            state.etherlinkAddress = null;
            state.jstzAddress = null;
            state.provider = null;
            state.signer = null;
            state.contract = null;
            state.connectedWallet = null;
            updateRedeemChainIndicator();
            
            // Reset Etherlink button
            const etherlinkBtn = document.getElementById('wallet-etherlink');
            const etherlinkText = document.getElementById('wallet-etherlink-text');
            const balanceSpan = document.getElementById('wallet-balance');
            if (etherlinkBtn) {
                etherlinkText.textContent = 'Connect Etherlink';
                balanceSpan.classList.add('hidden');
            }
            
            // Reset Jstz button
            const jstzBtn = document.getElementById('wallet-jstz');
            const jstzText = document.getElementById('wallet-jstz-text');
            if (jstzBtn && jstzText) {
                jstzText.textContent = 'Connect Jstz';
            }
            
            // Re-enable both wallet buttons
            updateWalletConnectionUI(null);
            
            log('Wallet disconnected', 'info');
        }
        
        // Update the network badge in header
        function updateNetworkBadge(chainId, networkName) {
            const badge = document.getElementById('network-badge');
            const dot = document.getElementById('network-dot');
            const name = document.getElementById('network-name');
            
            if (!badge || !dot || !name) return;
            
            name.textContent = networkName;
            
            // Color based on network
            if (chainId === 'jstz-privatenet') {
                // Jstz Privatenet - Gold/Yellow (Jstz brand color)
                dot.className = 'w-2 h-2 rounded-full bg-jstz-accent animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-jstz-accent/50 cursor-default';
                name.className = 'text-xs text-jstz-accent';
                badge.onclick = null;
                badge.title = 'Connected to Jstz Privatenet';
            } else if (chainId === 'jstz-sandbox') {
                // Jstz Sandbox - Orange
                dot.className = 'w-2 h-2 rounded-full bg-orange-500 animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-orange-500/50 cursor-default';
                name.className = 'text-xs text-orange-400';
                badge.onclick = null;
                badge.title = 'Connected to Jstz Sandbox';
            } else if (chainId === 128123) {
                // Etherlink Testnet - Green (correct network)
                dot.className = 'w-2 h-2 rounded-full bg-ether-green animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-ether-green/50 cursor-pointer hover:border-ether-green transition';
                name.className = 'text-xs text-ether-green';
                badge.onclick = () => switchToEtherlink(128123);
                badge.title = 'Connected to Etherlink Testnet';
            } else if (chainId === 42793) {
                // Etherlink Mainnet - Blue
                dot.className = 'w-2 h-2 rounded-full bg-blue-500 animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-blue-500/50 cursor-pointer hover:border-blue-500 transition';
                name.className = 'text-xs text-blue-400';
                badge.onclick = () => switchToEtherlink(42793);
                badge.title = 'Connected to Etherlink Mainnet';
            } else if (chainId === 31337) {
                // Hardhat Local - Yellow
                dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-yellow-500/50 cursor-pointer hover:border-yellow-500 transition';
                name.className = 'text-xs text-yellow-400';
                badge.onclick = () => switchToEtherlink(31337);
                badge.title = 'Connected to Hardhat Local';
            } else if (chainId === null || chainId === 0) {
                // Not connected
                dot.className = 'w-2 h-2 rounded-full bg-gray-500';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-ether-dark border border-white/10 cursor-pointer hover:border-ether-green/50 transition';
                name.className = 'text-xs text-gray-400';
                badge.onclick = () => switchToEtherlink(128123);
                badge.title = 'Click to connect';
            } else {
                // Wrong network - Red with prominent "click to switch" indicator
                dot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/20 border-2 border-red-500 cursor-pointer hover:bg-red-500/30 transition animate-pulse';
                name.className = 'text-xs text-red-400 font-bold';
                name.innerHTML = `${networkName} <span class="ml-1 text-[10px] bg-red-500 text-white px-1 rounded">‚ö†Ô∏è CLICK TO SWITCH</span>`;
                badge.onclick = () => switchToEtherlink(128123);
                badge.title = 'Click to switch to Etherlink Testnet';
                
                // Log warning message
                log(`‚ö†Ô∏è Wrong network detected! Click the red badge to switch to Etherlink Testnet`, 'error');
            }
        }
        
        // Fetch and log balance with debug info
        async function fetchAndLogBalance() {
            if (!state.provider || !state.etherlinkAddress) {
                console.log('[DEBUG] Cannot fetch balance - provider or address missing');
                return;
            }
            
            try {
                console.log('[DEBUG] Fetching native balance for:', state.etherlinkAddress);
                const balance = await state.provider.getBalance(state.etherlinkAddress);
                const balanceEth = ethers.utils.formatEther(balance);
                console.log('[DEBUG] Native balance (wei):', balance.toString());
                console.log('[DEBUG] Native balance (XTZ):', balanceEth);
                log(`Balance: ${parseFloat(balanceEth).toFixed(4)} XTZ`, 'info');
                
                // Update balance display
                const balanceDisplay = document.querySelector('.text-gray-500');
                if (balanceDisplay && balanceDisplay.textContent.includes('Balance:')) {
                    balanceDisplay.textContent = `Balance: ${parseFloat(balanceEth).toFixed(4)} XTZ`;
                }
            } catch (error) {
                console.error('[DEBUG] Error fetching balance:', error);
                log(`Error fetching balance: ${error.message}`, 'error');
            }
        }

        // Add Etherlink network to EVM wallet
        async function addEtherlinkToMetaMask(chainId = 128123) {
            if (typeof window.ethereum === 'undefined') {
                log('EVM wallet not detected', 'error');
                return false;
            }
            
            const networkConfig = NETWORK_CONFIG[chainId];
            if (!networkConfig) {
                log('Unknown network', 'error');
                return false;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x' + chainId.toString(16),
                        chainName: networkConfig.name,
                        nativeCurrency: {
                            name: 'Tezos',
                            symbol: 'XTZ',
                            decimals: 18
                        },
                        rpcUrls: [networkConfig.rpcUrl],
                        blockExplorerUrls: networkConfig.explorer ? [networkConfig.explorer] : null
                    }]
                });
                log(`${networkConfig.name} added to wallet!`, 'success');
                return true;
            } catch (error) {
                log(`Failed to add network: ${error.message}`, 'error');
                return false;
            }
        }

        // Switch EVM wallet to Etherlink network
        async function switchToEtherlink(chainId = 128123) {
            if (typeof window.ethereum === 'undefined') return false;
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x' + chainId.toString(16) }]
                });
                return true;
            } catch (error) {
                // Chain not added, try to add it
                if (error.code === 4902) {
                    return await addEtherlinkToMetaMask(chainId);
                }
                log(`Failed to switch network: ${error.message}`, 'error');
                return false;
            }
        }

        // Get human-readable network name
        function getNetworkName(chainId) {
            switch (chainId) {
                case CHAIN_IDS.HARDHAT_LOCAL: return 'Hardhat Local';
                case CHAIN_IDS.ETHERLINK_MAINNET: return 'Etherlink Mainnet';
                case CHAIN_IDS.ETHERLINK_TESTNET: return 'Etherlink Testnet';
                default: return `Unknown (${chainId})`;
            }
        }

        // Check if token is available on current network
        function isTokenAvailable(tokenSymbol) {
            const token = TOKENS[tokenSymbol];
            if (!token) {
                console.log(`[DEBUG] Token ${tokenSymbol} not found in TOKENS`);
                return false;
            }
            if (!state.currentChainId) {
                console.log(`[DEBUG] No chainId set, defaulting to native only for ${tokenSymbol}`);
                return token.isNative;
            }
            const available = token.chains.includes(state.currentChainId);
            console.log(`[DEBUG] Token ${tokenSymbol}: chainId=${state.currentChainId}, supportedChains=[${token.chains.join(',')}], available=${available}`);
            return available;
        }

        // Get available tokens for current network
        function getAvailableTokens() {
            return Object.entries(TOKENS)
                .filter(([symbol, token]) => isTokenAvailable(symbol))
                .reduce((acc, [symbol, token]) => {
                    acc[symbol] = token;
                    return acc;
                }, {});
        }

        // Jstz API calls
        /**
         * Jstz Request Handler
         * Uses Jstz wallet extension if available, otherwise shows CLI commands
         */
        const encoder = new TextEncoder();
        const decoder = new TextDecoder('utf-8');
        
        // Read-only request to Jstz (no signature needed)
        async function jstzReadOnly(path) {
            const contractAddress = CONFIG.jstz.contractAddress;
            const rpcUrl = CONFIG.jstz.rpcUrl;
            
            console.log(`[JSTZ] Read-only: ${path}`);
            
            try {
                // Try direct HTTP call to the smart function endpoint
                // Jstz allows reading state without signing
                const response = await fetch(`${rpcUrl}/smart_functions/${contractAddress}/state${path}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('[JSTZ] Direct read failed, trying alternative...');
            }
            
            // Fallback: return null to indicate we need CLI
            return null;
        }
        
        /**
         * Make a request to Jstz smart function
         * @param method - HTTP method
         * @param path - Endpoint path (e.g., /initiate, /claim, /refund)
         * @param body - Request body object
         * @param options - Additional options:
         *   - requiresSignature: Whether to require wallet signature (default: true)
         *   - transferAmountMutez: Amount of tez to send in mutez (1 XTZ = 1,000,000 mutez)
         *   - forceWallet: Force using wallet even for read operations (default: false)
         */
        async function jstzRequest(method, path, body = null, options = {}) {
            const { requiresSignature = true, transferAmountMutez = 0, forceWallet = false, silent = false } = typeof options === 'boolean' 
                ? { requiresSignature: options } 
                : options;
            
            const contractAddress = CONFIG.jstz.contractAddress;
            const rpcUrl = CONFIG.jstz.rpcUrl;
            
            if (!silent) {
                log(`üì§ Jstz: ${method} ${path}`, 'system');
                if (transferAmountMutez > 0) {
                    log(`üí∞ Sending ${transferAmountMutez} mutez (${transferAmountMutez / 1000000} XTZ)`, 'warning');
                }
            }
            
            // For read operations, try without signature first (unless forceWallet is true)
            if (!forceWallet && (!requiresSignature || path.startsWith('/swap/') || path === '/swaps')) {
                log(`üìñ Attempting read-only request...`, 'system');
                // For reads, we'll just return null and let the UI handle it
                // The user will need to check via CLI
                const cliCmd = `jstz run "jstz://${contractAddress}${path}" -n privatenet -m POST -d '{}'`;
                console.log('[JSTZ] Read CLI command:', cliCmd);
                
                // Return a "not found" response for verification - we can't read without executing
                // The user should verify via CLI or trust the process
                return { error: 'READ_ONLY_NOT_SUPPORTED', cliCommand: cliCmd };
            }
            
            // Check if extension is available
            const hasExtension = isJstzExtensionInstalled();
            
            if (!hasExtension) {
                // No extension - show CLI command with transfer if needed
                let cliCmd = `jstz run "jstz://${contractAddress}${path}" -n privatenet -m POST -d '${JSON.stringify(body || {})}'`;
                if (transferAmountMutez > 0) {
                    // Note: CLI transfer syntax may vary - check jstz docs
                    cliCmd = `jstz run "jstz://${contractAddress}${path}" -n privatenet -m POST -d '${JSON.stringify(body || {})}' --transfer ${transferAmountMutez}`;
                }
                
                if (!silent) {
                    log(`‚ö†Ô∏è Jstz wallet extension not detected`, 'warning');
                    // Show popup only for non-silent requests (important operations)
                    showCLIModal(cliCmd, 'Jstz wallet extension not available. Run this command to complete the transaction:');
                }
                
                return { success: false, cliRequired: true, cliCommand: cliCmd };
            }
            
            // Extension available - use it!
            try {
                if (!silent) log(`üîê Requesting signature from Jstz wallet...`, 'warning');
                
                // Build the operation - body must be base64 encoded as per Jstz docs
                const bodyJson = body ? JSON.stringify(body) : '';
                
                // Convert to base64 (handles UTF-8 properly)
                const toBase64 = (str) => {
                    if (!str) return '';
                    // Encode UTF-8 string to base64
                    const bytes = encoder.encode(str);
                    let binary = '';
                    for (let i = 0; i < bytes.length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return btoa(binary);
                };
                
                const bodyBase64 = bodyJson ? toBase64(bodyJson) : '';
                
                // Build headers - include X-JSTZ-TRANSFER if sending tez
                const operationHeaders = {};
                if (transferAmountMutez > 0) {
                    operationHeaders['X-JSTZ-TRANSFER'] = transferAmountMutez.toString();
                    console.log('[JSTZ] Adding transfer header:', transferAmountMutez, 'mutez');
                }
                
                const operation = {
                    _type: 'RunFunction',
                    uri: `jstz://${contractAddress}${path}`,
                    method: 'POST',
                    headers: operationHeaders,
                    body: bodyBase64, // Base64 encoded string as per Jstz engineer
                    gasLimit: 100000
                };
                
                console.log('[JSTZ] Body JSON:', bodyJson);
                console.log('[JSTZ] Body base64:', bodyBase64);
                
                console.log('[JSTZ] Operation to sign:', operation);
                
                // Request signature from extension
                const signResponse = await requestJstzSignature(operation);
                
                if (!silent) log(`‚úÖ Signature received from ${signResponse.accountAddress.substring(0, 10)}...`, 'success');
                console.log('[JSTZ] Sign response:', signResponse);
                
                // Inject the signed operation using Jstz SDK (as per documentation)
                log(`üì° Injecting operation to Jstz privatenet...`, 'warning');
                
                const { operation: signedOperation, signature, accountAddress } = signResponse;
                console.log(`[JSTZ] Operation signed by: ${accountAddress}`);
                
                // Use the Jstz client SDK for injection
                if (window.JstzClient) {
                    const jstzClient = new window.JstzClient({
                        baseURL: rpcUrl,
                        timeout: 10000
                    });
                    
                    console.log('[JSTZ] Using SDK for injection, operation:', signedOperation);
                    
                    try {
                        const injectionResult = await jstzClient.operations.injectAndPoll({
                            inner: signedOperation,
                            signature: signature
                        });
                        
                        console.log('[JSTZ] SDK injection full result:', injectionResult);
                        
                        const { result: { inner }, hash } = injectionResult;
                        
                        console.log('[JSTZ] SDK injection result inner:', inner);
                        console.log('[JSTZ] Operation hash:', hash);
                        
                        // Check HTTP status code from contract response
                        const statusCode = inner?.statusCode || 200;
                        console.log('[JSTZ] Response status code:', statusCode);
                        
                        // Parse response body (body is base64 encoded)
                        let returnedMessage = 'Success';
                        if (typeof inner === 'object' && inner && 'body' in inner && inner.body) {
                            try {
                                // Decode base64 to string
                                const bodyString = atob(inner.body);
                                console.log('[JSTZ] Body string:', bodyString);
                                returnedMessage = JSON.parse(bodyString);
                            } catch (e) {
                                console.error('[JSTZ] Parse error:', e);
                                // Try as Uint8Array if base64 decode fails
                                try {
                                    returnedMessage = inner.body ? JSON.parse(decoder.decode(new Uint8Array(inner.body))) : 'No body';
                                } catch (e2) {
                                    returnedMessage = { raw: inner.body };
                                }
                            }
                        } else if (typeof inner === 'string') {
                            returnedMessage = inner;
                        }
                        
                        // Check for contract-level errors (status 400+)
                        if (statusCode >= 400) {
                            const errorMsg = returnedMessage?.error || returnedMessage?.message || `Contract error (${statusCode})`;
                            console.error('[JSTZ] Contract returned error:', errorMsg);
                            if (!silent) log(`‚ùå Contract error: ${errorMsg}`, 'error');
                            return { success: false, error: errorMsg, statusCode, message: returnedMessage };
                        }
                        
                        // Also check for success: false in response body
                        if (returnedMessage && returnedMessage.success === false) {
                            const errorMsg = returnedMessage.error || 'Operation failed';
                            console.error('[JSTZ] Contract returned success: false:', errorMsg);
                            if (!silent) log(`‚ùå ${errorMsg}`, 'error');
                            return { success: false, error: errorMsg, message: returnedMessage };
                        }
                        
                        // Build operation URL for dashboard
                        // Hash is returned as byte array, convert to hex
                        let operationHash = null;
                        if (hash && Array.isArray(hash)) {
                            operationHash = '0x' + hash.map(b => b.toString(16).padStart(2, '0')).join('');
                            console.log('[JSTZ] Operation hash (hex):', operationHash);
                        }
                        
                        // The dashboard uses msg_X_Y format, try to find it
                        let operationId = injectionResult.operationId || injectionResult.id || injectionResult.messageId;
                        let operationUrl = null;
                        
                        // Log full result to find the ID format
                        console.log('[JSTZ] Looking for operation ID:', {
                            operationId,
                            hash: operationHash,
                            keys: Object.keys(injectionResult)
                        });
                        
                        log(`‚úÖ Jstz operation successful!`, 'success');
                        
                        if (operationId && typeof operationId === 'string' && operationId.startsWith('msg_')) {
                            operationUrl = `https://privatenet.dashboard.jstz.info/operations/${operationId}?tab=response`;
                            log(`<a href="${operationUrl}" target="_blank" class="text-jstz-accent hover:underline">üìã View on Dashboard: ${operationId}</a>`, 'info');
                        } else if (operationHash) {
                            // Link to dashboard with hash (may not work but better than nothing)
                            log(`üîó Operation hash: <code class="text-xs bg-black/50 px-1 rounded">${operationHash.substring(0, 18)}...</code>`, 'info');
                            log(`<a href="https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}" target="_blank" class="text-jstz-accent hover:underline">üìã View Contract on Dashboard</a>`, 'info');
                        }
                        
                        console.log('[JSTZ] Parsed response:', returnedMessage);
                        return { success: true, message: returnedMessage, operationId, operationUrl };
                        
                    } catch (sdkError) {
                        console.error('[JSTZ] SDK injection error:', sdkError);
                        throw sdkError;
                    }
                }
                
                // Fallback to direct fetch if SDK not loaded
                console.log('[JSTZ] SDK not available, using direct fetch');
                log(`‚ö†Ô∏è Jstz SDK not loaded, trying direct injection...`, 'warning');
                
                const injectResponse = await fetch(`${rpcUrl}/operations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inner: signedOperation,
                        signature: signature
                    })
                });
                
                if (!injectResponse.ok) {
                    const errorText = await injectResponse.text();
                    throw new Error(`Injection failed: ${errorText}`);
                }
                
                const result = await injectResponse.json();
                console.log('[JSTZ] Injection result:', result);
                
                // Parse response body if present
                let parsedResult = result;
                if (result.result?.inner?.body) {
                    try {
                        const bodyBytes = new Uint8Array(result.result.inner.body);
                        parsedResult = JSON.parse(decoder.decode(bodyBytes));
                    } catch (e) {
                        // Keep original result
                    }
                }
                
                log(`‚úÖ Jstz operation successful!`, 'success');
                return parsedResult;
                
            } catch (error) {
                console.error('[JSTZ] Extension error:', error);
                log(`‚ùå Jstz wallet error: ${error.message}`, 'error');
                
                // Offer CLI command as fallback (discreet button, not auto-popup)
                const cliCmd = `jstz run "jstz://${contractAddress}${path}" -n privatenet -m POST -d '${JSON.stringify(body || {})}'`;
                
                if (!silent) {
                    const actionName = path.includes('initiate') ? 'initiate the swap' : path.includes('claim') ? 'claim the swap' : path.includes('refund') ? 'refund the swap' : 'execute the operation';
                    log(`‚ö†Ô∏è Jstz wallet operation failed`, 'warning');
                    offerCliCommand(cliCmd, `The Jstz wallet extension failed. Run this command to ${actionName}:`);
                } else {
                    console.log('[JSTZ SILENT] Operation failed, CLI available:', cliCmd);
                }
                
                // Return a special object indicating CLI fallback
                return { 
                    success: false, 
                    cliRequired: true, 
                    cliCommand: cliCmd,
                    error: error.message 
                };
            }
        }
        
        // ============================================
        // COUNTERPARTY POLLING SYSTEM
        // ============================================
        
        // Start polling to check if counterparty has locked funds
        function startCounterpartyPolling(hashlock, initiatedOn) {
            // Stop any existing polling
            stopCounterpartyPolling();
            
            state.pendingSwapChain = initiatedOn;
            const targetChain = initiatedOn === 'etherlink' ? 'jstz' : 'etherlink';
            
            log(`üëÄ Watching for counterparty on ${targetChain}...`, 'system');
            
            // For Jstz: manual check only (requires wallet signature each time)
            // For Etherlink: auto-polling (free read)
            if (targetChain === 'jstz') {
                // Show manual check button for Jstz
                showManualCheckButton(hashlock, targetChain, 'counterparty');
            } else {
                // Auto-poll for Etherlink
                checkCounterpartySwap(hashlock, targetChain);
                state.counterpartyPollingInterval = setInterval(() => {
                    checkCounterpartySwap(hashlock, targetChain);
                }, 10000);
            }
        }
        
        function stopCounterpartyPolling() {
            if (state.counterpartyPollingInterval) {
                clearInterval(state.counterpartyPollingInterval);
                state.counterpartyPollingInterval = null;
            }
        }
        
        // Start polling to check if Alice has revealed the secret (for Bob)
        function startSecretPolling(hashlock, aliceChain) {
            // Stop any existing polling
            stopCounterpartyPolling();
            
            log(`üîë Watching for secret revelation...`, 'system');
            
            // aliceChain is where Alice initiated - we need to check where Bob locked
            // If Alice initiated on Etherlink, Bob locked on Jstz - Alice will claim on Jstz (we check Jstz)
            // If Alice initiated on Jstz, Bob locked on Etherlink - Alice will claim on Etherlink (we check Etherlink)
            const chainToCheck = aliceChain === 'etherlink' ? 'jstz' : 'etherlink';
            
            console.log('[SECRET POLLING] Starting - aliceChain:', aliceChain, 'chainToCheck:', chainToCheck);
            log(`üì° Monitoring ${chainToCheck.toUpperCase()} for secret...`, 'info');
            
            // For Jstz: manual check only (requires wallet signature each time)
            // For Etherlink: auto-polling (free read)
            if (chainToCheck === 'jstz') {
                // Show manual check button for Jstz
                showManualCheckButton(hashlock, chainToCheck, 'secret');
            } else {
                // Auto-poll for Etherlink (free read-only)
                console.log('[SECRET POLLING] Starting Etherlink auto-poll every 10s');
                checkSecretRevealed(hashlock, aliceChain);
                state.counterpartyPollingInterval = setInterval(() => {
                    console.log('[SECRET POLLING] Polling tick...');
                    checkSecretRevealed(hashlock, aliceChain);
                }, 10000);
            }
        }
        
        // Show a manual "Check Status" button for Jstz (avoids signature spam)
        function showManualCheckButton(hashlock, chain, checkType) {
            const btn = document.getElementById('main-action-btn');
            
            if (checkType === 'counterparty') {
                btn.innerHTML = `<span>üîÑ Check Jstz for Counterparty</span><i class="fa-solid fa-search"></i>`;
                btn.className = 'w-full py-4 rounded-xl bg-gradient-to-r from-jstz-accent to-yellow-400 hover:brightness-110 font-bold text-lg text-black shadow-lg shadow-jstz-accent/25 transition-all duration-300 flex items-center justify-center gap-2';
                btn.disabled = false;
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.innerHTML = `<span>üîç Checking...</span><i class="fa-solid fa-spinner fa-spin"></i>`;
                    await checkCounterpartySwap(hashlock, chain);
                    // If not found, restore the button
                    if (btn.innerHTML.includes('Checking')) {
                        btn.disabled = false;
                        btn.innerHTML = `<span>üîÑ Check Jstz for Counterparty</span><i class="fa-solid fa-search"></i>`;
                    }
                };
                log(`üí° Click the button to check if counterparty locked on Jstz`, 'info');
            } else if (checkType === 'secret') {
                btn.innerHTML = `<span>üîÑ Check Jstz for Secret</span><i class="fa-solid fa-key"></i>`;
                btn.className = 'w-full py-4 rounded-xl bg-gradient-to-r from-jstz-accent to-yellow-400 hover:brightness-110 font-bold text-lg text-black shadow-lg shadow-jstz-accent/25 transition-all duration-300 flex items-center justify-center gap-2';
                btn.disabled = false;
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.innerHTML = `<span>üîç Checking...</span><i class="fa-solid fa-spinner fa-spin"></i>`;
                    // For secret, we need to check where Alice will claim
                    // aliceChain (passed as chain here) is opposite
                    const aliceChain = chain === 'jstz' ? 'etherlink' : 'jstz';
                    await checkSecretRevealed(hashlock, aliceChain);
                    // If not found, restore the button
                    if (btn.innerHTML.includes('Checking')) {
                        btn.disabled = false;
                        btn.innerHTML = `<span>üîÑ Check Jstz for Secret</span><i class="fa-solid fa-key"></i>`;
                    }
                };
                log(`üí° Click the button to check if secret was revealed on Jstz`, 'info');
            }
        }
        
        async function checkSecretRevealed(hashlock, aliceChain) {
            const btn = document.getElementById('main-action-btn');
            
            try {
                if (aliceChain === 'etherlink') {
                    // Alice locked on Etherlink, check if she claimed on Jstz
                    console.log('[SECRET CHECK] Checking Jstz for claimed swap:', hashlock.substring(0, 20) + '...');
                    
                    // User clicked manually, so wallet should be connected
                    if (!isJstzExtensionInstalled()) {
                        log(`‚ùå Jstz wallet extension not detected`, 'error');
                        return;
                    }
                    
                    log(`üîç Checking swap status on Jstz...`, 'system');
                    const result = await jstzRequest('POST', `/swap/${hashlock}`, {}, { forceWallet: true });
                    console.log('[SECRET POLLING] Jstz result:', result);
                    
                    if (!result.success) return;
                    
                    // Parse response
                    let swapData = result.message?.found !== undefined ? result.message : 
                                   result.message?.swap ? { found: true, swap: result.message.swap } : null;
                    
                    if (swapData?.found && swapData?.swap?.status === 'CLAIMED') {
                        // Secret revealed!
                        stopCounterpartyPolling();
                        const swap = swapData.swap;
                        const secret = swap.revealedSecret;
                        
                        if (secret) {
                            log(`üîë SECRET REVEALED: ${secret.substring(0, 20)}...`, 'success');
                            addNotification('success', 'üîë Secret Revealed!', 'Alice claimed - you can now claim on Etherlink!', hashlock, 'etherlink');
                            
                            // Store secret
                            state.secret = secret;
                            
                            // Pre-fill redeem form
                            prefillRedeemForm(hashlock, secret);
                            
                            // Transform button
                            btn.disabled = false;
                            btn.className = btn.className.replace('bg-gradient-to-r from-ether-green to-green-400', 'bg-gradient-to-r from-yellow-500 to-orange-500 animate-pulse');
                            btn.innerHTML = `<span>üîë Secret Revealed! Claim on Etherlink!</span><i class="fa-solid fa-gift"></i>`;
                            btn.onclick = () => {
                                switchTab('redeem');
                                log("üìã Claim form pre-filled with revealed secret!", 'success');
                            };
                            
                            updateProgress(4);
                            
                            // Show popup notification
                            showSecretRevealedModal(secret, hashlock, 'etherlink');
                        }
                    } else if (swapData?.found && swapData?.swap?.status === 'OPEN') {
                        // Swap still open, secret not revealed yet
                        log(`‚è≥ Swap still OPEN - secret not revealed yet. Try again later.`, 'warning');
                    } else {
                        log(`‚è≥ Swap not found or not claimed yet. Try again later.`, 'warning');
                    }
                } else {
                    // Alice locked on Jstz, check if she claimed on Etherlink (via events)
                    console.log('[SECRET POLLING] Checking Etherlink for claimed swap:', hashlock.substring(0, 20) + '...');
                    
                    // Use Ghostnet config for Etherlink
                    const networkConfig = NETWORK_CONFIG[128123]; // Etherlink Ghostnet
                    const rpcUrl = networkConfig?.rpcUrl || 'https://node.ghostnet.etherlink.com';
                    const htlcAddress = networkConfig?.htlcAddress || CONFIG.etherlink.contractAddress;
                    
                    console.log('[SECRET POLLING] Using RPC:', rpcUrl);
                    console.log('[SECRET POLLING] HTLC address:', htlcAddress);
                    
                    const readOnlyProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    const readOnlyContract = new ethers.Contract(htlcAddress, CONFIG.etherlink.abi, readOnlyProvider);
                    
                    const swap = await readOnlyContract.getSwap(hashlock);
                    console.log('[SECRET POLLING] Etherlink swap status:', swap.status, '(0=OPEN, 1=CLAIMED, 2=REFUNDED)');
                    
                    if (swap.status === 0) {
                        // Still OPEN - not claimed yet
                        log(`‚è≥ Etherlink swap still OPEN - checking every 10s...`, 'warning');
                    } else if (swap.status === 1) { // CLAIMED
                        // Need to get secret from events
                        console.log('[SECRET POLLING] Swap CLAIMED! Looking for secret in events...');
                        const filter = readOnlyContract.filters.SwapClaimed(hashlock);
                        const events = await readOnlyContract.queryFilter(filter);
                        console.log('[SECRET POLLING] Found', events.length, 'SwapClaimed events');
                        
                        if (events.length > 0) {
                            stopCounterpartyPolling();
                            const secret = events[0].args.secret;
                            const secretHex = '0x' + Array.from(secret).map(b => b.toString(16).padStart(2, '0')).join('');
                            
                            log(`üîë SECRET REVEALED: ${secretHex.substring(0, 20)}...`, 'success');
                            addNotification('success', 'üîë Secret Revealed!', 'Alice claimed - you can now claim on Jstz!', hashlock, 'jstz');
                            
                            // Store secret
                            state.secret = secretHex;
                            
                            // Pre-fill redeem form
                            prefillRedeemForm(hashlock, secretHex);
                            
                            // Transform button
                            btn.disabled = false;
                            btn.className = btn.className.replace('bg-gradient-to-r from-ether-green to-green-400', 'bg-gradient-to-r from-yellow-500 to-orange-500 animate-pulse');
                            btn.innerHTML = `<span>üîë Secret Revealed! Claim on Jstz!</span><i class="fa-solid fa-gift"></i>`;
                            btn.onclick = () => {
                                switchTab('redeem');
                                log("üìã Claim form pre-filled with revealed secret!", 'success');
                            };
                            
                            updateProgress(4);
                            
                            // Show popup notification
                            showSecretRevealedModal(secretHex, hashlock, 'jstz');
                        }
                    } else if (swap.status === 2) {
                        // REFUNDED - swap expired
                        stopCounterpartyPolling();
                        log(`‚ùå Swap was REFUNDED (expired) - secret not available`, 'error');
                    }
                }
            } catch (error) {
                console.log('[SECRET POLLING] Check failed (will retry):', error.message);
            }
        }
        
        // Show modal when secret is revealed
        function showSecretRevealedModal(secret, hashlock, claimChain) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'secret-revealed-modal';
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-yellow-500/50 rounded-2xl p-6 max-w-md mx-4 shadow-2xl animate-pulse-once">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-key text-3xl text-yellow-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">üîë Secret Revealed!</h3>
                        <p class="text-gray-400 text-sm">Alice has claimed her funds. Use this secret to claim yours on ${claimChain === 'etherlink' ? 'Etherlink' : 'Jstz'}!</p>
                    </div>
                    
                    <div class="bg-slate-900/50 rounded-xl p-4 mb-4">
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Secret (Copy this!)</label>
                        <div class="flex items-center gap-2">
                            <code class="text-xs text-yellow-400 font-mono break-all flex-1">${secret}</code>
                            <button onclick="navigator.clipboard.writeText('${secret}'); this.innerHTML='<i class=\\'fa-solid fa-check\\'></i>'" class="p-2 rounded bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('secret-revealed-modal').remove()" class="flex-1 py-3 rounded-xl bg-slate-700 text-white font-semibold hover:bg-slate-600 transition">
                            Close
                        </button>
                        <button onclick="document.getElementById('secret-revealed-modal').remove(); switchTab('redeem');" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-bold hover:opacity-90 transition">
                            <i class="fa-solid fa-gift mr-2"></i>Claim Now!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Play notification sound (optional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleS8AHpWtu9H8yI0lAC+fwr/Y/OK4TAAV');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
        }
        
        async function checkCounterpartySwap(hashlock, targetChain) {
            const btn = document.getElementById('main-action-btn');
            
            try {
                if (targetChain === 'jstz') {
                    // Check if swap exists on Jstz (manual button click)
                    console.log('[CHECK] Checking Jstz for swap:', hashlock.substring(0, 20) + '...');
                    
                    // User clicked manually, wallet should be connected
                    if (!isJstzExtensionInstalled()) {
                        log(`‚ùå Jstz wallet extension not detected`, 'error');
                        return;
                    }
                    
                    log(`üîç Checking swap status on Jstz...`, 'system');
                    const walletResult = await jstzRequest('POST', `/swap/${hashlock}`, {}, { forceWallet: true });
                    console.log('[POLLING] Jstz result:', walletResult);
                    
                    if (!walletResult.success) {
                        console.log('[POLLING] Jstz request failed');
                        return;
                    }
                    
                    // Parse the response - could be in message or directly
                    let swapData = null;
                    if (walletResult.message?.found !== undefined) {
                        swapData = walletResult.message;
                    } else if (typeof walletResult.message === 'object' && walletResult.message?.swap) {
                        swapData = { found: true, swap: walletResult.message.swap };
                    }
                    
                    if (swapData?.found && swapData?.swap?.status === 'OPEN') {
                        // Counterparty has locked!
                        stopCounterpartyPolling();
                        const swap = swapData.swap;
                        
                        log(`üéâ Counterparty locked ${swap.amountXtz} XTZ on Jstz!`, 'success');
                        addNotification('success', 'Counterparty Locked!', `${swap.amountXtz} XTZ locked on Jstz - Ready to claim!`, hashlock, 'jstz');
                        
                        // Transform button to "Claim Now"
                        btn.disabled = false;
                        btn.className = btn.className.replace('bg-gradient-to-r from-ether-green to-green-400', 'bg-gradient-to-r from-yellow-500 to-orange-500 animate-pulse');
                        btn.innerHTML = `<span>üéâ Claim ${swap.amountXtz} XTZ on Jstz!</span><i class="fa-solid fa-gift"></i>`;
                        btn.onclick = () => {
                            // Switch to Redeem tab and auto-fill
                            switchTab('redeem');
                            document.getElementById('swap-id-input').value = hashlock;
                            document.getElementById('secret-input-claim').value = state.secret;
                            log("üìã Claim form pre-filled. Click 'Claim Funds' to complete!", 'success');
                        };
                        
                        updateProgress(4);
                    } else {
                        // Swap not found yet
                        log(`‚è≥ Counterparty hasn't locked yet. Try again later.`, 'warning');
                    }
                } else {
                    // Check if swap exists on Etherlink
                    const rpcUrl = NETWORK_CONFIG[128123].rpcUrl;
                    const htlcAddress = NETWORK_CONFIG[128123].htlcAddress;
                    
                    const readOnlyProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    const readOnlyContract = new ethers.Contract(htlcAddress, CONFIG.etherlink.abi, readOnlyProvider);
                    
                    const swap = await readOnlyContract.getSwap(hashlock);
                    
                    if (swap.sender !== ethers.constants.AddressZero && swap.status === 0) {
                        // Counterparty has locked!
                        stopCounterpartyPolling();
                        const amountEth = ethers.utils.formatEther(swap.amount);
                        
                        log(`üéâ Counterparty locked ${amountEth} XTZ on Etherlink!`, 'success');
                        addNotification('success', 'Counterparty Locked!', `${amountEth} XTZ locked on Etherlink - Ready to claim!`, hashlock, 'etherlink');
                        
                        // Transform button to "Claim Now"
                        btn.disabled = false;
                        btn.className = btn.className.replace('bg-gradient-to-r from-ether-green to-green-400', 'bg-gradient-to-r from-yellow-500 to-orange-500 animate-pulse');
                        btn.innerHTML = `<span>üéâ Claim ${amountEth} XTZ on Etherlink!</span><i class="fa-solid fa-gift"></i>`;
                        btn.onclick = () => {
                            // Switch to Redeem tab and auto-fill
                            switchTab('redeem');
                            document.getElementById('swap-id-input').value = hashlock;
                            document.getElementById('secret-input-claim').value = state.secret;
                            log("üìã Claim form pre-filled. Click 'Claim Funds' to complete!", 'success');
                        };
                        
                        updateProgress(4);
                    }
                }
            } catch (error) {
                console.log('[POLLING] Check failed (will retry):', error.message);
                // Silent fail - will retry on next interval
            }
        }

        // ============================================
        // TOKEN & BALANCE MANAGEMENT
        // ============================================

        // Get balance for a specific token
        async function getTokenBalance(tokenSymbol) {
            if (!state.provider || !state.etherlinkAddress) return '0';
            
            const token = TOKENS[tokenSymbol];
            if (!token) return '0';
            
            // Check if token is available on current network
            if (!isTokenAvailable(tokenSymbol)) {
                return 'N/A';
            }

            try {
                if (token.isNative) {
                    // Native XTZ balance
                    const balance = await state.provider.getBalance(state.etherlinkAddress);
                    return ethers.utils.formatUnits(balance, token.decimals);
                } else {
                    // ERC20 token balance - use getTokenAddress for per-network addresses
                    const tokenAddress = getTokenAddress(tokenSymbol);
                    if (!tokenAddress) return 'N/A';
                    
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, state.provider);
                    const balance = await tokenContract.balanceOf(state.etherlinkAddress);
                    return ethers.utils.formatUnits(balance, token.decimals);
                }
            } catch (error) {
                // Token contract doesn't exist on this network
                console.warn(`Token ${tokenSymbol} not available on current network`);
                return 'N/A';
            }
        }

        // Fetch Jstz balance for connected address
        async function fetchJstzBalance() {
            if (!state.jstzAddress) return null;
            
            try {
                const response = await fetch(`${CONFIG.jstz.rpcUrl}/accounts/${state.jstzAddress}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[JSTZ] Account data:', data);
                    
                    // Handle different response structures
                    // Could be: data.User.amount, data.balance, data.amount
                    let balanceMutez = 0;
                    if (data.User && data.User.amount !== undefined) {
                        balanceMutez = data.User.amount;
                    } else if (data.balance !== undefined) {
                        balanceMutez = data.balance;
                    } else if (data.amount !== undefined) {
                        balanceMutez = data.amount;
                    }
                    
                    // Balance is in mutez (1 XTZ = 1,000,000 mutez)
                    const balanceXTZ = typeof balanceMutez === 'number' ? balanceMutez / 1000000 : parseFloat(balanceMutez) / 1000000;
                    
                    console.log('[JSTZ] Parsed balance:', balanceMutez, 'mutez =', balanceXTZ, 'XTZ');
                    
                    state.jstzBalance = balanceXTZ;
                    state.tokenBalances['XTZ'] = balanceXTZ.toString();
                    updateJstzBalanceDisplay();
                    log(`Balance: ${balanceXTZ.toFixed(4)} XTZ`, 'success');
                    return balanceXTZ;
                } else {
                    console.warn('[JSTZ] Failed to fetch balance:', response.status);
                    // Try alternative endpoint
                    return await fetchJstzBalanceAlt();
                }
            } catch (error) {
                console.warn('[JSTZ] Balance fetch error:', error);
                return await fetchJstzBalanceAlt();
            }
        }
        
        // Alternative balance fetch via ctez endpoint
        async function fetchJstzBalanceAlt() {
            if (!state.jstzAddress) return null;
            
            try {
                // Try the ctez balance endpoint
                const response = await fetch(`${CONFIG.jstz.rpcUrl}/ctez/${state.jstzAddress}/balance`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[JSTZ] Ctez balance data:', data);
                    
                    let balanceMutez = 0;
                    if (data.User && data.User.amount !== undefined) {
                        balanceMutez = data.User.amount;
                    } else if (typeof data === 'number') {
                        balanceMutez = data;
                    } else {
                        balanceMutez = data.balance || data.amount || 0;
                    }
                    
                    const balanceXTZ = typeof balanceMutez === 'number' ? balanceMutez / 1000000 : parseFloat(balanceMutez) / 1000000;
                    
                    state.jstzBalance = balanceXTZ;
                    state.tokenBalances['XTZ'] = balanceXTZ.toString();
                    updateJstzBalanceDisplay();
                    return balanceXTZ;
                }
            } catch (error) {
                console.warn('[JSTZ] Alt balance fetch error:', error);
            }
            
            // Default to 0 if can't fetch
            state.jstzBalance = 0;
            updateJstzBalanceDisplay();
            return 0;
        }
        
        // Update Jstz balance display in UI
        function updateJstzBalanceDisplay() {
            const balanceEl = document.getElementById('selected-token-balance');
            
            // Only update if Jstz wallet is connected
            if (state.connectedWallet === 'jstz') {
                const balance = state.jstzBalance !== undefined ? state.jstzBalance : 0;
                const formatted = parseFloat(balance).toFixed(4);
                if (balanceEl) {
                    balanceEl.innerText = `Balance: ${formatted} XTZ`;
                }
                console.log('[JSTZ] Updated balance display:', formatted, 'XTZ');
            }
        }

        // Fetch all token balances
        async function fetchAllBalances() {
            // For Jstz wallet
            if (state.connectedWallet === 'jstz') {
                await fetchJstzBalance();
                return;
            }
            
            // For Etherlink wallet
            if (!state.provider || !state.etherlinkAddress) return;

            const availableTokens = getAvailableTokens();
            const tokenCount = Object.keys(availableTokens).length;
            log(`Fetching balances for ${tokenCount} token(s)...`, 'system');
            
            for (const [symbol, token] of Object.entries(TOKENS)) {
                if (isTokenAvailable(symbol)) {
                    const balance = await getTokenBalance(symbol);
                    state.tokenBalances[symbol] = balance;
                } else {
                    state.tokenBalances[symbol] = 'N/A';
                }
            }

            // Update UI
            updateBalanceDisplay();
            renderTokenDropdown(); // Re-render with updated balances
            log('Balances updated', 'success');
        }

        // Update balance display in UI
        function updateBalanceDisplay() {
            const balanceEl = document.getElementById('selected-token-balance');
            const walletBalanceEl = document.getElementById('wallet-balance');
            
            if (balanceEl && state.selectedToken) {
                const balance = state.tokenBalances[state.selectedToken];
                if (balance === 'N/A' || !isTokenAvailable(state.selectedToken)) {
                    balanceEl.innerText = `Balance: N/A (not on this network)`;
                } else {
                    const formatted = parseFloat(balance || '0').toFixed(4);
                    balanceEl.innerText = `Balance: ${formatted} ${state.selectedToken}`;
                }
            }
            
            // Update wallet button with XTZ balance
            if (walletBalanceEl && state.tokenBalances['XTZ'] && state.tokenBalances['XTZ'] !== 'N/A') {
                const xtzBalance = parseFloat(state.tokenBalances['XTZ']).toFixed(2);
                walletBalanceEl.innerText = `${xtzBalance} XTZ`;
            }
        }

        // Select a token
        function selectToken(symbol) {
            const token = TOKENS[symbol];
            if (!token) return;

            state.selectedToken = symbol;
            
            // Update UI
            document.getElementById('asset-icon').src = token.icon;
            document.getElementById('asset-symbol').innerText = token.symbol;
            
            // Close dropdown
            toggleTokenSelector(false);
            
            // Update balance display
            updateBalanceDisplay();
            
            log(`Selected token: ${token.name} (${token.symbol})`, 'info');
        }

        // Toggle token selector dropdown
        function toggleTokenSelector(forceState = null) {
            const dropdown = document.getElementById('token-dropdown');
            if (!dropdown) return;

            state.tokenSelectorOpen = forceState !== null ? forceState : !state.tokenSelectorOpen;
            
            if (state.tokenSelectorOpen) {
                dropdown.classList.remove('hidden');
                dropdown.classList.add('flex');
            } else {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('flex');
            }
        }

        // Update the Redeem tab chain indicator based on connected wallet
        function updateRedeemChainIndicator() {
            const badge = document.getElementById('redeem-chain-badge');
            const claimChain = document.getElementById('claim-btn-chain');
            const refundChain = document.getElementById('refund-btn-chain');
            
            if (!badge) return;
            
            if (state.connectedWallet === 'etherlink') {
                badge.textContent = '‚ü† Etherlink';
                badge.className = 'px-3 py-1 rounded-lg text-xs font-bold bg-ether-green/20 text-ether-green border border-ether-green/30';
                if (claimChain) claimChain.textContent = 'on Etherlink';
                if (refundChain) refundChain.textContent = 'on Etherlink';
            } else if (state.connectedWallet === 'jstz') {
                badge.textContent = '‚ö° Jstz';
                badge.className = 'px-3 py-1 rounded-lg text-xs font-bold bg-jstz-accent/20 text-jstz-accent border border-jstz-accent/30';
                if (claimChain) claimChain.textContent = 'on Jstz';
                if (refundChain) refundChain.textContent = 'on Jstz';
            } else {
                badge.textContent = '‚ö†Ô∏è Not Connected';
                badge.className = 'px-3 py-1 rounded-lg text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/30';
                if (claimChain) claimChain.textContent = 'Connect wallet first';
                if (refundChain) refundChain.textContent = 'Connect wallet first';
            }
        }

        // Render token list in dropdown
        function renderTokenDropdown() {
            const dropdown = document.getElementById('token-dropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';
            
            for (const [symbol, token] of Object.entries(TOKENS)) {
                const balance = state.tokenBalances[symbol] || '0';
                const isAvailable = isTokenAvailable(symbol);
                const isSelected = symbol === state.selectedToken;
                
                // Format balance
                let formattedBalance;
                if (!isAvailable || balance === 'N/A') {
                    formattedBalance = 'N/A';
                } else {
                    formattedBalance = parseFloat(balance).toFixed(4);
                }
                
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 transition ${
                    isAvailable 
                        ? `hover:bg-white/10 cursor-pointer ${isSelected ? 'bg-ether-green/10' : ''}` 
                        : 'opacity-40 cursor-not-allowed'
                }`;
                
                if (isAvailable) {
                    item.onclick = () => selectToken(symbol);
                }
                
                const tokenAddr = getTokenAddress(symbol);
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${token.icon}" class="w-8 h-8 rounded-full bg-white p-0.5 ${!isAvailable ? 'grayscale' : ''}" alt="${token.symbol}">
                        <div>
                            <div class="font-bold ${isAvailable ? 'text-white' : 'text-gray-500'}">${token.symbol}</div>
                            <div class="text-xs text-gray-400">${token.name}</div>
                            ${!isAvailable ? '<div class="text-[10px] text-yellow-500">Not on this network</div>' : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-mono ${isAvailable ? 'text-white' : 'text-gray-500'}">${formattedBalance}</div>
                        ${!token.isNative && tokenAddr ? `<div class="text-[10px] text-gray-500 truncate max-w-[80px]">${tokenAddr.substring(0, 10)}...</div>` : ''}
                    </div>
                `;
                dropdown.appendChild(item);
            }
        }

        // Add token to EVM wallet
        async function addTokenToWallet(symbol) {
            const token = TOKENS[symbol];
            if (!token || token.isNative) {
                log('Cannot add native token to wallet', 'warning');
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                log('EVM wallet not detected', 'error');
                return;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: token.address,
                            symbol: token.symbol,
                            decimals: token.decimals,
                            image: token.icon
                        }
                    }
                });
                log(`${token.symbol} added to wallet`, 'success');
            } catch (error) {
                log(`Failed to add token: ${error.message}`, 'error');
            }
        }

        function setChain(chain) {
            // Check if switching to a chain requires the correct wallet
            if (chain === 'etherlink' && state.connectedWallet === 'jstz') {
                log('‚ö†Ô∏è Cannot select Etherlink chain with Jstz wallet connected', 'warning');
                return;
            }
            if (chain === 'jstz' && state.connectedWallet === 'etherlink') {
                log('‚ö†Ô∏è Cannot select Jstz chain with Etherlink wallet connected', 'warning');
                return;
            }
            
            state.chain = chain;
            const btnEth = document.getElementById('chain-etherlink');
            const btnJstz = document.getElementById('chain-jstz');

            // Reset styles
            const activeClass = "border-ether-green bg-ether-green/10 text-white";
            const inactiveClass = "border-transparent text-gray-400 hover:text-white hover:bg-white/5";
            const grayedClass = "opacity-40 pointer-events-none";

            if (chain === 'etherlink') {
                btnEth.className = `relative py-3 rounded-lg transition-all group overflow-hidden ${activeClass}`;
                // Keep jstz grayed if etherlink wallet connected
                const jstzClass = state.connectedWallet === 'etherlink' 
                    ? `relative py-3 rounded-lg transition-all group ${inactiveClass} ${grayedClass}`
                    : `relative py-3 rounded-lg transition-all group ${inactiveClass}`;
                btnJstz.className = jstzClass;
                log("üìç Direction: Etherlink ‚Üí Jstz", 'info');
            } else {
                btnJstz.className = `relative py-3 rounded-lg transition-all group overflow-hidden border-jstz-accent bg-jstz-accent/10 text-white`;
                // Keep etherlink grayed if jstz wallet connected
                const ethClass = state.connectedWallet === 'jstz'
                    ? `relative py-3 rounded-lg transition-all group ${inactiveClass} ${grayedClass}`
                    : `relative py-3 rounded-lg transition-all group ${inactiveClass}`;
                btnEth.className = ethClass;
                log("üìç Direction: Jstz ‚Üí Etherlink", 'info');
            }
            
            // Update balance display for selected token
            updateBalanceDisplay();
            
            // Update counterparty field UI based on chain and mode
            updateCounterpartyUI();
        }
        
        // ============================================
        // COUNTERPARTY FIELD DYNAMIC UI
        // ============================================
        
        /**
         * Updates the counterparty input field based on current mode and chain.
         * 
         * ATOMIC SWAP LOGIC:
         * - When you lock funds, the RECIPIENT is who can claim YOUR funds on THIS chain
         * - The recipient must have an address on the SAME chain where you're locking
         * 
         * INITIATE MODE (Alice):
         * - Alice locks on Etherlink ‚Üí Recipient = Bob's 0x address (Bob claims on Etherlink)
         * - Alice locks on Jstz ‚Üí Recipient = Bob's tz1 address (Bob claims on Jstz)
         * 
         * JOIN MODE (Bob):
         * - Bob locks on Jstz (Alice initiated on Etherlink) ‚Üí Recipient = Alice's tz1 address
         * - Bob locks on Etherlink (Alice initiated on Jstz) ‚Üí Recipient = Alice's 0x address
         */
        function updateCounterpartyUI() {
            const labelText = document.getElementById('counterparty-label-text');
            const requiredBadge = document.getElementById('counterparty-required');
            const tooltipText = document.getElementById('counterparty-tooltip-text');
            const input = document.getElementById('counterparty-input');
            const formatHint = document.getElementById('counterparty-format-hint');
            const helpText = document.getElementById('counterparty-help-text');
            const errorEl = document.getElementById('counterparty-error');
            
            if (!labelText || !input) return;
            
            // Hide error when updating
            if (errorEl) errorEl.classList.add('hidden');
            
            const isJoinMode = state.mode === 'join';
            const lockingOnJstz = state.chain === 'jstz';
            
            // Determine expected format based on where we're locking
            // Recipient must be on the SAME chain where we lock (they claim there)
            const expectedFormat = lockingOnJstz ? 'tz1' : '0x';
            const formatExample = lockingOnJstz ? 'tz1...' : '0x...';
            const chainName = lockingOnJstz ? 'Jstz' : 'Etherlink';
            
            if (isJoinMode) {
                // BOB is matching - recipient is ALICE
                labelText.textContent = "Alice's Address (Recipient)";
                requiredBadge.classList.remove('hidden');
                tooltipText.innerHTML = `
                    <strong>üîê Security:</strong> Enter Alice's <strong>${chainName}</strong> address.<br><br>
                    Alice will claim your locked funds on ${chainName} using this address.<br>
                    <span class="text-yellow-400">Format required: ${formatExample}</span>
                `;
                input.placeholder = `Enter Alice's ${chainName} address (${formatExample})`;
                helpText.textContent = `Alice will use this address to claim your ${lockingOnJstz ? 'Jstz' : 'Etherlink'} funds.`;
            } else {
                // ALICE is initiating - recipient is BOB
                labelText.textContent = "Bob's Address (Recipient)";
                requiredBadge.classList.remove('hidden');
                tooltipText.innerHTML = `
                    <strong>üîê Security:</strong> Enter Bob's <strong>${chainName}</strong> address.<br><br>
                    Bob will claim your locked funds on ${chainName} using this address.<br>
                    <span class="text-yellow-400">Format required: ${formatExample}</span>
                `;
                input.placeholder = `Enter Bob's ${chainName} address (${formatExample})`;
                helpText.textContent = `Bob will use this address to claim your ${lockingOnJstz ? 'Jstz' : 'Etherlink'} funds.`;
            }
            
            // Update format hint
            formatHint.textContent = formatExample;
            formatHint.className = lockingOnJstz 
                ? 'absolute right-3 top-1/2 -translate-y-1/2 text-xs text-jstz-accent bg-jstz-accent/10 px-2 py-1 rounded border border-jstz-accent/30'
                : 'absolute right-3 top-1/2 -translate-y-1/2 text-xs text-ether-green bg-ether-green/10 px-2 py-1 rounded border border-ether-green/30';
            
            // Add input validation listener
            input.oninput = () => validateCounterpartyInput();
        }
        
        /**
         * Validates the counterparty input and shows error if format is wrong
         */
        function validateCounterpartyInput() {
            const input = document.getElementById('counterparty-input');
            const errorEl = document.getElementById('counterparty-error');
            const errorText = document.getElementById('counterparty-error-text');
            
            if (!input || !errorEl) return true;
            
            const value = input.value.trim();
            if (!value) {
                errorEl.classList.add('hidden');
                return true; // Empty is allowed (will use zero address)
            }
            
            const lockingOnJstz = state.chain === 'jstz';
            const expectedFormat = lockingOnJstz ? 'tz' : '0x';
            const chainName = lockingOnJstz ? 'Jstz' : 'Etherlink';
            
            // Check format
            if (lockingOnJstz) {
                // Jstz: must start with tz1, tz2, tz3, or KT1
                if (!value.match(/^(tz1|tz2|tz3|KT1)[a-zA-Z0-9]{33}$/)) {
                    if (value.startsWith('0x')) {
                        errorText.textContent = `Wrong format! You're locking on Jstz, so recipient needs a tz1... address, not 0x...`;
                    } else {
                        errorText.textContent = `Invalid Jstz address format. Expected: tz1... (36 characters)`;
                    }
                    errorEl.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    return false;
                }
            } else {
                // Etherlink: must be 0x + 40 hex chars
                if (!value.match(/^0x[a-fA-F0-9]{40}$/)) {
                    if (value.startsWith('tz')) {
                        errorText.textContent = `Wrong format! You're locking on Etherlink, so recipient needs a 0x... address, not tz1...`;
                    } else {
                        errorText.textContent = `Invalid Etherlink address format. Expected: 0x... (42 characters)`;
                    }
                    errorEl.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    return false;
                }
            }
            
            // Valid!
            errorEl.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }
        
        /**
         * Gets the validated counterparty address or null if invalid/empty
         * Shows error and blocks action if format is wrong
         */
        function getValidatedCounterparty(showError = true) {
            const input = document.getElementById('counterparty-input');
            const value = input?.value?.trim() || '';
            
            if (!value) {
                if (showError) {
                    log(`‚ö†Ô∏è Warning: No recipient set - swap will be less secure!`, 'warning');
                }
                return null;
            }
            
            if (!validateCounterpartyInput()) {
                if (showError) {
                    const lockingOnJstz = state.chain === 'jstz';
                    const expectedFormat = lockingOnJstz ? 'tz1...' : '0x...';
                    log(`‚ùå Invalid recipient address! Expected format: ${expectedFormat}`, 'error');
                }
                return false; // false = invalid (different from null = empty)
            }
            
            return value;
        }

        // Alias for setTab (used in onClick handlers)
        function switchTab(mode) {
            setTab(mode);
        }
        
        function setTab(mode) {
            state.mode = mode;
            
            // Stop counterparty polling when changing tabs
            stopCounterpartyPolling();
            
            const btnCreate = document.getElementById('tab-create');
            const btnJoin = document.getElementById('tab-join');
            const btnRedeem = document.getElementById('tab-redeem');
            const btnMySwaps = document.getElementById('tab-myswaps');
            const actionBtn = document.getElementById('main-action-btn');
            const secretSection = document.getElementById('secret-section');
            const timelockInput = document.getElementById('timelock-input');
            
            // Content Sections
            const initiateJoinContent = document.getElementById('initiate-join-content');
            const redeemContent = document.getElementById('redeem-content');
            const myswapsContent = document.getElementById('myswaps-content');
            
            // Input Containers
            const secretContainer = document.getElementById('secret-container');
            const hashContainer = document.getElementById('hash-container');
            const proofInputs = document.getElementById('proof-inputs');
            const hashInput = document.getElementById('hash-input');
            const copyHashBtn = document.getElementById('copy-hash-btn');
            const regenSecretBtn = document.getElementById('regen-secret-btn');

            // Reset Button State
            actionBtn.disabled = false;
            actionBtn.onclick = executeAction;
            actionBtn.classList.remove('bg-ether-green', 'text-black');

            // Reset Tab Styles
            const inactiveStyle = "flex-1 py-3 rounded-lg text-sm font-semibold text-gray-400 hover:text-white hover:bg-white/5 transition-all";
            btnCreate.className = inactiveStyle;
            btnJoin.className = inactiveStyle;
            btnRedeem.className = inactiveStyle;
            btnMySwaps.className = inactiveStyle;
            
            // Hide all content sections
            initiateJoinContent.classList.add('hidden');
            redeemContent.classList.add('hidden');
            myswapsContent.classList.add('hidden');

            if (mode === 'redeem') {
                // REDEEM MODE
                btnRedeem.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-white bg-purple-600 shadow-lg transition-all";
                redeemContent.classList.remove('hidden');
                log("Switched to Redeem / Refund Mode", 'info');
                return;
            }
            
            if (mode === 'myswaps') {
                // MY SWAPS MODE
                btnMySwaps.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg transition-all";
                myswapsContent.classList.remove('hidden');
                log("Switched to My Swaps", 'info');
                // Auto-load swaps when tab is opened
                loadMySwaps();
                return;
            }
            
            // INITIATE or JOIN MODE
            initiateJoinContent.classList.remove('hidden');

            if (mode === 'create') {
                btnCreate.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-white bg-ether-border shadow-lg transition-all";
                
                // SHOW Secret Gen UI
                secretSection.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
                secretContainer.style.display = 'block';
                proofInputs.classList.remove('grid-cols-1');
                proofInputs.classList.add('md:grid-cols-2');
                
                regenSecretBtn.style.display = 'block';
                copyHashBtn.style.display = 'block';
                
                // Hide Verify buttons and Alice details in create mode
                const verifyBtn = document.getElementById('verify-swap-btn');
                if (verifyBtn) verifyBtn.classList.add('hidden');
                const verifyJstzBtn = document.getElementById('verify-jstz-btn');
                if (verifyJstzBtn) verifyJstzBtn.classList.add('hidden');
                const skipVerifyBtn = document.getElementById('skip-verify-btn');
                if (skipVerifyBtn) skipVerifyBtn.classList.add('hidden');
                const aliceDetails = document.getElementById('alice-swap-details');
                if (aliceDetails) aliceDetails.classList.add('hidden');
                
                // Hash Input Readonly
                hashInput.readOnly = true;
                hashInput.classList.add('text-gray-300');
                hashInput.classList.remove('text-white', 'bg-white/5');
                
                generateNewSecret();
                
                // Reset Timelock
                if(timelockInput) timelockInput.value = 60;
                
                // Enable action button in create mode
                actionBtn.disabled = false;

                actionBtn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>`;
                actionBtn.className = "btn-primary w-full py-4 rounded-xl text-lg shadow-[0_0_20px_rgba(57,255,20,0.2)] flex items-center justify-center gap-2 group";
                
                log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", 'system');
                log("üë§ MODE: INITIATOR", 'success');
                log("üìã You are CREATING a new swap", 'info');
                log("1Ô∏è‚É£ Generate a secret and a hash", 'system');
                log("2Ô∏è‚É£ Click 'Initiate Swap' to lock your funds", 'system');
                log("3Ô∏è‚É£ Share the HASH with counterparty (not the secret!)", 'system');
                log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", 'system');
            } else {
                btnJoin.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-black bg-jstz-accent shadow-lg transition-all";
                
                // HIDE Secret Gen UI, SHOW Manual Hash Input
                secretSection.classList.remove('opacity-50', 'pointer-events-none', 'grayscale'); // Keep active for input
                secretContainer.style.display = 'none';
                proofInputs.classList.remove('md:grid-cols-2');
                proofInputs.classList.add('grid-cols-1');
                
                regenSecretBtn.style.display = 'none';
                copyHashBtn.style.display = 'none';
                
                // Show Verify button in Join mode
                const verifyBtn = document.getElementById('verify-swap-btn');
                if (verifyBtn) verifyBtn.classList.remove('hidden');
                
                // Hide Jstz verify button and CLI skip button initially (shown only when direct verify fails)
                const verifyJstzBtn = document.getElementById('verify-jstz-btn');
                if (verifyJstzBtn) {
                    verifyJstzBtn.classList.add('hidden');
                    verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Connect Jstz to Verify`;
                    verifyJstzBtn.disabled = false;
                }
                const skipVerifyBtn = document.getElementById('skip-verify-btn');
                if (skipVerifyBtn) skipVerifyBtn.classList.add('hidden');
                
                // Hide Alice swap details initially
                const aliceDetails = document.getElementById('alice-swap-details');
                if (aliceDetails) aliceDetails.classList.add('hidden');
                
                // Reset verification state
                state.aliceSwapVerified = false;
                state.pendingJstzVerifyHashlock = null;
                
                // Make Hash Input Editable
                hashInput.readOnly = false;
                hashInput.value = "";
                hashInput.placeholder = "Paste HashLock here (0x...)";
                hashInput.classList.remove('text-gray-300');
                hashInput.classList.add('text-white', 'bg-white/5');
                hashInput.focus();

                // Enforce Timelock < Alice's (e.g. 30 mins)
                if(timelockInput) timelockInput.value = 30;

                // Initially show "Verify First" button
                actionBtn.innerHTML = `<span>Verify Swap First</span><i class="fa-solid fa-magnifying-glass"></i>`;
                actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-blue-500/50 text-white shadow-lg flex items-center justify-center gap-2 cursor-not-allowed opacity-70";
                actionBtn.disabled = true;
                
                log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", 'system');
                log("üë§ MODE: PARTICIPANT", 'warning');
                log("üìã You are RESPONDING to an existing swap", 'info');
                log("‚ö†Ô∏è PREREQUISITE: Initiator must have ALREADY locked their funds!", 'warning');
                log("1Ô∏è‚É£ Paste the HASH received from initiator", 'system');
                log("2Ô∏è‚É£ Click 'Verify' to check their swap details", 'system');
                log("3Ô∏è‚É£ Review the amount, then click 'Match Swap'", 'system');
                log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", 'system');
            }
            
            // Update counterparty field UI based on mode and chain
            updateCounterpartyUI();
        }

        function updateProgress(step) {
            state.step = step;
            const progressBar = document.getElementById('progress-bar');
            
            // Reset all
            [1,2,3,4].forEach(i => {
                const container = document.getElementById(`step-${i}`);
                const dot = container.querySelector('.step-dot');
                
                dot.classList.remove('active', 'completed');
                dot.innerHTML = i;
                
                if (i < step) {
                    dot.classList.add('completed');
                    dot.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else if (i === step) {
                    dot.classList.add('active');
        }
            });

            // Bar width
            const percentage = ((step - 1) / 3) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        // ============================================
        // REAL CONTRACT INTERACTIONS
        // ============================================

        // ALICE initiates swap on Etherlink (locks XTZ, Bob will match on Jstz)
        async function initiateAsAliceOnEtherlink() {
            const btn = document.getElementById('main-action-btn');
            const amount = document.getElementById('amount-input').value;
            const counterpartyInput = document.getElementById('counterparty-input');
            const timelockInput = document.getElementById('timelock-input');
            const timelockMins = parseInt(timelockInput?.value || 60);
            
            // ========== INPUT VALIDATION ==========
            
            // 1. Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                log("‚ùå Please enter a valid amount (> 0)", 'error');
                return;
            }
            
            // 2. Validate hashlock exists and is properly formatted
            if (!state.hash || !isValidHashLock(state.hash)) {
                log("‚ùå Invalid HashLock. Generate a new secret first.", 'error');
                return;
            }
            
            // 3. Validate secret exists (needed for claiming later)
            if (!state.secret) {
                log("‚ùå Secret not found. Generate a new secret first.", 'error');
                return;
            }
            
            // 4. Validate timelock (minimum 5 minutes for safety)
            if (timelockMins < 5) {
                log("‚ùå Timelock must be at least 5 minutes for safety", 'error');
                return;
            }
            
            // 5. Validate counterparty address format if provided
            // Alice initiates on Etherlink ‚Üí Bob will claim on Etherlink ‚Üí recipient must be Bob's 0x address
            const counterpartyValue = counterpartyInput?.value?.trim() || '';
            if (counterpartyValue && !counterpartyValue.startsWith('0x')) {
                log("‚ö†Ô∏è Note: Counterparty should be Bob's Etherlink address (0x...) - he will claim these funds", 'warning');
            }

            // Connect if not connected
            if (!state.provider) {
                const connected = await connectEtherlink();
                if (!connected) return;
            }

            // Check if contract is deployed on this network
            if (!state.contract) {
                const networkName = NETWORK_CONFIG[state.currentChainId]?.name || 'this network';
                log(`‚ùå HTLC contract not deployed on ${networkName}!`, 'error');
                log('Deploy with: npx hardhat run scripts/deploy.js --network etherlinkTestnet', 'system');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Checking for duplicates...`;
            
            // ========== DUPLICATE CHECK ==========
            // 5. Check if swap with this hashlock already exists
            log('Checking if swap already exists...', 'warning');
            const existingSwap = await verifySwapOnEtherlink(state.hash);
            if (existingSwap.valid && existingSwap.swap) {
                log(`‚ùå A swap with this HashLock already exists!`, 'error');
                log(`State: ${['OPEN', 'CLAIMED', 'REFUNDED'][existingSwap.swap.status]}`, 'info');
                log(`Generate a new secret to create a new swap.`, 'system');
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            log('‚úì HashLock is unique', 'success');
            
            // ========== BALANCE CHECK ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Checking balance...`;
            
            // 6. Check user has enough balance
            const balance = await state.provider.getBalance(state.etherlinkAddress);
            const amountWei = ethers.utils.parseEther(amount);
            if (balance.lt(amountWei)) {
                const balanceEth = ethers.utils.formatEther(balance);
                log(`‚ùå Insufficient balance!`, 'error');
                log(`Required: ${amount} XTZ, Available: ${parseFloat(balanceEth).toFixed(4)} XTZ`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            log('‚úì Sufficient balance', 'success');
            
            // ========== VALIDATE RECIPIENT ==========
            // Alice locks on Etherlink ‚Üí Bob (recipient) must have 0x address to claim here
            const validatedRecipient = getValidatedCounterparty(true);
            if (validatedRecipient === false) {
                // Invalid format - error already shown
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            
            const recipient = validatedRecipient || ethers.constants.AddressZero;
            if (!validatedRecipient) {
                log(`‚ö†Ô∏è No recipient set - anyone with the secret can claim your funds!`, 'warning');
                log(`üí° For security, enter Bob's Etherlink address (0x...)`, 'info');
            }
            
            // ========== EXECUTE INITIATE ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Initiating Swap...`;

            try {
                const expiration = Math.floor(Date.now() / 1000) + (timelockMins * 60);
                
                log(`Initiating swap on Etherlink...`, 'warning');
                log(`Amount: ${amount} XTZ`, 'info');
                log(`HashLock: ${state.hash.substring(0, 18)}...`, 'info');
                log(`Expiration: ${new Date(expiration * 1000).toLocaleTimeString()} (${timelockMins} mins)`, 'info');
                if (recipient !== ethers.constants.AddressZero) {
                    log(`Recipient: ${recipient.substring(0, 10)}...`, 'info');
                }

                const tx = await state.contract.initiateSwap(
                    recipient,
                    state.hash,
                    expiration,
                    { value: amountWei }
                );

                logTx(tx.hash, 'üì§ Transaction sent');
                
                const receipt = await tx.wait();
                
                state.currentSwapId = state.hash;
                
                log(`‚úÖ Swap initiated on Etherlink!`, 'success');
                logTx(receipt.hash || tx.hash, '‚úÖ Confirmed');
                log(`SwapId: ${state.currentSwapId.substring(0, 18)}...`, 'info');
                log(`Funds Locked: ${amount} XTZ`, 'success');
                
                updateProgress(2);
                btn.innerHTML = `<span>Waiting for Bob on Jstz...</span>`;
                
                // Pre-fill values for redeem tab
                prefillRedeemForm(state.currentSwapId, state.secret);
                
                // Show initiate success popup!
                const explorerUrl = `https://testnet.explorer.etherlink.com/tx/${receipt.hash || tx.hash}`;
                showSuccessModal({
                    type: 'initiate',
                    title: 'üîí Funds Locked!',
                    subtitle: 'Share the Hash with your counterparty',
                    amount: amount,
                    token: 'XTZ',
                    chain: 'etherlink',
                    sender: state.etherlinkAddress,
                    hashlock: state.hash,
                    txHash: receipt.hash || tx.hash,
                    explorerUrl: explorerUrl,
                    extraActions: [{
                        label: 'üìã Copy Hash',
                        onClick: `navigator.clipboard.writeText('${state.hash}'); log('‚úÖ Hash copied!', 'success')`,
                        primary: true
                    }]
                });
                
                // Start polling for counterparty's lock on Jstz
                setTimeout(() => {
                    log("Ready to claim on Jstz (when counterparty has locked funds)", 'system');
                    btn.disabled = false;
                    btn.innerHTML = `<span>üëÄ Watching for counterparty...</span><i class="fa-solid fa-spinner fa-spin ml-2"></i>`;
                    updateProgress(3);
                    
                    // Start automatic polling
                    startCounterpartyPolling(state.hash, 'etherlink');
                }, 2000);

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
            }
        }

        // ALICE initiates swap on Jstz (locks XTZ, Bob will match on Etherlink)
        async function initiateAsAliceOnJstz() {
            const btn = document.getElementById('main-action-btn');
            const amount = document.getElementById('amount-input').value;
            const counterpartyInput = document.getElementById('counterparty-input');
            const timelockInput = document.getElementById('timelock-input');
            const timelockMins = parseInt(timelockInput?.value || 60);

            // ========== INPUT VALIDATION ==========
            
            // 1. Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                log("‚ùå Please enter a valid amount (> 0)", 'error');
                return;
            }
            
            // 2. Validate we have a secret (Alice generates the secret)
            if (!state.secret || !state.hash) {
                log("‚ùå Please generate a secret first (click 'Initiate' tab)", 'error');
                return;
            }
            
            // 3. Validate timelock (minimum 5 minutes for safety)
            if (timelockMins < 5) {
                log("‚ùå Timelock must be at least 5 minutes for safety", 'error');
                return;
            }
            
            // 4. Validate counterparty address format if provided
            // Alice initiates on Jstz ‚Üí Bob will claim on Jstz ‚Üí recipient must be Bob's tz1 address
            const counterpartyValue = counterpartyInput?.value?.trim() || '';
            if (counterpartyValue && !counterpartyValue.startsWith('tz')) {
                log("‚ö†Ô∏è Note: Counterparty should be Bob's Jstz address (tz1...) - he will claim these funds", 'warning');
            }

            // 5. Connect Jstz if not connected
            if (!state.jstzAddress) {
                log('Connecting to Jstz wallet...', 'warning');
                const connected = await connectJstz();
                if (!connected) {
                    log('‚ùå Failed to connect Jstz wallet', 'error');
                    return;
                }
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Checking for duplicates...`;

            // ========== CHECK FOR DUPLICATE ON JSTZ ==========
            // Note: We can't verify duplicates without CLI, so we skip this check
            // The Jstz smart function will reject if a duplicate exists
            log('‚ö†Ô∏è Skipping duplicate check (requires CLI verification)', 'warning');
            log('üí° The smart function will reject if hash already exists', 'system');

            // ========== INITIATE SWAP ON JSTZ ==========
            // ========== VALIDATE RECIPIENT ==========
            // Alice locks on Jstz ‚Üí Bob (recipient) must have tz1 address to claim here
            const validatedRecipient = getValidatedCounterparty(true);
            if (validatedRecipient === false) {
                // Invalid format - error already shown
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            
            const recipient = validatedRecipient || null;
            if (!validatedRecipient) {
                log(`‚ö†Ô∏è No recipient set - anyone with the secret can claim your funds!`, 'warning');
                log(`üí° For security, enter Bob's Jstz address (tz1...)`, 'info');
            }
            
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Locking funds on Jstz...`;

            try {
                const expiration = Math.floor(Date.now() / 1000) + (timelockMins * 60);
                
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                log(`üîê ALICE INITIE SUR JSTZ`, 'warning');
                log(`Amount: ${amount} XTZ`, 'info');
                log(`HashLock: ${state.hash.substring(0, 18)}...`, 'info');
                log(`Expiration: ${new Date(expiration * 1000).toLocaleTimeString()} (${timelockMins} mins)`, 'info');
                if (recipient) {
                    log(`Recipient (Bob): ${recipient.substring(0, 15)}...`, 'info');
                }
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                
                // Call Jstz smart function with REAL tez transfer
                // Convert XTZ to mutez (1 XTZ = 1,000,000 mutez)
                const amountMutez = Math.floor(parseFloat(amount) * 1000000);
                
                log(`Calling Jstz HTLC: /initiate`, 'system');
                log(`üí∞ Transferring ${amountMutez} mutez (${amount} XTZ) to smart function`, 'warning');
                
                const response = await jstzRequest('POST', '/initiate', {
                    hashlock: state.hash,
                    expiration: expiration,
                    recipient: recipient || null
                    // Note: amount is sent via X-JSTZ-TRANSFER header, not in body
                }, {
                    requiresSignature: true,
                    transferAmountMutez: amountMutez // This adds X-JSTZ-TRANSFER header
                });
                
                // Handle CLI fallback
                if (response && response.cliRequired) {
                    log(`‚ö†Ô∏è Complete the swap using the CLI command in the popup`, 'warning');
                    log(`üìã After running the CLI command, verify the swap was created`, 'info');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                    return;
                }
                
                // Check for errors (contract-level or operation-level)
                if (!response || !response.success || response.error) {
                    const errorMsg = response?.error || response?.message?.error || 'Failed to initiate swap on Jstz';
                    throw new Error(errorMsg);
                }
                
                // Store for later
                state.currentSwapId = state.hash;
                
                log(`üéâ SWAP INITIATED SUCCESSFULLY ON JSTZ!`, 'success');
                log(`üí∞ Funds locked: ${amount} XTZ`, 'success');
                
                updateProgress(2);
                
                // Pre-fill values for redeem tab
                prefillRedeemForm(state.currentSwapId, state.secret);
                
                // Show initiate success popup!
                showSuccessModal({
                    type: 'initiate',
                    title: 'üîí Funds Locked!',
                    subtitle: 'Share the Hash with your counterparty',
                    amount: amount,
                    token: 'XTZ',
                    chain: 'jstz',
                    sender: state.jstzAddress,
                    hashlock: state.hash,
                    txHash: response.operationHash,
                    explorerUrl: `https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}`,
                    extraActions: [{
                        label: 'üìã Copy Hash',
                        onClick: `navigator.clipboard.writeText('${state.hash}'); log('‚úÖ Hash copied!', 'success')`,
                        primary: true
                    }]
                });
                
                btn.innerHTML = `<span>üëÄ Watching for counterparty...</span><i class="fa-solid fa-spinner fa-spin ml-2"></i>`;
                
                setTimeout(() => {
                    log("Ready to claim on Etherlink (when counterparty has locked)", 'system');
                    btn.disabled = false;
                    updateProgress(3);
                    
                    // Start automatic polling
                    startCounterpartyPolling(state.hash, 'jstz');
                }, 2000);

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Initiate Swap</span><i class="fa-solid fa-arrow-right"></i>`;
            }
        }

        // BOB matches swap on Jstz (Alice already locked on Etherlink)
        async function matchAsBobOnJstz() {
            const btn = document.getElementById('main-action-btn');
            const amount = document.getElementById('amount-input').value;
            const hashInput = document.getElementById('hash-input');
            const hashlock = hashInput.value;
            const timelockInput = document.getElementById('timelock-input');
            const timelockMins = parseInt(timelockInput?.value || 30);

            // ========== INPUT VALIDATION ==========
            
            // 1. Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                log("‚ùå Please enter a valid amount (> 0)", 'error');
                return;
            }

            // 2. Validate hashlock format
            if (!hashlock || !isValidHashLock(hashlock)) {
                log("‚ùå Please enter a valid HashLock (0x + 64 hex characters)", 'error');
                log("Get the HashLock from Alice who initiated the swap", 'info');
                return;
            }
            
            // 3. Validate timelock (Bob's timelock should be shorter than Alice's)
            if (timelockMins < 2) {
                log("‚ùå Timelock must be at least 2 minutes", 'error');
                return;
            }
            
            // 4. Warning if timelock is too long (should be shorter than Alice's)
            if (timelockMins >= 60) {
                log("‚ö†Ô∏è Warning: Your timelock should be shorter than Alice's for safety", 'warning');
            }
            
            // 5. Validate recipient address format (Bob locks on Jstz ‚Üí needs Alice's tz1)
            const validatedRecipient = getValidatedCounterparty(true);
            if (validatedRecipient === false) {
                // Invalid format - error already shown
                log("üí° Enter Alice's Jstz address (tz1...) so only she can claim your funds", 'info');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying Alice's swap...`;
            
            // ========== VERIFY ALICE'S SWAP EXISTS ==========
            // 5. Check that Alice has already locked funds on Etherlink with this hashlock
            log("Checking if Alice has locked funds on Etherlink...", 'warning');
            const aliceSwap = await verifySwapOnEtherlink(hashlock, SwapState.OPEN);
            
            if (!aliceSwap.valid) {
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                log(`‚ùå ERROR: No swap found on Etherlink!`, 'error');
                log(``, 'system');
                log(`üìã What this means:`, 'warning');
                log(`   Alice has not yet locked her funds`, 'info');
                log(`   with this HashLock on Etherlink.`, 'info');
                log(``, 'system');
                log(`‚úÖ What you need to do:`, 'success');
                log(`   1. Ask Alice to initiate the swap first`, 'system');
                log(`   2. Alice must click "From Etherlink" with this hash`, 'system');
                log(`   3. Then come back here to "Match Swap"`, 'system');
                log(``, 'system');
                log(`üîë Expected HashLock: ${hashlock.substring(0, 20)}...`, 'info');
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            
            log(`‚úì Found Alice's swap: ${aliceSwap.swap.amount} XTZ locked`, 'success');
            log(`‚úì Alice's address: ${aliceSwap.swap.sender.substring(0, 10)}...`, 'success');
            log(`‚úì Expires: ${aliceSwap.swap.expirationDate}`, 'success');
            
            // 6. Check Alice's swap hasn't expired
            if (aliceSwap.swap.isExpired) {
                log("‚ùå Alice's swap has expired! Don't lock your funds.", 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            
            // 7. Check there's enough time for Bob's timelock to be shorter
            const aliceExpiration = aliceSwap.swap.expiration;
            const now = Math.floor(Date.now() / 1000);
            const aliceRemainingMins = Math.floor((aliceExpiration - now) / 60);
            
            if (timelockMins >= aliceRemainingMins) {
                log(`‚ùå Your timelock (${timelockMins}m) must be shorter than Alice's remaining time (${aliceRemainingMins}m)`, 'error');
                log(`Recommended: Set timelock to ${Math.floor(aliceRemainingMins / 2)} minutes`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            log(`‚úì Timelock is safe (${timelockMins}m < ${aliceRemainingMins}m remaining)`, 'success');
            
            // ========== SKIP DUPLICATE CHECK ON JSTZ ==========
            // Note: Can't verify duplicates without CLI, Jstz smart function will reject if exists
            log('‚ö†Ô∏è Skipping Jstz duplicate check (will fail if hash exists)', 'warning');
            
            // ========== EXECUTE INITIATE ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Locking on Jstz...`;

            try {
                const expiration = Math.floor(Date.now() / 1000) + (timelockMins * 60);
                
                log(`Initiating swap on Jstz...`, 'warning');
                log(`HashLock: ${hashlock.substring(0, 18)}...`, 'info');
                log(`Amount: ${amount} XTZ`, 'info');
                log(`Timelock: ${timelockMins} minutes`, 'info');
                
                // Call Jstz smart function with REAL tez transfer
                // Convert XTZ to mutez (1 XTZ = 1,000,000 mutez)
                const amountMutez = Math.floor(parseFloat(amount) * 1000000);
                
                log(`Calling Jstz HTLC: jstz://htlc/initiate`, 'system');
                log(`üí∞ Transferring ${amountMutez} mutez (${amount} XTZ) to smart function`, 'warning');
                
                // SECURITY: Bob locks on Jstz ‚Üí Alice (recipient) must have tz1 address
                // Recipient was already validated before this function was called
                const aliceJstzAddress = getValidatedCounterparty(false); // Don't show error again
                
                if (aliceJstzAddress) {
                    log(`üîí Recipient (Alice): ${aliceJstzAddress.substring(0, 15)}...`, 'info');
                } else {
                    log(`‚ö†Ô∏è Warning: No recipient set - anyone with secret can claim!`, 'warning');
                    log(`üìã Alice's Etherlink address (for reference): ${aliceSwap.swap.sender}`, 'info');
                }
                
                const response = await jstzRequest('POST', '/initiate', {
                    hashlock: hashlock,
                    expiration: expiration,
                    recipient: aliceJstzAddress || null // Only Alice can claim (if set)
                    // Note: amount is sent via X-JSTZ-TRANSFER header, not in body
                }, {
                    requiresSignature: true,
                    transferAmountMutez: amountMutez // This adds X-JSTZ-TRANSFER header
                });
                
                // Handle CLI fallback
                if (response && response.cliRequired) {
                    log(`‚ö†Ô∏è Complete the swap using the CLI command in the popup`, 'warning');
                    log(`üìã After running the CLI command, verify the swap was created`, 'info');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                    return;
                }
                
                // Check for errors (contract-level or operation-level)
                if (!response || !response.success || response.error) {
                    const errorMsg = response?.error || response?.message?.error || 'Failed to match swap on Jstz';
                    throw new Error(errorMsg);
                }
                
                state.currentSwapId = hashlock;
                state.hash = hashlock;
                
                log(`üéâ SWAP MATCHED SUCCESSFULLY!`, 'success');
                log(`üí∞ Funds locked: ${amount} XTZ on Jstz`, 'success');
                
                updateProgress(3);
                
                // Pre-fill values for redeem tab
                prefillRedeemForm(state.hash, null);
                
                // Show match success popup!
                showSuccessModal({
                    type: 'match',
                    title: 'ü§ù Swap Matched!',
                    subtitle: 'Wait for Alice to claim, then use the secret',
                    amount: amount,
                    token: 'XTZ',
                    chain: 'jstz',
                    sender: state.jstzAddress,
                    hashlock: hashlock,
                    txHash: response.operationHash,
                    explorerUrl: `https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}`,
                    extraActions: [{
                        label: 'üëÄ Watch for Secret',
                        onClick: `closeSuccessModal()`,
                        primary: true
                    }]
                });
                
                btn.innerHTML = `<span>üîë Watching for Secret...</span><i class="fa-solid fa-spinner fa-spin ml-2"></i>`;
                
                // Start polling for secret revelation
                setTimeout(() => {
                    log("Ready to claim on Etherlink (when Alice reveals the secret)", 'system');
                    btn.disabled = false;
                    
                    // Alice locked on Etherlink, Bob locked on Jstz
                    // Watch Jstz for Alice to claim (reveal secret)
                    startSecretPolling(hashlock, 'etherlink');
                }, 2000);

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
            }
        }

        // BOB matches swap on Etherlink (Alice already locked on Jstz)
        async function matchAsBobOnEtherlink() {
            const btn = document.getElementById('main-action-btn');
            const amount = document.getElementById('amount-input').value;
            const hashInput = document.getElementById('hash-input');
            const hashlock = hashInput.value;
            const timelockInput = document.getElementById('timelock-input');
            const timelockMins = parseInt(timelockInput?.value || 30);

            // ========== INPUT VALIDATION ==========
            
            // 1. Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                log("‚ùå Please enter a valid amount (> 0)", 'error');
                return;
            }
            
            // 2. Validate hashlock (provided by Alice)
            if (!hashlock || !isValidHashLock(hashlock)) {
                log("‚ùå Please enter Alice's HashLock (0x...)", 'error');
                return;
            }
            
            // 3. Validate timelock (Bob's timelock should be shorter than Alice's)
            if (timelockMins < 2) {
                log("‚ùå Timelock must be at least 2 minutes", 'error');
                return;
            }
            
            // 4. Warning if timelock is too long (should be shorter than Alice's)
            if (timelockMins >= 60) {
                log("‚ö†Ô∏è Warning: Your timelock should be shorter than Alice's for safety", 'warning');
            }
            
            // 5. Validate recipient address format (Bob locks on Etherlink ‚Üí needs Alice's 0x)
            const validatedRecipient = getValidatedCounterparty(true);
            if (validatedRecipient === false) {
                // Invalid format - error already shown
                log("üí° Enter Alice's Etherlink address (0x...) so only she can claim your funds", 'info');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying Alice's swap on Jstz...`;
            
            // ========== VERIFY ALICE'S SWAP EXISTS ON JSTZ ==========
            log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", 'system');
            log("üîç BOB VERIFYING ALICE'S SWAP ON JSTZ", 'warning');
            log("‚ö†Ô∏è Cannot auto-verify Jstz swap (extension limitation)", 'warning');
            log(`üí° Verify manually with CLI:`, 'system');
            log(`<code class="bg-black/50 px-2 py-1 rounded text-xs">jstz run "jstz://${CONFIG.jstz.contractAddress}/swap/${hashlock}" -n privatenet -m POST -d '{}'</code>`, 'info');
            log(``, 'system');
            log(`‚ö†Ô∏è IMPORTANT: Only proceed if you've verified Alice's swap exists!`, 'warning');
            log(`   Continuing without verification...`, 'info');
            log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
            
            // We can't verify, so we'll let the user proceed at their own risk
            // They should verify via CLI before proceeding
            // For safety, we'll still try to estimate a reasonable timelock
            const assumedAliceRemainingMins = 60; // Assume Alice has ~60 mins left
            
            if (timelockMins >= assumedAliceRemainingMins) {
                log(`‚ö†Ô∏è Your timelock (${timelockMins}m) may be too long`, 'warning');
                log(`Recommended: Set timelock to 30 minutes or less`, 'info');
            }
            
            // Skip the swap status/expiration checks since we can't verify via extension
            // The user should verify via CLI before proceeding

            // ========== CHECK FOR DUPLICATE ON ETHERLINK ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Checking for duplicates on Etherlink...`;
            
            const existingEthSwap = await verifySwapOnEtherlink(hashlock);
            if (existingEthSwap.valid && existingEthSwap.swap) {
                log(`‚ùå A swap with this HashLock already exists on Etherlink!`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                return;
            }
            log('‚úì HashLock is unique on Etherlink', 'success');

            // ========== CONNECT ETHERLINK IF NEEDED ==========
            if (!state.contract) {
                log('Connecting to Etherlink...', 'warning');
                const connected = await connectEtherlink();
                if (!connected) {
                    log('‚ùå Failed to connect to Etherlink', 'error');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                    return;
                }
            }

            // ========== INITIATE SWAP ON ETHERLINK ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Locking funds on Etherlink...`;

            try {
                const expiration = Math.floor(Date.now() / 1000) + (timelockMins * 60);
                
                // SECURITY: Bob locks on Etherlink ‚Üí Alice (recipient) must have 0x address
                // Recipient was already validated before this function was called
                const validatedAlice = getValidatedCounterparty(false); // Don't show error again
                const aliceAddress = validatedAlice || ethers.constants.AddressZero;
                
                if (validatedAlice) {
                    log(`üîí Recipient (Alice): ${aliceAddress.substring(0, 12)}...`, 'info');
                } else {
                    log(`‚ö†Ô∏è Warning: No recipient set - anyone with secret can claim!`, 'warning');
                }
                
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                log(`üîê BOB MATCHE SUR ETHERLINK`, 'warning');
                log(`Amount: ${amount} XTZ`, 'info');
                log(`HashLock: ${hashlock.substring(0, 18)}...`, 'info');
                log(`Expiration: ${new Date(expiration * 1000).toLocaleTimeString()} (${timelockMins} mins)`, 'info');
                if (aliceAddress !== ethers.constants.AddressZero) {
                    log(`Recipient (Alice): ${aliceAddress.substring(0, 10)}...`, 'info');
                }
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'system');
                
                log('Sending transaction to Etherlink...', 'warning');
                
                const tx = await state.contract.initiateSwap(
                    aliceAddress, // recipient - Only Alice can claim (or anyone if not set)
                    hashlock, // hashLock
                    expiration,
                    { value: ethers.utils.parseEther(amount) }
                );
                
                logTx(tx.hash, 'Transaction sent');
                log('Waiting for confirmation...', 'warning');
                
                const receipt = await tx.wait();
                
                // Store for later
                state.currentSwapId = hashlock;
                state.hash = hashlock;
                
                log(`üéâ SWAP MATCHED SUCCESSFULLY ON ETHERLINK!`, 'success');
                logTx(receipt.hash || tx.hash, '‚úÖ Confirmed');
                log(`üí∞ Funds locked: ${amount} XTZ on Etherlink`, 'success');
                
                updateProgress(3);
                
                // Pre-fill values for redeem tab
                prefillRedeemForm(state.hash, null);
                
                // Show match success popup!
                const explorerUrl = `https://testnet.explorer.etherlink.com/tx/${receipt.hash || tx.hash}`;
                showSuccessModal({
                    type: 'match',
                    title: 'ü§ù Swap Matched!',
                    subtitle: 'Wait for Alice to claim, then use the secret',
                    amount: amount,
                    token: 'XTZ',
                    chain: 'etherlink',
                    sender: state.etherlinkAddress,
                    hashlock: hashlock,
                    txHash: receipt.hash || tx.hash,
                    explorerUrl: explorerUrl,
                    extraActions: [{
                        label: 'üëÄ Watch for Secret',
                        onClick: `closeSuccessModal()`,
                        primary: true
                    }]
                });
                
                btn.innerHTML = `<span>üîë Watching for Secret...</span><i class="fa-solid fa-spinner fa-spin ml-2"></i>`;
                
                setTimeout(() => {
                    log("Ready to claim on Jstz (when Alice reveals the secret)", 'system');
                    btn.disabled = false;
                    
                    // Alice locked on Jstz, Bob locked on Etherlink
                    // Watch Etherlink for Alice to claim (reveal secret)
                    startSecretPolling(hashlock, 'jstz');
                }, 2000);

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
            }
        }

        // Alice claims on Jstz (reveals secret)
        async function claimOnJstz() {
            const btn = document.getElementById('main-action-btn');
            const hashLock = state.currentSwapId || state.hash;
            const secret = state.secret;
            
            // ========== SECURITY CHECKS ==========
            
            // 1. Validate inputs
            if (!hashLock || !isValidHashLock(hashLock)) {
                log('‚ùå Invalid or missing HashLock', 'error');
                return;
            }
            
            if (!secret) {
                log('‚ùå Secret is required to claim', 'error');
                return;
            }
            
            // 2. Verify secret matches the hashlock
            if (!verifySecretMatchesHash(secret, hashLock)) {
                log('‚ùå Secret does not match HashLock!', 'error');
                log('The provided secret hash does not equal the hashlock', 'error');
                return;
            }
            log('‚úì Secret matches HashLock', 'success');
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying swap on Jstz...`;
            
            // 3. Try to verify swap exists on Jstz (may fail due to extension limitation)
            log('Verifying swap exists on Jstz...', 'warning');
            const verification = await verifySwapOnJstz(hashLock);
            
            if (!verification.valid) {
                // Can't verify - but allow to proceed anyway (Jstz will reject if invalid)
                log(`‚ö†Ô∏è Cannot auto-verify: ${verification.error}`, 'warning');
                log('Proceeding anyway - Jstz will reject if swap does not exist', 'info');
            }
            
            // Only check swap details if verification succeeded
            if (verification.valid && verification.swap) {
                const swap = verification.swap;
                log(`‚úì Swap found on Jstz: ${swap.amount} XTZ locked`, 'success');
                
                // 4. Check if swap is already claimed or refunded (Jstz uses string status)
                if (swap.status === 'CLAIMED') {
                    log('‚ùå Swap has already been claimed!', 'error');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Claim on Jstz</span>`;
                    return;
                }
                
                if (swap.status === 'REFUNDED') {
                    log('‚ùå Swap has been refunded!', 'error');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Claim on Jstz</span>`;
                    return;
                }
                
                // 5. Check timelock hasn't expired
                if (swap.isExpired) {
                    log('‚ùå Swap has expired! Cannot claim after timelock.', 'error');
                    log(`Expired at: ${swap.expirationDate}`, 'info');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Claim on Jstz</span>`;
                    return;
                }
                log(`‚úì Timelock valid until: ${swap.expirationDate}`, 'success');
            } else {
                log(`‚ö†Ô∏è Skipping swap validation (will be checked by Jstz)`, 'warning');
            }
            
            // ========== EXECUTE CLAIM ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Claiming on Jstz...`;

            try {
                log(`Claiming on Jstz with secret...`, 'warning');
                log(`Secret: ${secret.substring(0, 18)}...`, 'system');
                
                // Call Jstz smart function to claim
                log(`Calling Jstz HTLC: /claim`, 'system');
                
                const response = await jstzRequest('POST', '/claim', {
                    hashlock: hashLock,
                    secret: secret
                }, { forceWallet: true });
                
                // Handle CLI fallback
                if (response && response.cliRequired) {
                    log(`‚ö†Ô∏è Complete the claim using the CLI command in the popup`, 'warning');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Claim on Jstz</span>`;
                    return;
                }
                
                // Check for errors (contract-level or operation-level)
                if (!response.success || response.error) {
                    const errorMsg = response.error || response.message?.error || 'Claim failed';
                    throw new Error(errorMsg);
                }
                
                // Extract amount from response if available
                const claimData = response?.message?.data || response?.message || {};
                const claimedAmount = claimData.amount || claimData.amountXtz || '?';
                const claimerAddress = state.jstzAddress || 'unknown';
                const truncatedAddress = claimerAddress.length > 10 
                    ? `${claimerAddress.substring(0, 8)}...${claimerAddress.slice(-4)}`
                    : claimerAddress;
                
                log(`‚úÖ Claimed on Jstz!`, 'success');
                log(`Secret revealed: ${secret.substring(0, 18)}...`, 'system');
                log(`üí∞ ${truncatedAddress} received ${claimedAmount} XTZ`, 'success');
                
                updateProgress(4);
                
                btn.innerHTML = `<i class="fa-solid fa-check-circle"></i> Swap Complete`;
                btn.classList.add('bg-ether-green', 'text-black');
                btn.disabled = true;
                
                // Show celebration popup!
                showSuccessModal({
                    type: 'claim',
                    title: 'üéâ Funds Claimed!',
                    subtitle: 'Your atomic swap is complete',
                    amount: claimedAmount,
                    token: 'XTZ',
                    chain: 'jstz',
                    recipient: claimerAddress,
                    hashlock: hashLock,
                    txHash: response.operationHash,
                    explorerUrl: `https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}`
                });

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Claim on Jstz</span>`;
            }
        }

        // ============================================
        // SWAP VERIFICATION FUNCTIONS
        // ============================================
        
        // Swap states enum (matching Solidity contract)
        // Must match Solidity enum: enum SwapStatus { OPEN, CLAIMED, REFUNDED }
        const SwapState = {
            OPEN: 0,       // Swap is active, funds locked
            CLAIMED: 1,    // Swap was claimed
            REFUNDED: 2    // Swap was refunded after expiration
        };
        
        // Verify swap exists and is in correct state on Etherlink
        // Uses read-only provider to avoid changing wallet connection state
        async function verifySwapOnEtherlink(swapId, expectedState = null) {
            try {
                // Use read-only provider to check swap without connecting wallet
                const rpcUrl = NETWORK_CONFIG[128123].rpcUrl;
                const htlcAddress = NETWORK_CONFIG[128123].htlcAddress;
                
                console.log('[VERIFY] Using RPC:', rpcUrl);
                console.log('[VERIFY] Contract address:', htlcAddress);
                console.log('[VERIFY] Swap ID:', swapId);
                
                const readOnlyProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                const readOnlyContract = new ethers.Contract(
                    htlcAddress,
                    CONFIG.etherlink.abi,
                    readOnlyProvider
                );
                
                console.log('[VERIFY] Checking swap on Etherlink (read-only)...');
                const swap = await readOnlyContract.getSwap(swapId);
                console.log('[VERIFY] Raw swap result:', swap);
                
                console.log('[VERIFY] Swap data:', {
                    sender: swap.sender,
                    recipient: swap.recipient,
                    amount: swap.amount?.toString(),
                    hashLock: swap.hashLock,
                    expiration: swap.expiration?.toString(),
                    status: swap.status
                });
                
                // Check if swap exists (sender is not zero address)
                if (swap.sender === ethers.constants.AddressZero) {
                    return { 
                        valid: false, 
                        error: 'Swap does not exist on Etherlink',
                        swap: null
                    };
                }
                
                // Check status if expected state provided (OPEN=0, CLAIMED=1, REFUNDED=2)
                if (expectedState !== null && swap.status !== expectedState) {
                    const stateNames = ['OPEN', 'CLAIMED', 'REFUNDED'];
                    return {
                        valid: false,
                        error: `Swap is ${stateNames[swap.status]}, expected ${stateNames[expectedState]}`,
                        swap
                    };
                }
                
                // Check expiration for claim (must not be expired)
                const now = Math.floor(Date.now() / 1000);
                const isExpired = now >= swap.expiration.toNumber();
                
                return {
                    valid: true,
                    swap: {
                        sender: swap.sender,
                        recipient: swap.recipient,
                        amount: ethers.utils.formatEther(swap.amount),
                        hashLock: swap.hashLock,
                        expiration: swap.expiration.toNumber(),
                        expirationDate: new Date(swap.expiration.toNumber() * 1000).toLocaleString(),
                        status: swap.status,
                        isExpired
                    }
                };
                
            } catch (error) {
                console.error('[VERIFY] Error:', error);
                return { 
                    valid: false, 
                    error: `Failed to verify swap: ${error.message}` 
                };
            }
        }
        
        // Verify swap exists and is in correct state on Jstz
        // NOTE: Jstz requires signed transactions even for reads, so we can't verify without CLI
        async function verifySwapOnJstz(hashLock) {
            console.log('[VERIFY] Checking swap on Jstz:', hashLock);
            
            // Since Jstz requires signatures even for reads, we return "cannot verify"
            // and let the user proceed (they'll get an error from Jstz if swap doesn't exist)
            log(`‚ö†Ô∏è Cannot verify Jstz swap without CLI (extension limitation)`, 'warning');
            log(`üí° Use CLI to verify: jstz run "jstz://${CONFIG.jstz.contractAddress}/swap/${hashLock}" -n privatenet -m POST -d '{}'`, 'system');
            
            // Return "unknown" state - let the user proceed
            return {
                valid: false,
                cannotVerify: true,
                error: 'Cannot verify Jstz swap via extension - use CLI',
                swap: null
            };
        }
        
        // Try to verify swap on Jstz via direct API/KV read
        async function verifySwapOnJstzDirect(hashLock) {
            console.log('[VERIFY-DIRECT] Attempting direct Jstz swap verification:', hashLock);
            
            const contractAddress = CONFIG.jstz.contractAddress;
            const rpcUrl = CONFIG.jstz.rpcUrl;
            
            // Try multiple methods to read the swap data
            
            // Method 1: Try the KV API directly (if available)
            try {
                const kvKey = hashLock.startsWith('0x') ? hashLock.slice(2) : hashLock;
                const kvUrl = `${rpcUrl}/kv/${contractAddress}/${kvKey}`;
                console.log('[VERIFY-DIRECT] Trying KV API:', kvUrl);
                
                const kvResponse = await fetch(kvUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (kvResponse.ok) {
                    const kvData = await kvResponse.json();
                    console.log('[VERIFY-DIRECT] KV response:', kvData);
                    
                    if (kvData) {
                        const swap = typeof kvData === 'string' ? JSON.parse(kvData) : kvData;
                        return { valid: true, swap };
                    }
                }
            } catch (e) {
                console.log('[VERIFY-DIRECT] KV API not available:', e.message);
            }
            
            // Method 2: Try the smart function's /swap/:hashlock endpoint directly
            try {
                const swapUrl = `${rpcUrl}/run?uri=jstz://${contractAddress}/swap/${hashLock}`;
                console.log('[VERIFY-DIRECT] Trying run endpoint:', swapUrl);
                
                const swapResponse = await fetch(swapUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (swapResponse.ok) {
                    const result = await swapResponse.json();
                    console.log('[VERIFY-DIRECT] Run response:', result);
                    
                    if (result.found && result.swap) {
                        return { valid: true, swap: result.swap };
                    }
                }
            } catch (e) {
                console.log('[VERIFY-DIRECT] Run endpoint not available:', e.message);
            }
            
            // Method 3: Try dashboard API
            try {
                const dashboardUrl = `https://privatenet.dashboard.jstz.info/api/smart-functions/${contractAddress}/kv`;
                console.log('[VERIFY-DIRECT] Trying dashboard API:', dashboardUrl);
                
                const dashResponse = await fetch(dashboardUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (dashResponse.ok) {
                    const kvData = await dashResponse.json();
                    console.log('[VERIFY-DIRECT] Dashboard KV response:', kvData);
                    
                    // Look for the swap key
                    const kvKey = hashLock.startsWith('0x') ? hashLock.slice(2) : hashLock;
                    if (kvData && kvData[kvKey]) {
                        const swap = typeof kvData[kvKey] === 'string' ? JSON.parse(kvData[kvKey]) : kvData[kvKey];
                        return { valid: true, swap };
                    }
                }
            } catch (e) {
                console.log('[VERIFY-DIRECT] Dashboard API not available:', e.message);
            }
            
            // All methods failed
            console.log('[VERIFY-DIRECT] All direct verification methods failed');
            return {
                valid: false,
                cannotVerify: true,
                error: 'Could not verify Jstz swap directly',
                swap: null
            };
        }
        
        // ============================================
        // SKIP JSTZ VERIFICATION (for CLI users)
        // ============================================
        
        function skipJstzVerification() {
            const hashInput = document.getElementById('hash-input');
            const hashLock = hashInput.value.trim();
            
            if (!isValidHashLock(hashLock)) {
                log("‚ùå Please enter a valid HashLock first", 'error');
                return;
            }
            
            // Show the custom CLI verification modal
            showCliVerifyModal(hashLock);
        }
        
        // ============================================
        // VERIFY VIA JSTZ WALLET (temporary connection)
        // ============================================
        
        async function verifyViaJstzWallet() {
            const verifyJstzBtn = document.getElementById('verify-jstz-btn');
            const aliceDetails = document.getElementById('alice-swap-details');
            const actionBtn = document.getElementById('main-action-btn');
            
            // Always read from input field (not state) to get the latest hashlock
            const hashInput = document.getElementById('hash-input');
            const hashLock = hashInput.value.trim();
            
            if (!hashLock || !isValidHashLock(hashLock)) {
                log("‚ùå Please enter a valid HashLock (0x followed by 64 hex characters)", 'error');
                return;
            }
            
            // Update state with latest hashlock
            state.pendingJstzVerifyHashlock = hashLock;
            
            verifyJstzBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i> Connecting...`;
            verifyJstzBtn.disabled = true;
            
            log("üîê Connecting to Jstz wallet for verification...", 'warning');
            
            try {
                // Check if Jstz extension is installed
                if (!isJstzExtensionInstalled()) {
                    log("‚ùå Jstz wallet extension not detected", 'error');
                    log(`<a href="https://github.com/jstz-dev/dev-wallet/releases" target="_blank" class="text-blue-400 underline">Install Jstz Wallet Extension</a>`, 'info');
                    
                    // Fallback to CLI
                    log(`<code class="bg-black/50 px-2 py-1 rounded text-xs">jstz run "jstz://${CONFIG.jstz.contractAddress}/swap/${hashLock}" -n privatenet -m POST -d '{}'</code>`, 'system');
                    
                    verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Connect Jstz to Verify`;
                    verifyJstzBtn.disabled = false;
                    return;
                }
                
                log("üì° Requesting swap data from Jstz via wallet...", 'warning');
                
                // Call the smart function to get swap details (force wallet to bypass read-only check)
                const result = await jstzRequest('POST', `/swap/${hashLock}`, {}, { forceWallet: true });
                
                console.log('[VERIFY-JSTZ] Result:', result);
                
                if (result.success && result.message) {
                    let swapData = result.message;
                    
                    // Parse if string
                    if (typeof swapData === 'string') {
                        try {
                            swapData = JSON.parse(swapData);
                        } catch (e) {
                            console.log('[VERIFY-JSTZ] Could not parse response:', swapData);
                        }
                    }
                    
                    // Check if swap was found
                    if (swapData.found && swapData.swap) {
                        const swap = swapData.swap;
                        
                        log(`‚úÖ Alice's swap verified on Jstz!`, 'success');
                        
                        // Update UI with swap details
                        const amountXtz = swap.amount || (swap.amountMutez ? swap.amountMutez / 1000000 : 0);
                        document.getElementById('alice-swap-amount').textContent = `${amountXtz} XTZ`;
                        
                        // Calculate remaining time
                        const now = Math.floor(Date.now() / 1000);
                        const remaining = swap.expiration - now;
                        if (remaining > 0) {
                            const mins = Math.floor(remaining / 60);
                            const secs = remaining % 60;
                            document.getElementById('alice-swap-expiry').textContent = `${mins}m ${secs}s remaining`;
                            log(`‚è∞ Expires in ${mins} minutes`, 'info');
                        } else {
                            document.getElementById('alice-swap-expiry').textContent = 'EXPIRED';
                            document.getElementById('alice-swap-expiry').classList.add('text-red-400');
                        }
                        
                        document.getElementById('alice-swap-sender').textContent = swap.sender ? 
                            `${swap.sender.substring(0, 8)}...${swap.sender.substring(swap.sender.length - 6)}` : 'Unknown';
                        document.getElementById('alice-swap-chain').textContent = 'Jstz';
                        document.getElementById('alice-swap-status').textContent = swap.status || 'OPEN';
                        document.getElementById('alice-swap-status').className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/20 text-green-400';
                        
                        // Store verified swap data
                        state.aliceSwapVerified = true;
                        state.aliceSwapData = swap;
                        
                        if (swap.status === 'OPEN' && remaining > 0) {
                            // Enable match button
                            actionBtn.innerHTML = `<span>Match Swap on Etherlink</span><i class="fa-solid fa-arrow-right"></i>`;
                            actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-ether-green text-black shadow-lg flex items-center justify-center gap-2 hover:brightness-110 transition-all";
                            actionBtn.disabled = false;
                            
                            // Auto-adjust timelock
                            const suggestedTimelock = Math.max(5, Math.floor(remaining / 120));
                            document.getElementById('timelock-input').value = suggestedTimelock;
                            log(`‚öôÔ∏è Suggested timelock: ${suggestedTimelock} minutes (half of Alice's remaining time)`, 'system');
                            
                            log(`üí° Now switch back to your EVM wallet/Etherlink to match the swap!`, 'success');
                        } else {
                            log(`‚ùå Cannot match: swap is ${swap.status}${remaining <= 0 ? ' (expired)' : ''}`, 'error');
                            actionBtn.disabled = true;
                        }
                        
                        // Hide verify button, show success state
                        verifyJstzBtn.innerHTML = `<i class="fa-solid fa-check mr-1"></i> Verified`;
                        verifyJstzBtn.className = "hidden px-3 py-2 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 text-xs font-bold whitespace-nowrap";
                        verifyJstzBtn.disabled = true;
                        
                    } else if (swapData.found === false) {
                        log(`‚ùå Swap not found on Jstz with this hashlock`, 'error');
                        document.getElementById('alice-swap-status').textContent = 'NOT FOUND';
                        document.getElementById('alice-swap-status').className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-red-500/20 text-red-400';
                        
                        verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Retry`;
                        verifyJstzBtn.disabled = false;
                    } else {
                        log(`‚ö†Ô∏è Unexpected response format`, 'warning');
                        console.log('[VERIFY-JSTZ] Unexpected response:', swapData);
                        
                        verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Retry`;
                        verifyJstzBtn.disabled = false;
                    }
                } else {
                    log(`‚ùå Failed to verify: ${result.error || 'Unknown error'}`, 'error');
                    
                    if (result.cliRequired) {
                        // CLI modal already shown
                    }
                    
                    verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Retry`;
                    verifyJstzBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('[VERIFY-JSTZ] Error:', error);
                log(`‚ùå Error verifying swap: ${error.message}`, 'error');
                
                verifyJstzBtn.innerHTML = `<i class="fa-solid fa-wallet mr-1"></i> Retry`;
                verifyJstzBtn.disabled = false;
            }
        }
        
        // ============================================
        // VERIFY ALICE SWAP DETAILS (for Bob in Join mode)
        // ============================================
        
        async function verifyAliceSwapDetails() {
            const hashInput = document.getElementById('hash-input');
            const hashLock = hashInput.value.trim();
            const verifyBtn = document.getElementById('verify-swap-btn');
            const aliceDetails = document.getElementById('alice-swap-details');
            const actionBtn = document.getElementById('main-action-btn');
            
            if (!isValidHashLock(hashLock)) {
                log("‚ùå Please enter a valid HashLock (0x followed by 64 hex characters)", 'error');
                return;
            }
            
            verifyBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Verifying...`;
            verifyBtn.disabled = true;
            
            // IMPORTANT: In Join mode, state.chain indicates WHERE BOB WILL MATCH
            // So Alice's swap is on the OPPOSITE chain!
            // - Bob matches on Jstz (state.chain === 'jstz') ‚Üí Alice initiated on Etherlink
            // - Bob matches on Etherlink (state.chain === 'etherlink') ‚Üí Alice initiated on Jstz
            const aliceChain = state.chain === 'jstz' ? 'Etherlink' : 'Jstz';
            
            log(`üîç Verifying Alice's swap on ${aliceChain}...`, 'warning');
            
            try {
                let result;
                let chain;
                
                // Bob matches on Jstz ‚Üí Alice's swap is on Etherlink
                // Bob matches on Etherlink ‚Üí Alice's swap is on Jstz
                if (state.chain === 'jstz') {
                    // Bob will match on Jstz, verify Alice on Etherlink
                    result = await verifySwapOnEtherlink(hashLock, SwapState.OPEN);
                    chain = 'Etherlink';
                } else {
                    // Bob will match on Etherlink, Alice on Jstz - try direct HTTP read
                    log("üîç Attempting to verify Jstz swap via direct API...", 'warning');
                    
                    // Try to read swap data directly from Jstz
                    const jstzResult = await verifySwapOnJstzDirect(hashLock);
                    
                    if (jstzResult.valid && jstzResult.swap) {
                        // Successfully read swap data!
                        const swap = jstzResult.swap;
                        chain = 'Jstz';
                        
                        aliceDetails.classList.remove('hidden');
                        
                        // Display amount (could be in mutez or XTZ)
                        const amountXtz = swap.amountXtz || (swap.amountMutez ? swap.amountMutez / 1000000 : swap.amount);
                        document.getElementById('alice-swap-amount').textContent = `${amountXtz} XTZ`;
                        
                        // Calculate remaining time
                        const now = Math.floor(Date.now() / 1000);
                        const remaining = swap.expiration - now;
                        if (remaining > 0) {
                            const mins = Math.floor(remaining / 60);
                            const secs = remaining % 60;
                            document.getElementById('alice-swap-expiry').textContent = `${mins}m ${secs}s remaining`;
                        } else {
                            document.getElementById('alice-swap-expiry').textContent = 'EXPIRED';
                            document.getElementById('alice-swap-expiry').classList.add('text-red-400');
                        }
                        
                        document.getElementById('alice-swap-sender').textContent = swap.sender || 'Unknown';
                        document.getElementById('alice-swap-chain').textContent = 'Jstz';
                        document.getElementById('alice-swap-status').textContent = swap.status || 'OPEN';
                        document.getElementById('alice-swap-status').className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/20 text-green-400';
                        
                        if (swap.status === 'OPEN' && remaining > 0) {
                            state.aliceSwapVerified = true;
                            state.aliceSwapData = swap;
                            
                            actionBtn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                            actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-ether-green text-black shadow-lg flex items-center justify-center gap-2 hover:brightness-110 transition-all";
                            actionBtn.disabled = false;
                            
                            log(`‚úÖ Alice's swap verified on Jstz! Amount: ${amountXtz} XTZ`, 'success');
                            log(`‚è∞ Expires in ${Math.floor(remaining / 60)} minutes`, 'info');
                            
                            // Auto-adjust timelock
                            const suggestedTimelock = Math.max(5, Math.floor(remaining / 120));
                            document.getElementById('timelock-input').value = suggestedTimelock;
                            log(`‚öôÔ∏è Auto-set your timelock to ${suggestedTimelock} minutes`, 'system');
                        } else {
                            log(`‚ùå Cannot match: swap is ${swap.status}${remaining <= 0 ? ' (expired)' : ''}`, 'error');
                            actionBtn.disabled = true;
                        }
                        
                        verifyBtn.innerHTML = `<i class="fa-solid fa-magnifying-glass mr-1"></i> Verify`;
                        verifyBtn.disabled = false;
                        return;
                    }
                    
                    // Fallback: couldn't read directly, show Jstz wallet button
                    log("üí° Connect your Jstz wallet to verify Alice's swap", 'warning');
                    
                    // Store hashlock for later use
                    state.pendingJstzVerifyHashlock = hashLock;
                    
                    // Show the "Connect Jstz to Verify" button AND "I verified via CLI" button
                    const verifyJstzBtn = document.getElementById('verify-jstz-btn');
                    const skipVerifyBtn = document.getElementById('skip-verify-btn');
                    verifyJstzBtn.classList.remove('hidden');
                    skipVerifyBtn.classList.remove('hidden');
                    verifyBtn.classList.add('hidden');
                    
                    // Show placeholder details
                    aliceDetails.classList.remove('hidden');
                    document.getElementById('alice-swap-amount').textContent = '? XTZ';
                    document.getElementById('alice-swap-expiry').textContent = 'Verify via wallet or CLI';
                    document.getElementById('alice-swap-sender').textContent = 'Unknown';
                    document.getElementById('alice-swap-chain').textContent = 'Jstz';
                    document.getElementById('alice-swap-status').textContent = 'PENDING VERIFICATION';
                    document.getElementById('alice-swap-status').className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-purple-500/20 text-purple-400';
                    
                    // Disable match button until verified
                    state.aliceSwapVerified = false;
                    actionBtn.innerHTML = `<span>Verify First</span><i class="fa-solid fa-lock"></i>`;
                    actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-gray-600 text-gray-400 shadow-lg flex items-center justify-center gap-2 cursor-not-allowed";
                    actionBtn.disabled = true;
                    
                    verifyBtn.innerHTML = `<i class="fa-solid fa-magnifying-glass mr-1"></i> Verify`;
                    verifyBtn.disabled = false;
                    return;
                }
                
                if (!result.valid) {
                    log(`‚ùå ${result.error}`, 'error');
                    aliceDetails.classList.add('hidden');
                    state.aliceSwapVerified = false;
                    
                    verifyBtn.innerHTML = `<i class="fa-solid fa-magnifying-glass mr-1"></i> Verify`;
                    verifyBtn.disabled = false;
                    return;
                }
                
                // Show Alice's swap details
                const swap = result.swap;
                aliceDetails.classList.remove('hidden');
                
                document.getElementById('alice-swap-amount').textContent = `${swap.amount} XTZ`;
                
                // Calculate remaining time
                const now = Math.floor(Date.now() / 1000);
                const remaining = swap.expiration - now;
                if (remaining > 0) {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    document.getElementById('alice-swap-expiry').textContent = `${mins}m ${secs}s remaining`;
                } else {
                    document.getElementById('alice-swap-expiry').textContent = 'EXPIRED';
                    document.getElementById('alice-swap-expiry').classList.add('text-red-400');
                }
                
                document.getElementById('alice-swap-sender').textContent = swap.sender;
                document.getElementById('alice-swap-chain').textContent = chain;
                document.getElementById('alice-swap-status').textContent = ['OPEN', 'CLAIMED', 'REFUNDED'][swap.status];
                
                if (swap.status === 0 && remaining > 0) {
                    // Valid and open - enable Match Swap
                    state.aliceSwapVerified = true;
                    state.aliceSwapData = swap;
                    
                    actionBtn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
                    actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-jstz-accent text-black shadow-lg flex items-center justify-center gap-2 hover:brightness-110 transition-all";
                    actionBtn.disabled = false;
                    
                    log(`‚úÖ Alice's swap verified! Amount: ${swap.amount} XTZ`, 'success');
                    log(`‚è∞ Expires: ${swap.expirationDate}`, 'info');
                    log(`üí° Set your timelock shorter than Alice's remaining time (${Math.floor(remaining / 60)} mins)`, 'warning');
                    
                    // Auto-adjust timelock to be half of Alice's remaining time
                    const suggestedTimelock = Math.max(5, Math.floor(remaining / 120)); // Half, min 5 mins
                    document.getElementById('timelock-input').value = suggestedTimelock;
                    log(`‚öôÔ∏è Auto-set your timelock to ${suggestedTimelock} minutes`, 'system');
                    
                } else {
                    log(`‚ùå Cannot match: swap is ${['OPEN', 'CLAIMED', 'REFUNDED'][swap.status]}${remaining <= 0 ? ' (expired)' : ''}`, 'error');
                    actionBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('[VERIFY] Error:', error);
                log(`‚ùå Verification failed: ${error.message}`, 'error');
                aliceDetails.classList.add('hidden');
            }
            
            verifyBtn.innerHTML = `<i class="fa-solid fa-magnifying-glass mr-1"></i> Verify`;
            verifyBtn.disabled = false;
        }
        
        function cancelJoinSwap() {
            const aliceDetails = document.getElementById('alice-swap-details');
            const actionBtn = document.getElementById('main-action-btn');
            const hashInput = document.getElementById('hash-input');
            
            // Hide details
            aliceDetails.classList.add('hidden');
            
            // Reset state
            state.aliceSwapVerified = false;
            state.aliceSwapData = null;
            
            // Clear hash input
            hashInput.value = '';
            hashInput.focus();
            
            // Reset button
            actionBtn.innerHTML = `<span>Verify Swap First</span><i class="fa-solid fa-magnifying-glass"></i>`;
            actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-blue-500/50 text-white shadow-lg flex items-center justify-center gap-2 cursor-not-allowed opacity-70";
            actionBtn.disabled = true;
            
            log("üîÑ Cancelled. Enter a new HashLock to verify.", 'info');
        }
        
        // Validate hashlock format
        function isValidHashLock(hashLock) {
            if (!hashLock) return false;
            // Must be 0x followed by 64 hex characters (32 bytes)
            return /^0x[a-fA-F0-9]{64}$/.test(hashLock);
        }
        
        // Validate secret matches hashlock using SHA-256 (cross-chain compatible)
        function verifySecretMatchesHash(secret, hashLock) {
            if (!secret || !hashLock) return false;
            try {
                const computedHash = ethers.utils.sha256(secret);
                const matches = computedHash.toLowerCase() === hashLock.toLowerCase();
                console.log('[VERIFY] Secret verification (SHA-256):', {
                    secret: secret.substring(0, 18) + '...',
                    computedHash,
                    expectedHash: hashLock,
                    matches
                });
                return matches;
            } catch (error) {
                console.error('[VERIFY] Secret verification error:', error);
                return false;
            }
        }

        // Pre-fill Redeem/Refund form
        function prefillRedeemForm(swapId, secret) {
            const swapIdInput = document.getElementById('swap-id-input');
            const secretInput = document.getElementById('secret-input-claim');
            
            if (swapIdInput && swapId) {
                swapIdInput.value = swapId;
            }
            if (secretInput && secret) {
                secretInput.value = secret;
            }
            
            // Optional: auto-switch to redeem tab? Maybe too intrusive.
            // setTab('redeem');
            log('Swap details saved for Redeem/Refund tab', 'info');
        }

        // ============================================
        // MY SWAPS FUNCTIONALITY
        // ============================================
        
        // Store loaded swaps
        state.mySwaps = [];
        let swapTimerInterval = null;
        
        // Status labels and colors
        // Note: Status 2 in contract means REFUNDED (after refundSwap was called)
        const SWAP_STATUS = {
            0: { label: 'OPEN', color: 'text-green-400', bg: 'bg-green-400/20', icon: 'fa-lock' },
            1: { label: 'CLAIMED', color: 'text-blue-400', bg: 'bg-blue-400/20', icon: 'fa-check-circle' },
            2: { label: 'REFUNDED', color: 'text-orange-400', bg: 'bg-orange-400/20', icon: 'fa-rotate-left' }
        };
        
        // Load all swaps for the connected address (both Etherlink and Jstz)
        async function loadMySwaps() {
            const hasEtherlink = state.contract && state.etherlinkAddress;
            const hasJstz = state.jstzAddress;
            
            if (!hasEtherlink && !hasJstz) {
                log('Connect a wallet first to see your swaps', 'warning');
                document.getElementById('swaps-empty').classList.remove('hidden');
                document.getElementById('swaps-list').innerHTML = '';
                document.getElementById('swaps-loading').classList.add('hidden');
                return;
            }
            
            const loadingEl = document.getElementById('swaps-loading');
            const emptyEl = document.getElementById('swaps-empty');
            const listEl = document.getElementById('swaps-list');
            
            loadingEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            listEl.innerHTML = '';
            
            // Load Etherlink swaps (only if connected)
            if (hasEtherlink && state.provider) {
            try {
                console.log('[MY SWAPS] Loading Etherlink swaps for:', state.etherlinkAddress);
                
                // Get current block number
                const currentBlock = await state.provider.getBlockNumber();
                // Search in chunks of 499 blocks (Etherlink limit is 500!)
                const CHUNK_SIZE = 499;
                const MAX_BLOCKS_BACK = 3000; // ~30 min on Etherlink
                const fromBlock = Math.max(0, currentBlock - MAX_BLOCKS_BACK);
                
                console.log('[MY SWAPS] Searching blocks', fromBlock, 'to', currentBlock);
                
                // Query in chunks to avoid RPC limits
                const filter = state.contract.filters.SwapInitiated();
                let allEvents = [];
                
                for (let start = fromBlock; start < currentBlock; start += CHUNK_SIZE) {
                    const end = Math.min(start + CHUNK_SIZE - 1, currentBlock);
                    try {
                        const events = await state.contract.queryFilter(filter, start, end);
                        allEvents = allEvents.concat(events);
                        console.log(`[MY SWAPS] Scanned blocks ${start}-${end}: ${events.length} events`);
                    } catch (e) {
                        console.warn(`[MY SWAPS] Chunk ${start}-${end} failed:`, e.message);
                    }
                }
                
                console.log('[MY SWAPS] Total events found:', allEvents.length);
                
                // Debug: show all events
                if (allEvents.length > 0) {
                    console.log('[MY SWAPS] All events:');
                    allEvents.forEach((e, i) => {
                        console.log(`  Event ${i}: sender=${e.args.sender}, recipient=${e.args.recipient}, swapId=${e.args.swapId}`);
                    });
                }
                
                // Filter events where user is sender OR recipient
                const userAddress = state.etherlinkAddress.toLowerCase();
                console.log('[MY SWAPS] Looking for user address:', userAddress);
                
                const userEvents = allEvents.filter(e => {
                    const senderMatch = e.args.sender.toLowerCase() === userAddress;
                    const recipientMatch = e.args.recipient.toLowerCase() === userAddress;
                    return senderMatch || recipientMatch;
                });
                
                console.log('[MY SWAPS] User events:', userEvents.length);
                
                // Get unique swap IDs
                const uniqueSwapIds = [...new Set(userEvents.map(e => e.args.swapId))];
                
                // Also fetch SwapRefunded and SwapClaimed events to get tx hashes
                const refundFilter = state.contract.filters.SwapRefunded();
                const claimFilter = state.contract.filters.SwapClaimed();
                let refundEvents = [];
                let claimEvents = [];
                
                for (let start = fromBlock; start < currentBlock; start += CHUNK_SIZE) {
                    const end = Math.min(start + CHUNK_SIZE - 1, currentBlock);
                    try {
                        const refunds = await state.contract.queryFilter(refundFilter, start, end);
                        const claims = await state.contract.queryFilter(claimFilter, start, end);
                        refundEvents = refundEvents.concat(refunds);
                        claimEvents = claimEvents.concat(claims);
                    } catch (e) {
                        // Silently continue
                    }
                }
                
                // Create lookup maps for tx hashes
                const refundTxMap = {};
                refundEvents.forEach(e => {
                    refundTxMap[e.args.swapId] = e.transactionHash;
                });
                
                const claimTxMap = {};
                claimEvents.forEach(e => {
                    claimTxMap[e.args.swapId] = e.transactionHash;
                });
                
                console.log('[MY SWAPS] Found swap IDs:', uniqueSwapIds);
                
                // Get current details for each swap
                state.mySwaps = [];
                for (const swapId of uniqueSwapIds) {
                    try {
                        const [recipient, sender, amount, expiration, hashLock, status] = await state.contract.getSwap(swapId);
                        
                        // Only include if not zero address (swap exists)
                        if (sender !== ethers.constants.AddressZero) {
                            state.mySwaps.push({
                                swapId,
                                recipient,
                                sender,
                                amount: ethers.utils.formatEther(amount),
                                expiration: expiration.toNumber(),
                                hashLock,
                                status,
                                isInitiator: sender.toLowerCase() === state.etherlinkAddress.toLowerCase(),
                                refundTxHash: refundTxMap[swapId] || null,
                                claimTxHash: claimTxMap[swapId] || null
                            });
                        }
                    } catch (e) {
                        console.warn('[MY SWAPS] Error fetching swap:', swapId, e);
                    }
                }
                
                // Sort by expiration (closest first)
                state.mySwaps.sort((a, b) => a.expiration - b.expiration);
                
                // Add chain identifier
                state.mySwaps = state.mySwaps.map(s => ({ ...s, chain: 'etherlink' }));
                
            } catch (error) {
                console.error('[MY SWAPS] Etherlink error:', error);
                log(`Error loading Etherlink swaps: ${error.message}`, 'error');
            }
            } else {
                // No Etherlink connection, reset swaps
                state.mySwaps = [];
            }
            
            // Also load Jstz swaps if connected
            if (state.jstzAddress) {
                try {
                    log('Loading Jstz swaps...', 'system');
                    const jstzSwaps = await loadJstzSwaps();
                    state.jstzSwaps = jstzSwaps;
                    console.log('[MY SWAPS] Jstz swaps loaded:', jstzSwaps.length);
                } catch (error) {
                    console.error('[MY SWAPS] Jstz error:', error);
                    log(`Error loading Jstz swaps: ${error.message}`, 'warning');
                }
            }
            
            // Combine all swaps
            const allSwaps = [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
            allSwaps.sort((a, b) => a.expiration - b.expiration);
            
            loadingEl.classList.add('hidden');
            
            if (allSwaps.length === 0) {
                emptyEl.classList.remove('hidden');
                const addresses = [state.etherlinkAddress, state.jstzAddress].filter(Boolean).map(a => a.substring(0, 10) + '...');
                log(`No swaps found for ${addresses.join(' / ')}`, 'info');
            } else {
                emptyEl.classList.add('hidden');
                renderSwapsList(allSwaps);
                startSwapTimers();
                checkSwapAlerts(); // Check for notifications
                log(`Found ${allSwaps.length} swap(s) (${state.mySwaps?.length || 0} Etherlink, ${state.jstzSwaps?.length || 0} Jstz)`, 'success');
            }
        }
        
        // Load swaps from Jstz
        async function loadJstzSwaps() {
            if (!state.jstzAddress) return [];
            
            // Skip if wallet extension not available (don't show modal)
            if (!isJstzExtensionInstalled()) {
                console.log('[JSTZ SWAPS] Extension not available, skipping');
                return [];
            }
            
            try {
                // Call the /swaps endpoint to get all swaps (silent to avoid popup spam)
                const result = await jstzRequest('POST', '/swaps', {}, { forceWallet: true, silent: true });
                
                console.log('[JSTZ SWAPS] Result:', result);
                
                if (result.success && result.message) {
                    let swapsData = result.message;
                    
                    if (typeof swapsData === 'string') {
                        try {
                            swapsData = JSON.parse(swapsData);
                        } catch (e) {
                            console.log('[JSTZ SWAPS] Could not parse:', e);
                            return [];
                        }
                    }
                    
                    console.log('[JSTZ SWAPS] Parsed data:', swapsData);
                    
                    // Handle both array and object formats
                    let swapsArray = [];
                    if (Array.isArray(swapsData)) {
                        swapsArray = swapsData;
                    } else if (swapsData.swaps && Array.isArray(swapsData.swaps)) {
                        swapsArray = swapsData.swaps;
                    } else if (typeof swapsData === 'object') {
                        // Single swap object
                        swapsArray = [swapsData];
                    }
                    
                    console.log('[JSTZ SWAPS] Swaps array:', swapsArray);
                    
                    // Filter swaps for current user
                    const userAddress = state.jstzAddress.toLowerCase();
                    
                    const userSwaps = swapsArray.filter(s => {
                        const isUserSwap = s.sender?.toLowerCase() === userAddress || 
                                          s.recipient?.toLowerCase() === userAddress;
                        return isUserSwap;
                    });
                    
                    console.log('[JSTZ SWAPS] User swaps:', userSwaps.length);
                    
                    // Format swaps to match Etherlink format (include ALL statuses for history)
                    return userSwaps.map(swap => ({
                        swapId: swap.hashlock,
                        hashLock: swap.hashlock,
                        sender: swap.sender,
                        recipient: swap.recipient,
                        amount: swap.amountXtz || swap.amount || (swap.amountMutez ? swap.amountMutez / 1000000 : 0),
                        expiration: swap.expiration,
                        status: swap.status === 'OPEN' ? 0 : swap.status === 'CLAIMED' ? 1 : 2,
                        isInitiator: swap.sender?.toLowerCase() === userAddress,
                        chain: 'jstz',
                        revealedSecret: swap.revealedSecret || null,
                        claimedBy: swap.claimedBy || null,
                        claimedAt: swap.claimedAt || null
                    }));
                }
                
                return [];
            } catch (error) {
                console.error('[JSTZ SWAPS] Error:', error);
                return [];
            }
        }
        
        // Render all swaps in the list (separated by Active and History)
        function renderSwapsList(swaps = null) {
            const listEl = document.getElementById('swaps-list');
            const allSwaps = swaps || [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
            
            // Separate active (status 0 = OPEN) from history (status 1 = CLAIMED, 2 = REFUNDED)
            const activeSwaps = allSwaps.filter(s => s.status === 0);
            const historySwaps = allSwaps.filter(s => s.status !== 0);
            
            // Sort: active by expiration (closest first), history by most recent
            activeSwaps.sort((a, b) => a.expiration - b.expiration);
            historySwaps.sort((a, b) => (b.claimedAt || b.expiration) - (a.claimedAt || a.expiration));
            
            let html = '';
            
            // Active swaps section
            if (activeSwaps.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-bolt"></i> Active Swaps (${activeSwaps.length})
                        </h4>
                        <div class="space-y-3">
                            ${activeSwaps.map(swap => renderSwapCard(swap)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // History section
            if (historySwaps.length > 0) {
                html += `
                    <div class="${activeSwaps.length > 0 ? 'mt-6 pt-6 border-t border-white/10' : ''}">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left"></i> History (${historySwaps.length})
                        </h4>
                        <div class="space-y-3 opacity-80">
                            ${historySwaps.map(swap => renderSwapCard(swap)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Empty state
            if (allSwaps.length === 0) {
                html = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-regular fa-folder-open text-4xl mb-3 block"></i>
                        <p>No swaps found</p>
                        <p class="text-xs mt-1">Initiate or join a swap to see it here</p>
                    </div>
                `;
            }
            
            listEl.innerHTML = html;
        }
        
        // Render a single swap card
        function renderSwapCard(swap) {
            const statusInfo = SWAP_STATUS[swap.status] || SWAP_STATUS[0];
            const now = Math.floor(Date.now() / 1000);
            const isExpired = now >= swap.expiration;
            const timeRemaining = swap.expiration - now;
            
            // Format addresses
            const formatAddr = (addr) => addr ? `${addr.substring(0, 6)}...${addr.slice(-4)}` : '?';
            const senderAddr = formatAddr(swap.sender);
            const recipientAddr = swap.recipient && swap.recipient !== '0x0000000000000000000000000000000000000000' 
                ? formatAddr(swap.recipient) : 'Any';
            
            // Role display with address
            const roleIcon = swap.isInitiator ? 'fa-paper-plane' : 'fa-inbox';
            const roleText = swap.isInitiator ? `Sender: ${senderAddr}` : `Receiver: ${recipientAddr}`;
            const roleColor = swap.isInitiator ? 'text-ether-green' : 'text-jstz-accent';
            
            // Chain info
            const isJstz = swap.chain === 'jstz';
            const chainBadge = isJstz ? 
                '<span class="px-2 py-1 rounded-md text-xs font-bold text-jstz-accent bg-jstz-accent/20"><i class="fa-solid fa-bolt mr-1"></i>Jstz</span>' :
                '<span class="px-2 py-1 rounded-md text-xs font-bold text-ether-green bg-ether-green/20"><i class="fa-brands fa-ethereum mr-1"></i>Etherlink</span>';
            
            // Get explorer URL based on chain
            const networkConfig = NETWORK_CONFIG[state.currentChainId];
            const explorerUrl = isJstz ? 
                `https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}` :
                (networkConfig?.explorer || '');
            
            // Determine tx hash to show (refund or claim)
            const txHash = swap.refundTxHash || swap.claimTxHash;
            const txType = swap.refundTxHash ? 'Refund' : (swap.claimTxHash ? 'Claim' : null);
            
            // Border color based on chain
            const borderClass = isJstz ? 'border-jstz-accent/30 hover:border-jstz-accent/60' : 'border-white/10 hover:border-white/20';
            
            return `
                <div class="bg-gradient-to-r ${isJstz ? 'from-jstz-accent/5' : 'from-white/5'} to-transparent rounded-xl p-4 border ${borderClass} transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2 flex-wrap">
                            ${chainBadge}
                            <span class="px-2 py-1 rounded-md text-xs font-bold ${statusInfo.color} ${statusInfo.bg}">
                                <i class="fa-solid ${statusInfo.icon} mr-1"></i>
                                ${statusInfo.label}
                            </span>
                            <span class="text-xs ${roleColor} font-medium font-mono"><i class="fa-solid ${roleIcon} mr-1"></i>${roleText}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-white">${parseFloat(swap.amount).toFixed(4)} XTZ</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-xs">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">${isJstz ? 'HashLock' : 'Swap ID'}:</span>
                            <div class="flex items-center gap-2">
                                <code class="text-gray-300 font-mono">${swap.swapId.substring(0, 12)}...${swap.swapId.slice(-8)}</code>
                                <button onclick="copySwapId('${swap.swapId}')" class="text-gray-500 hover:text-white transition" title="Copy">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                ${explorerUrl ? `
                                <a href="${explorerUrl}" target="_blank" class="text-gray-500 hover:text-${isJstz ? 'jstz-accent' : 'ether-green'} transition" title="View on ${isJstz ? 'Dashboard' : 'Explorer'}">
                                    <i class="fa-solid fa-external-link"></i>
                                </a>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">${swap.isInitiator ? 'To' : 'From'}:</span>
                            <code class="text-gray-300 font-mono">${swap.isInitiator ? recipientAddr : senderAddr}</code>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">Timelock:</span>
                            <span id="timer-${swap.swapId.substring(0, 10)}" class="${isExpired ? 'text-red-400' : 'text-yellow-400'} font-mono">
                                ${formatTimeRemaining(timeRemaining)}
                            </span>
                        </div>
                        
                        ${txHash && !isJstz ? `
                        <div class="flex items-center justify-between mt-2 pt-2 border-t border-white/5">
                            <span class="text-gray-500">${txType} TX:</span>
                            <a href="${explorerUrl}/tx/${txHash}" target="_blank" class="flex items-center gap-1 text-ether-green hover:underline">
                                <code class="font-mono">${txHash.substring(0, 8)}...${txHash.slice(-6)}</code>
                                <i class="fa-solid fa-external-link text-[10px]"></i>
                            </a>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${swap.status === 0 ? `
                    <div class="mt-3 pt-3 border-t border-white/10 flex gap-2">
                        ${isExpired && swap.isInitiator ? `
                        <button onclick="quickRefund('${swap.swapId}', '${swap.chain || 'etherlink'}')" class="flex-1 py-2 rounded-lg text-xs font-semibold bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white transition">
                            <i class="fa-solid fa-rotate-left mr-1"></i>
                            Refund on ${isJstz ? 'Jstz' : 'Etherlink'}
                        </button>
                        ` : `
                        <button onclick="useSwapInRedeem('${swap.swapId}', '${swap.chain || 'etherlink'}')" class="flex-1 py-2 rounded-lg text-xs font-semibold ${isJstz ? 'bg-jstz-accent/20 hover:bg-jstz-accent/30 text-jstz-accent' : 'bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white'} transition">
                            <i class="fa-solid fa-arrow-right-to-bracket mr-1"></i>
                            ${swap.isInitiator ? 'View Details' : 'Claim on ' + (isJstz ? 'Jstz' : 'Etherlink')}
                        </button>
                        `}
                    </div>
                    ` : ''}
                    
                    ${swap.revealedSecret ? `
                    <div class="mt-3 p-3 rounded-xl bg-gradient-to-r from-green-500/20 to-emerald-500/10 border border-green-500/40 ${swap.status === 0 ? 'animate-pulse-slow' : ''}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-green-400 font-bold uppercase tracking-wider">
                                <i class="fa-solid fa-key mr-1"></i>${swap.status === 1 ? 'Secret Used' : 'Secret Available!'}
                            </span>
                            <button onclick="copySecret('${swap.revealedSecret}')" class="text-xs px-2 py-1 rounded bg-green-500/20 hover:bg-green-500/30 text-green-300 transition">
                                <i class="fa-regular fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <code class="text-xs text-green-200 font-mono break-all block ${swap.status === 0 ? 'mb-3' : ''} bg-black/30 p-2 rounded">${swap.revealedSecret}</code>
                        ${swap.status === 0 ? `
                        <button onclick="claimWithSecret('${swap.swapId}', '${swap.revealedSecret}', '${swap.chain === 'jstz' ? 'etherlink' : 'jstz'}')" 
                            class="w-full py-2 rounded-lg text-sm font-bold bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white shadow-lg shadow-green-500/30 transition flex items-center justify-center gap-2 mt-3">
                            <i class="fa-solid fa-gift"></i>
                            Claim on ${swap.chain === 'jstz' ? 'Etherlink' : 'Jstz'} Now!
                        </button>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Format time remaining
        function formatTimeRemaining(seconds) {
            if (seconds <= 0) return 'EXPIRED';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }
        
        // Start timers to update countdown
        function startSwapTimers() {
            // Clear existing interval
            if (swapTimerInterval) {
                clearInterval(swapTimerInterval);
            }
            if (state.notificationCheckInterval) {
                clearInterval(state.notificationCheckInterval);
            }
            
            // Update every second
            swapTimerInterval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const allSwaps = [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
                allSwaps.forEach(swap => {
                    const timerEl = document.getElementById(`timer-${swap.swapId.substring(0, 10)}`);
                    if (timerEl) {
                        const remaining = swap.expiration - now;
                        timerEl.textContent = formatTimeRemaining(remaining);
                        timerEl.className = remaining <= 0 ? 'text-red-400 font-mono' : 
                                           remaining < 300 ? 'text-orange-400 font-mono animate-pulse' : 
                                           'text-yellow-400 font-mono';
                    }
                });
            }, 1000);
            
            // Check for alerts every 30 seconds
            state.notificationCheckInterval = setInterval(() => {
                checkSwapAlerts();
            }, 30000);
        }
        
        // Copy swap ID to clipboard
        function copySwapId(swapId) {
            navigator.clipboard.writeText(swapId);
            log(`Copied Swap ID: ${swapId.substring(0, 18)}...`, 'success');
        }
        
        // Use swap in Redeem tab
        function useSwapInRedeem(swapId, chain = 'etherlink') {
            const allSwaps = [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
            const swap = allSwaps.find(s => s.swapId === swapId);
            if (swap) {
                document.getElementById('swap-id-input').value = swapId;
                
                // Store chain info for later use
                document.getElementById('swap-id-input').dataset.chain = chain;
                
                // If user is initiator and has the secret stored, pre-fill it
                if (swap.isInitiator && state.secret && state.hash === swapId) {
                    document.getElementById('secret-input-claim').value = state.secret;
                }
                
                setTab('redeem');
                log(`Loaded ${chain.toUpperCase()} swap ${swapId.substring(0, 12)}... into Redeem tab`, 'info');
            }
        }
        
        // Quick refund directly from My Swaps
        async function quickRefund(swapId, chain = 'etherlink') {
            const allSwaps = [...(state.mySwaps || []), ...(state.jstzSwaps || [])];
            const swap = allSwaps.find(s => s.swapId === swapId);
            if (!swap) {
                log('Swap not found', 'error');
                return;
            }
            
            // Use custom modal instead of confirm()
            const modalText = document.getElementById('confirm-modal-text');
            const modalBtn = document.getElementById('confirm-modal-btn');
            
            modalText.innerText = `Refund ${swap.amount} XTZ from ${chain.toUpperCase()} swap ${swapId.substring(0, 8)}...?`;
            
            // Set up confirm action
            modalBtn.onclick = async () => {
                closeConfirmModal();
                if (chain === 'jstz') {
                    await performJstzRefund(swapId, swap.amount);
                } else {
                    await performRefund(swapId, swap.amount);
                }
            };
            
            openConfirmModal();
        }
        
        // Refund on Jstz
        async function performJstzRefund(hashlock, amount) {
            try {
                log(`Refunding Jstz swap ${hashlock.substring(0, 12)}...`, 'info');
                
                const result = await jstzRequest('POST', '/refund', { hashlock }, { forceWallet: true });
                
                if (result.success) {
                    log(`‚úÖ Jstz refund successful!`, 'success');
                    log(`${amount} XTZ returned to your wallet`, 'success');
                    addNotification('success', 'Refund Complete', `${amount} XTZ returned from Jstz`, hashlock, 'jstz');
                    
                    // Reload swaps
                    setTimeout(() => loadMySwaps(), 2000);
                } else {
                    log(`‚ùå Jstz refund failed: ${result.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Jstz Refund error:', error);
                log(`‚ùå Jstz refund error: ${error.message}`, 'error');
            }
        }
        
        async function performRefund(swapId, amount) {
            if (!state.contract || !state.signer) {
                log('Connect Etherlink wallet first!', 'error');
                return;
            }
            
            try {
                log(`Refunding swap ${swapId.substring(0, 12)}...`, 'info');
                
                const tx = await state.contract.refundSwap(swapId);
                logTx(tx.hash, 'üì§ Transaction sent');
                
                const receipt = await tx.wait();
                log(`‚úÖ Refund successful!`, 'success');
                logTx(tx.hash, '‚úÖ Refund confirmed');
                log(`${amount} XTZ returned to your wallet`, 'success');
                
                // Show success modal with link
                const networkConfig = NETWORK_CONFIG[state.currentChainId];
                if (networkConfig?.explorer) {
                    const txUrl = `${networkConfig.explorer}/tx/${tx.hash}`;
                    showSuccessNotification(amount, tx.hash, txUrl);
                }
                
                // Reload swaps to update the list
                setTimeout(() => loadMySwaps(), 2000);
                
            } catch (error) {
                console.error('Refund error:', error);
                if (error.message.includes('NotYetExpired')) {
                    log('‚ùå Swap has not expired yet', 'error');
                } else if (error.message.includes('OnlySender')) {
                    log('‚ùå Only the original sender can refund', 'error');
                } else if (error.message.includes('SwapNotActive')) {
                    log('‚ùå Swap is no longer active (already claimed or refunded)', 'error');
                } else {
                    log(`‚ùå Refund failed: ${error.message}`, 'error');
                }
            }
        }
        
        // Success notification with tx link
        function showSuccessNotification(amount, txHash, txUrl) {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            const text = document.getElementById('confirm-modal-text');
            const btn = document.getElementById('confirm-modal-btn');
            
            // Update modal for success state
            content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-check text-3xl text-green-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Refund Successful!</h3>
                    <p class="text-gray-400 text-sm mb-4">${amount} XTZ has been returned to your wallet</p>
                    <div class="bg-black/30 rounded-lg p-3 text-xs">
                        <p class="text-gray-500 mb-1">Transaction Hash:</p>
                        <code class="text-ether-green font-mono">${txHash.substring(0, 20)}...${txHash.slice(-8)}</code>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeConfirmModal(); resetConfirmModal();" class="py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all">
                        Close
                    </button>
                    <a href="${txUrl}" target="_blank" class="py-3 px-4 rounded-xl bg-gradient-to-r from-ether-green to-emerald-500 text-black font-bold text-center transition-all hover:opacity-90">
                        <i class="fa-solid fa-external-link mr-1"></i>
                        View TX
                    </a>
                </div>
            `;
            
            openConfirmModal();
        }
        
        // Reset modal to default state
        function resetConfirmModal() {
            const content = document.getElementById('confirm-modal-content');
            content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-rotate-left text-2xl text-red-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Confirm Refund</h3>
                    <p class="text-gray-400 text-sm" id="confirm-modal-text">Are you sure you want to refund this swap?</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeConfirmModal()" class="py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all">
                        Cancel
                    </button>
                    <button id="confirm-modal-btn" class="py-3 px-4 rounded-xl bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold shadow-lg shadow-red-500/20 transition-all">
                        Confirm Refund
                    </button>
                </div>
            `;
        }
        
        // Modal Helpers
        function openConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.style.display = 'flex';
            // Small delay for transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }
        
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Unified claim function
        async function claimSwap() {
            const swapId = document.getElementById('swap-id-input')?.value || state.currentSwapId || state.hash;
            const secret = document.getElementById('secret-input-claim')?.value || state.secret;
            
            if (!swapId) {
                log('Please enter a Swap ID / HashLock', 'error');
                return;
            }
            
            if (!secret) {
                log('Please enter the secret to claim', 'error');
                return;
            }
            
            // Store for use in claim functions
            state.currentSwapId = swapId;
            state.secret = secret;
            
            // Determine which chain to claim on based on CONNECTED WALLET
            if (state.connectedWallet === 'etherlink') {
                // Connected to Etherlink (EVM wallet) ‚Üí Claim on Etherlink
                log('üìç Connected to Etherlink - claiming on Etherlink...', 'warning');
                await claimOnEtherlink();
            } else if (state.connectedWallet === 'jstz') {
                // Connected to Jstz ‚Üí Claim on Jstz
                log('üìç Connected to Jstz - claiming on Jstz...', 'warning');
                await claimOnJstz();
            } else {
                log('‚ùå Please connect a wallet first (Etherlink or Jstz)', 'error');
                return;
            }
        }
        
        // Unified refund function
        async function refundSwap() {
            const swapId = document.getElementById('swap-id-input')?.value || state.currentSwapId || state.hash;
            
            if (!swapId) {
                log('Please enter a Swap ID / HashLock', 'error');
                return;
            }
            
            state.currentSwapId = swapId;
            
            // Determine which chain to refund on based on CONNECTED WALLET
            if (state.connectedWallet === 'etherlink') {
                log('üìç Connected to Etherlink - refunding on Etherlink...', 'warning');
                await refundOnEtherlink();
            } else if (state.connectedWallet === 'jstz') {
                log('üìç Connected to Jstz - refunding on Jstz...', 'warning');
                await refundOnJstz();
            } else {
                log('‚ùå Please connect a wallet first (Etherlink or Jstz)', 'error');
                return;
            }
        }
        
        // Refund on Etherlink (after timelock expires)
        async function refundOnEtherlink() {
            const swapId = document.getElementById('swap-id-input')?.value || state.currentSwapId || state.hash;
            
            // ========== SECURITY CHECKS ==========
            
            // 1. Validate swap ID
            if (!swapId || !isValidHashLock(swapId)) {
                log('‚ùå Invalid or missing Swap ID', 'error');
                return;
            }
            state.currentSwapId = swapId;
            
            if (!state.contract) {
                const connected = await connectEtherlink();
                if (!connected) return;
            }
            
            if (!state.contract) {
                log('‚ùå HTLC contract not available', 'error');
                return;
            }
            
            const btn = document.getElementById('refund-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;
            
            // 2. Verify swap exists on Etherlink and is ACTIVE
            log('Verifying swap on Etherlink...', 'warning');
            const verification = await verifySwapOnEtherlink(swapId, SwapState.OPEN);
            
            if (!verification.valid) {
                log(`‚ùå ${verification.error}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i><span>Refund</span>`;
                return;
            }
            
            const swap = verification.swap;
            log(`‚úì Swap found: ${swap.amount} XTZ`, 'success');
            
            // 3. Verify caller is the original sender (can only refund your own swap)
            if (swap.sender.toLowerCase() !== state.etherlinkAddress.toLowerCase()) {
                log('‚ùå Only the original sender can refund this swap', 'error');
                log(`Sender: ${swap.sender}`, 'info');
                log(`Your address: ${state.etherlinkAddress}`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i><span>Refund</span>`;
                return;
            }
            log('‚úì You are the original sender', 'success');
            
            // 4. Check timelock HAS expired (required for refund)
            if (!swap.isExpired) {
                const now = Math.floor(Date.now() / 1000);
                const remaining = swap.expiration - now;
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                log(`‚ùå Cannot refund yet - timelock has not expired`, 'error');
                log(`Time remaining: ${mins}m ${secs}s`, 'warning');
                log(`Expires at: ${swap.expirationDate}`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i><span>Refund</span>`;
                return;
            }
            log('‚úì Timelock has expired, refund allowed', 'success');
            
            // ========== EXECUTE REFUND ==========
            try {
                log('Executing refund on Etherlink...', 'warning');
                log(`Swap ID: ${swapId.substring(0, 18)}...`, 'info');
                
                const tx = await state.contract.refundSwap(swapId);
                logTx(tx.hash, 'üì§ Transaction sent');
                
                const receipt = await tx.wait();
                
                if (receipt.status !== 1) {
                    throw new Error('Transaction failed on-chain');
                }
                
                log('‚úÖ Refund successful on Etherlink!', 'success');
                logTx(tx.hash, '‚úÖ Refund confirmed');
                log(`${swap.amount} XTZ returned to your wallet`, 'success');
                
                // hideClaimRefundSection(); // No longer needed in redeem tab
                updateProgress(1);
                
                // Show success popup!
                const explorerUrl = `https://testnet.explorer.etherlink.com/tx/${tx.hash}`;
                showSuccessModal({
                    type: 'refund',
                    title: 'üí∏ Funds Refunded!',
                    subtitle: 'Your locked funds have been returned',
                    amount: swap.amount,
                    token: 'XTZ',
                    chain: 'etherlink',
                    recipient: state.etherlinkAddress,
                    hashlock: swapId,
                    txHash: tx.hash,
                    explorerUrl: explorerUrl
                });
                
            } catch (error) {
                let errorMsg = error.message;
                if (error.message.includes('NotYetExpired') || error.message.includes('not yet expired')) {
                    errorMsg = 'Timelock has not expired yet';
                } else if (error.message.includes('OnlySender') || error.message.includes('not sender')) {
                    errorMsg = 'Only the original sender can refund';
                } else if (error.message.includes('SwapNotActive')) {
                    errorMsg = 'Swap is not active (already claimed or refunded)';
                }
                log(`‚ùå Refund error: ${errorMsg}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i><span>Refund</span>`;
            }
        }
        
        // Refund on Jstz
        async function refundOnJstz() {
            const hashLock = document.getElementById('swap-id-input')?.value || state.currentSwapId || state.hash;
            
            // ========== SECURITY CHECKS ==========
            
            // 1. Validate hashlock
            if (!hashLock || !isValidHashLock(hashLock)) {
                log('‚ùå Invalid or missing HashLock', 'error');
                return;
            }
            state.currentSwapId = hashLock;
            
            const btn = document.getElementById('refund-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;
            
            // ========== EXECUTE REFUND ==========
            // Note: The smart contract will verify:
            // - Swap exists
            // - Swap is not already claimed/refunded  
            // - Timelock has expired
            // - Caller is the original sender
            log('Executing refund on Jstz...', 'warning');
            log(`HashLock: ${hashLock.substring(0, 16)}...`, 'info');
            
            try {
                const response = await jstzRequest('POST', '/refund', {
                    hashlock: hashLock
                }, { forceWallet: true });
                
                // Handle CLI fallback
                if (response && response.cliRequired) {
                    log(`‚ö†Ô∏è Complete the refund using the CLI command in the popup`, 'warning');
                    return;
                }
                
                // Check for errors (contract-level or operation-level)
                if (!response.success || response.error) {
                    const errorMsg = response.error || response.message?.error || 'Refund failed';
                    throw new Error(errorMsg);
                }
                
                log('‚úÖ Refund successful on Jstz!', 'success');
                
                // Parse response to get amount if available
                const refundData = response.message?.data || {};
                const refundAmount = refundData.amount || refundData.amountXtz || 'Unknown';
                log(`${refundAmount} XTZ returned to your wallet`, 'success');
                
                addNotification('success', 'Refund Complete', 'Jstz refund successful', hashLock, 'jstz');
                updateProgress(1);
                
                // Show success popup!
                showSuccessModal({
                    type: 'refund',
                    title: 'üí∏ Funds Refunded!',
                    subtitle: 'Your locked funds have been returned',
                    amount: refundAmount,
                    token: 'XTZ',
                    chain: 'jstz',
                    recipient: state.jstzAddress,
                    hashlock: hashLock,
                    txHash: response.operationHash,
                    explorerUrl: `https://privatenet.dashboard.jstz.info/smart-functions/${CONFIG.jstz.contractAddress}`
                });
                
                // Reload swaps
                setTimeout(() => loadMySwaps(), 2000);
                
            } catch (error) {
                log(`‚ùå Refund error: ${error.message}`, 'error');
                log('The swap may not exist, may have already been refunded, or timelock may not have expired yet.', 'warning');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i><span>Refund</span>`;
            }
        }

        // Bob claims on Etherlink (uses revealed secret)
        async function claimOnEtherlink() {
            const btn = document.getElementById('main-action-btn');
            const swapId = state.currentSwapId || state.hash;
            
            // ========== SECURITY CHECKS ==========
            
            // 1. Validate swap ID
            if (!swapId || !isValidHashLock(swapId)) {
                log('‚ùå Invalid or missing Swap ID', 'error');
                return;
            }
            
            // 2. Get secret (prompt if not available)
            let secret = state.secret;
            if (!secret) {
                secret = document.getElementById('secret-input-claim')?.value;
            }
            if (!secret) {
                secret = prompt("Enter the revealed secret (0x...):");
                if (!secret) {
                    log("‚ùå Secret is required to claim", 'error');
                    return;
                }
            }
            state.secret = secret;
            
            // 3. Verify secret format
            if (!isValidHashLock(secret)) {
                log('‚ùå Invalid secret format (must be 0x + 64 hex chars)', 'error');
                return;
            }
            
            // 4. Verify secret matches the hashlock
            if (!verifySecretMatchesHash(secret, swapId)) {
                log('‚ùå Secret does not match Swap ID (HashLock)!', 'error');
                log('Make sure you have the correct secret from Alice', 'error');
                return;
            }
            log('‚úì Secret matches HashLock', 'success');

            if (!state.contract) {
                const connected = await connectEtherlink();
                if (!connected) return;
            }
            
            if (!state.contract) {
                log('‚ùå HTLC contract not available', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying swap on Etherlink...`;
            
            // 5. Verify swap exists on Etherlink and is ACTIVE
            log('Verifying swap exists on Etherlink...', 'warning');
            const verification = await verifySwapOnEtherlink(swapId, SwapState.OPEN);
            
            if (!verification.valid) {
                log(`‚ùå ${verification.error}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Claim on Etherlink</span>`;
                return;
            }
            
            const swap = verification.swap;
            log(`‚úì Swap found: ${swap.amount} XTZ locked by ${swap.sender.substring(0,10)}...`, 'success');
            
            // 6. Check timelock hasn't expired
            if (swap.isExpired) {
                log('‚ùå Swap has expired! Cannot claim after timelock.', 'error');
                log(`Expired at: ${swap.expirationDate}`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<span>Claim on Etherlink</span>`;
                return;
            }
            log(`‚úì Timelock valid until: ${swap.expirationDate}`, 'success');
            
            // ========== EXECUTE CLAIM ==========
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Claiming on Etherlink...`;

            try {
                log(`Claiming on Etherlink with secret...`, 'warning');
                
                // Convert secret to bytes
                const secretBytes = ethers.utils.arrayify(secret);
                
                const tx = await state.contract.claimSwap(swapId, secretBytes);

                logTx(tx.hash, 'üì§ Transaction sent');
                
                const receipt = await tx.wait();
                
                // Verify transaction was successful
                if (receipt.status !== 1) {
                    throw new Error('Transaction failed on-chain');
                }
                
                const claimerAddr = state.etherlinkAddress || 'unknown';
                const truncatedClaimer = claimerAddr.length > 10 
                    ? `${claimerAddr.substring(0, 8)}...${claimerAddr.slice(-4)}`
                    : claimerAddr;
                
                log(`‚úÖ Claimed on Etherlink!`, 'success');
                logTx(tx.hash, '‚úÖ Claim confirmed');
                log(`üí∞ ${truncatedClaimer} received ${swap.amount} XTZ`, 'success');
                
                updateProgress(4);
                
                btn.innerHTML = `<i class="fa-solid fa-check-circle"></i> Swap Complete`;
                btn.classList.add('bg-green-500');
                btn.disabled = true;
                
                // Show celebration popup!
                const explorerUrl = `https://testnet.explorer.etherlink.com/tx/${tx.hash}`;
                showSuccessModal({
                    type: 'claim',
                    title: 'üéâ Funds Claimed!',
                    subtitle: 'Your atomic swap is complete',
                    amount: swap.amount,
                    token: 'XTZ',
                    chain: 'etherlink',
                    recipient: claimerAddr,
                    hashlock: swapId,
                    txHash: tx.hash,
                    explorerUrl: explorerUrl
                });

            } catch (error) {
                // Parse contract revert reasons
                let errorMsg = error.message;
                if (error.message.includes('SwapNotActive')) {
                    errorMsg = 'Swap is not active (already claimed or refunded)';
                } else if (error.message.includes('InvalidHashLock')) {
                    errorMsg = 'Invalid secret - does not match hashlock';
                } else if (error.message.includes('SwapExpired')) {
                    errorMsg = 'Swap has expired';
                }
                log(`‚ùå Error: ${errorMsg}`, 'error');
                btn.disabled = false;
                btn.innerHTML = `<span>Claim on Etherlink</span>`;
            }
        }

        // Main action dispatcher
        async function executeAction() {
            if (state.mode === 'create') {
                // ALICE INITIATES - creates new swap with her secret
                if (state.connectedWallet === 'etherlink') {
                    // Alice locks on Etherlink, Bob will match on Jstz
                    await initiateAsAliceOnEtherlink();
                } else if (state.connectedWallet === 'jstz') {
                    // Alice locks on Jstz, Bob will match on Etherlink
                    await initiateAsAliceOnJstz();
                } else {
                    log('‚ùå Please connect a wallet first', 'error');
                }
            } else {
                // BOB JOINS - matches existing swap with Alice's hash
                // Check if swap was verified first
                if (!state.aliceSwapVerified) {
                    log("‚ö†Ô∏è Please verify Alice's swap first by clicking the 'Verify' button", 'warning');
                    return;
                }
                
                if (state.connectedWallet === 'jstz') {
                    // Alice locked on Etherlink, Bob matches on Jstz
                    await matchAsBobOnJstz();
                } else if (state.connectedWallet === 'etherlink') {
                    // Alice locked on Jstz, Bob matches on Etherlink
                    await matchAsBobOnEtherlink();
                } else {
                    log('‚ùå Please connect a wallet first', 'error');
                }
            }
        }
        
        // Alias for backwards compatibility
        async function initiateOnEtherlink() {
            await initiateAsAliceOnEtherlink();
        }
        
        async function initiateOnJstz() {
            await matchAsBobOnJstz();
        }

        // Legacy functions for compatibility
        async function revealSecret() {
            await claimOnJstz();
        }

        async function claimWithSecret(swapId, secret, targetChain) {
            // Pre-fill the redeem form and switch to it
            document.getElementById('swap-id-input').value = swapId;
            document.getElementById('secret-input-claim').value = secret;
            
            // Store in state
            state.currentSwapId = swapId;
            state.secret = secret;
            
            // Switch to redeem tab
            switchTab('redeem');
            
            log(`üìã Claim form pre-filled with secret!`, 'success');
            log(`üéØ Target chain: ${targetChain}`, 'info');
            log(`Click "Claim Funds" to complete the swap`, 'warning');
        }
        
        function copySecret(secret) {
            navigator.clipboard.writeText(secret).then(() => {
                log('‚úÖ Secret copied to clipboard!', 'success');
            });
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            el.select();
            navigator.clipboard.writeText(el.value);
            log(`Copied ${id} to clipboard.`, 'info');
        }

        // Init
        generateNewSecret();
        updateProgress(1);
        renderTokenDropdown(); // Initialize token dropdown
        updateCounterpartyUI(); // Initialize counterparty field with correct labels
        log("Atomic Swap ready. Connect wallets to begin.", 'system');
        log(`Etherlink Contract: ${CONFIG.etherlink.contractAddress}`, 'info');
        log(`Jstz Function: ${CONFIG.jstz.functionAddress}`, 'info');
        log(`Tokens available: ${Object.keys(TOKENS).join(', ')}`, 'info');
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            // Token dropdown
            const tokenDropdown = document.getElementById('token-dropdown');
            const assetSelector = e.target.closest('[onclick="toggleTokenSelector()"]');
            if (!assetSelector && !e.target.closest('#token-dropdown')) {
                toggleTokenSelector(false);
            }
            
            // Notification dropdown
            const notifBell = document.getElementById('notification-bell');
            const notifDropdown = document.getElementById('notification-dropdown');
            if (!e.target.closest('#notification-bell')) {
                notifDropdown?.classList.add('hidden');
            }
        });

        // Wallet Events - Real connections
        document.getElementById('wallet-etherlink').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const textEl = document.getElementById('wallet-etherlink-text');
            const balanceEl = document.getElementById('wallet-balance');
            
            // Check if already connected - toggle disconnect
            if (state.etherlinkAddress) {
                state.etherlinkAddress = null;
                state.provider = null;
                state.signer = null;
                state.contract = null;
                textEl.innerText = 'Connect Etherlink';
                balanceEl.classList.add('hidden');
                btn.classList.remove('border-ether-green', 'text-ether-green', 'bg-ether-green/10');
                updateWalletConnectionUI(null);
                updateNetworkBadge(null, 'Not Connected');
                log('Etherlink wallet disconnected', 'info');
                return;
            }
            
            // Allow dual connection for polling functionality
            // (Etherlink for transactions, Jstz for reading swap data)
            if (state.jstzAddress) {
                log('‚ÑπÔ∏è Jstz already connected - enabling dual wallet mode', 'info');
            }
            
            textEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Connecting...`;
            
            const connected = await connectEtherlink();
            
            if (connected) {
                const shortAddr = `${state.etherlinkAddress.substring(0, 6)}...${state.etherlinkAddress.slice(-4)}`;
                textEl.innerText = shortAddr;
                btn.classList.add('border-ether-green', 'text-ether-green', 'bg-ether-green/10');
                
                // Fetch and display balances
                await fetchAllBalances();
                
                // Show balance next to address
                if (state.tokenBalances['XTZ']) {
                    const xtzBalance = parseFloat(state.tokenBalances['XTZ']).toFixed(2);
                    balanceEl.innerText = `${xtzBalance} XTZ`;
                    balanceEl.classList.remove('hidden');
                }
                
                // Update token dropdown with balances
                renderTokenDropdown();
            } else {
                textEl.innerText = 'Connect Etherlink';
            }
        });

        document.getElementById('wallet-jstz').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const textEl = document.getElementById('wallet-jstz-text');
            
            // Check if already connected
            if (state.jstzAddress) {
                // Disconnect
                state.jstzAddress = null;
                textEl.innerText = 'Connect Jstz';
                btn.classList.remove('border-jstz-accent', 'text-jstz-accent', 'bg-jstz-accent/10');
                if (!state.etherlinkAddress) {
                    updateWalletConnectionUI(null);
                }
                log('Jstz wallet disconnected', 'info');
                return;
            }
            
            // Allow dual connection for polling functionality
            // (Etherlink for transactions, Jstz for reading swap data)
            
            // Jstz connection - try extension first, fallback to simulated
            try {
                if (isJstzExtensionInstalled()) {
                    log('üîê Connecting to Jstz wallet extension...', 'warning');
                    
                    const addressData = await getJstzAddress();
                    console.log('[JSTZ] Address response:', addressData);
                    
                    // Handle different response formats
                    if (typeof addressData === 'string') {
                        state.jstzAddress = addressData;
                    } else if (addressData && typeof addressData === 'object') {
                        state.jstzAddress = addressData.address || addressData.accountAddress || addressData.data?.address || JSON.stringify(addressData);
                    } else {
                        throw new Error('Invalid address response from wallet');
                    }
                    
                    // Safely create short address
                    const addr = String(state.jstzAddress);
                    const shortAddr = addr.length > 10 ? `${addr.substring(0, 6)}...${addr.slice(-3)}` : addr;
                    textEl.innerText = shortAddr;
                    btn.classList.add('border-jstz-accent', 'text-jstz-accent', 'bg-jstz-accent/10');
                    
                    updateWalletConnectionUI('jstz');
                    
                    log(`‚úÖ Jstz wallet connected: ${state.jstzAddress}`, 'success');
                    log('Transactions will be signed by your wallet extension', 'system');
                    
                    // Update network badge for Jstz
                    const jstzNetwork = CONFIG.jstz.network || 'privatenet';
                    updateNetworkBadge(`jstz-${jstzNetwork}`, `Jstz ${jstzNetwork.charAt(0).toUpperCase() + jstzNetwork.slice(1)}`);
                    
                    // Fetch Jstz balance
                    await fetchJstzBalance();
                } else {
                    // No extension - show error and install link
                    log(`‚ùå Jstz wallet extension not found`, 'error');
                    log(`üì• Install the Jstz wallet extension to continue:`, 'warning');
                    log(`<a href="https://github.com/jstz-dev/dev-wallet/releases" target="_blank" class="text-jstz-accent hover:underline font-bold">üëâ Download Jstz Wallet Extension</a>`, 'info');
                    textEl.innerText = 'Connect Jstz';
                }
            } catch (error) {
                console.error('[JSTZ] Connection error:', error);
                log(`‚ùå Jstz connection error: ${error.message}`, 'error');
                log(`üì• Make sure the Jstz wallet extension is installed and unlocked`, 'warning');
                textEl.innerText = 'Connect Jstz';
            }
        });

        // Listen for EVM wallet network/account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('chainChanged', async (chainId) => {
                const newChainId = parseInt(chainId, 16);
                console.log('[DEBUG] Network changed to chainId:', newChainId);
                log(`Network changed! Reconnecting...`, 'warning');
                
                // Reconnect with new network
                await connectEtherlink();
                await fetchAllBalances();
                renderTokenDropdown();
            });
            
            window.ethereum.on('accountsChanged', async (accounts) => {
                console.log('[DEBUG] Account changed to:', accounts[0]);
                if (accounts.length > 0) {
                    log(`Account changed! Reconnecting...`, 'warning');
                    await connectEtherlink();
                    await fetchAllBalances();
                    
                    // Update wallet button
                    const textEl = document.getElementById('wallet-etherlink-text');
                    if (textEl) {
                        const shortAddr = `${accounts[0].substring(0, 6)}...${accounts[0].slice(-4)}`;
                        textEl.innerText = shortAddr;
                    }
                } else {
                    log(`Wallet disconnected`, 'warning');
                    updateNetworkBadge(0, 'Not Connected');
                }
            });
            
            console.log('[DEBUG] EVM wallet event listeners attached');
        }

    </script>
    <!-- Notification Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center opacity-0 transition-opacity duration-300" style="display: none;">
        <div class="bg-[#111111] border border-white/10 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-300" id="confirm-modal-content">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-rotate-left text-2xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Confirm Refund</h3>
                <p class="text-gray-400 text-sm" id="confirm-modal-text">Are you sure you want to refund this swap?</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirmModal()" class="py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all">
                    Cancel
                </button>
                <button id="confirm-modal-btn" class="py-3 px-4 rounded-xl bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold shadow-lg shadow-red-500/20 transition-all">
                    Confirm Refund
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Celebration Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center" style="display: none;">
        <div id="success-modal-content" class="relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 border border-green-500/30 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl shadow-green-500/20 transform scale-95 transition-all duration-500">
            <!-- Animated particles background -->
            <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none">
                <div class="particle particle-1"></div>
                <div class="particle particle-2"></div>
                <div class="particle particle-3"></div>
                <div class="particle particle-4"></div>
                <div class="particle particle-5"></div>
                <div class="particle particle-6"></div>
            </div>
            
            <!-- Content -->
            <div class="relative z-10">
                <!-- Icon -->
                <div id="success-modal-icon" class="w-20 h-20 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/50 animate-bounce-once">
                    <i class="fa-solid fa-check text-4xl text-white"></i>
                </div>
                
                <!-- Title -->
                <h2 id="success-modal-title" class="text-2xl font-bold text-center text-white mb-2">Success!</h2>
                
                <!-- Subtitle -->
                <p id="success-modal-subtitle" class="text-center text-gray-400 mb-6">Your transaction was successful</p>
                
                <!-- Details Card -->
                <div id="success-modal-details" class="bg-black/30 rounded-2xl p-4 mb-6 border border-white/5">
                    <!-- Dynamic content inserted here -->
                </div>
                
                <!-- Action Buttons -->
                <div id="success-modal-actions" class="flex gap-3">
                    <button onclick="closeSuccessModal()" class="flex-1 py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all border border-white/10">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Success Modal Animations */
        @keyframes bounce-once {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-bounce-once {
            animation: bounce-once 0.5s ease-out;
        }
        
        @keyframes float-up {
            0% { transform: translateY(100px) scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: float-up 2s ease-out infinite;
        }
        .particle-1 { background: #22c55e; left: 10%; animation-delay: 0s; }
        .particle-2 { background: #facc15; left: 25%; animation-delay: 0.3s; }
        .particle-3 { background: #3b82f6; left: 40%; animation-delay: 0.6s; }
        .particle-4 { background: #22c55e; left: 55%; animation-delay: 0.2s; }
        .particle-5 { background: #facc15; left: 70%; animation-delay: 0.5s; }
        .particle-6 { background: #3b82f6; left: 85%; animation-delay: 0.8s; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.6); }
        }
        .glow-green {
            animation: glow-pulse 2s ease-in-out infinite;
        }
        .glow-yellow {
            animation: glow-pulse 2s ease-in-out infinite;
            --tw-shadow-color: rgba(250, 204, 21, 0.3);
        }
    </style>
    
    <!-- CLI Command Modal -->
    <div id="cli-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center" style="display: none;">
        <div class="bg-[#0a0a0a] border border-jstz-accent/30 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl shadow-jstz-accent/10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-jstz-accent/10 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-terminal text-jstz-accent"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Jstz CLI Command</h3>
                        <p class="text-xs text-gray-400">Wallet extension unavailable - use CLI instead</p>
                    </div>
                </div>
                <button onclick="closeCLIModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-300 mb-3" id="cli-modal-description">
                    The Jstz wallet extension is not responding. Run this command in your terminal:
                </p>
                
                <div class="relative">
                    <pre id="cli-modal-command" class="bg-black border border-white/10 rounded-xl p-4 text-sm text-green-400 font-mono overflow-x-auto whitespace-pre-wrap break-all"></pre>
                    <button onclick="copyCLICommand()" class="absolute top-2 right-2 px-3 py-1 bg-jstz-accent/20 hover:bg-jstz-accent/30 text-jstz-accent rounded-lg text-xs font-semibold transition-colors flex items-center gap-1">
                        <i class="fa-regular fa-copy"></i>
                        <span id="copy-cli-btn-text">Copy</span>
                    </button>
                </div>
            </div>
            
            <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-3 mb-4">
                <div class="flex items-start gap-2">
                    <i class="fa-solid fa-circle-info text-yellow-500 mt-0.5"></i>
                    <div class="text-xs text-yellow-200">
                        <strong>Instructions:</strong>
                        <ol class="list-decimal list-inside mt-1 space-y-1 text-yellow-200/80">
                            <li>Copy the command above</li>
                            <li>Open a terminal</li>
                            <li>Paste and run the command</li>
                            <li>Check the output for success/error</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-3 mb-4">
                <div class="flex items-start gap-2">
                    <i class="fa-solid fa-download text-blue-400 mt-0.5"></i>
                    <div class="text-xs text-blue-200">
                        <strong>Don't have Jstz CLI installed?</strong>
                        <p class="mt-1 text-blue-200/80">
                            Install it with: <code class="bg-blue-500/20 px-1 rounded">npm i -g @jstz-dev/cli</code>
                        </p>
                        <a href="https://jstz.tezos.com/installation" target="_blank" class="inline-flex items-center gap-1 mt-2 text-blue-400 hover:text-blue-300 underline">
                            <i class="fa-solid fa-external-link text-[10px]"></i>
                            View full installation guide
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeCLIModal()" class="flex-1 py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all">
                    Close
                </button>
                <button onclick="copyCLICommand()" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-jstz-accent to-yellow-400 hover:brightness-110 text-black font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                    <i class="fa-regular fa-copy"></i>
                    Copy Command
                </button>
            </div>
        </div>
    </div>
    
    <!-- CLI Verification Modal (for Skip Jstz Verification) -->
    <div id="cli-verify-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center" style="display: none;">
        <div class="bg-gradient-to-br from-[#0a0a0a] to-[#1a1a1a] border border-orange-500/30 rounded-2xl p-6 max-w-xl w-full mx-4 shadow-2xl shadow-orange-500/10">
            <!-- Header -->
            <div class="flex items-center justify-between mb-5">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500/20 to-yellow-500/20 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-terminal text-xl text-orange-400"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">CLI Verification</h3>
                        <p class="text-xs text-gray-400">Verify Alice's swap manually</p>
                    </div>
                </div>
                <button onclick="closeCliVerifyModal()" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Warning Banner -->
            <div class="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 mb-5">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-triangle-exclamation text-orange-400"></i>
                    </div>
                    <div>
                        <p class="text-sm text-orange-200 font-semibold mb-1">‚ö†Ô∏è Manual Verification Required</p>
                        <p class="text-xs text-orange-200/70">Only proceed if you have verified the swap details via CLI. You are responsible for checking the swap is valid.</p>
                    </div>
                </div>
            </div>
            
            <!-- CLI Command -->
            <div class="mb-5">
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Run this command to verify:</label>
                <div class="relative group">
                    <pre id="cli-verify-command" class="bg-black/50 border border-white/10 rounded-xl p-4 text-sm text-green-400 font-mono overflow-x-auto whitespace-pre-wrap break-all pr-20"></pre>
                    <button onclick="copyCliVerifyCommand()" class="absolute top-2 right-2 px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-xs font-semibold transition-all flex items-center gap-1.5 group-hover:scale-105">
                        <i class="fa-regular fa-copy"></i>
                        <span id="copy-cli-verify-text">Copy</span>
                    </button>
                </div>
            </div>
            
            <!-- Checklist -->
            <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-5">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-check"></i>
                    Verification Checklist
                </p>
                <div class="space-y-2">
                    <label class="flex items-center gap-3 text-sm text-gray-300 cursor-pointer hover:text-white transition group">
                        <input type="checkbox" id="cli-check-1" class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-orange-500 focus:ring-orange-500 focus:ring-offset-0">
                        <span class="group-hover:translate-x-0.5 transition-transform">Swap exists and status is <code class="bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded text-xs">OPEN</code></span>
                    </label>
                    <label class="flex items-center gap-3 text-sm text-gray-300 cursor-pointer hover:text-white transition group">
                        <input type="checkbox" id="cli-check-2" class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-orange-500 focus:ring-orange-500 focus:ring-offset-0">
                        <span class="group-hover:translate-x-0.5 transition-transform">Amount matches what you agreed upon</span>
                    </label>
                    <label class="flex items-center gap-3 text-sm text-gray-300 cursor-pointer hover:text-white transition group">
                        <input type="checkbox" id="cli-check-3" class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-orange-500 focus:ring-orange-500 focus:ring-offset-0">
                        <span class="group-hover:translate-x-0.5 transition-transform">Expiration gives you enough time</span>
                    </label>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="closeCliVerifyModal()" class="flex-1 py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all border border-white/10">
                    <i class="fa-solid fa-xmark mr-2"></i>Cancel
                </button>
                <button onclick="confirmCliVerification()" id="cli-verify-confirm-btn" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-orange-600 to-yellow-600 hover:from-orange-500 hover:to-yellow-500 text-white font-bold shadow-lg shadow-orange-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:from-gray-600 disabled:to-gray-600" disabled>
                    <i class="fa-solid fa-check mr-2"></i>I Verified, Continue
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // CLI Modal functions
        let pendingCliCommand = null;
        
        function showCLIModal(command, description = null) {
            const modal = document.getElementById('cli-modal');
            const commandEl = document.getElementById('cli-modal-command');
            const descEl = document.getElementById('cli-modal-description');
            
            commandEl.textContent = command;
            if (description) {
                descEl.textContent = description;
            }
            
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => modal.style.opacity = '1', 10);
        }
        
        // Show a discreet button instead of auto-popup
        function offerCliCommand(command, description = null) {
            pendingCliCommand = command;
            
            // Log a clickable link instead of auto-showing modal
            log(`<button onclick="showCLIModal('${command.replace(/'/g, "\\'")}', '${(description || 'Run this command in your terminal:').replace(/'/g, "\\'")}'); return false;" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-jstz-accent/20 hover:bg-jstz-accent/30 text-jstz-accent text-xs font-semibold transition"><i class="fa-solid fa-terminal"></i> Show CLI Command</button>`, 'info');
        }
        
        function closeCLIModal() {
            const modal = document.getElementById('cli-modal');
            modal.style.opacity = '0';
            setTimeout(() => modal.style.display = 'none', 300);
        }
        
        function copyCLICommand() {
            const commandEl = document.getElementById('cli-modal-command');
            const btnText = document.getElementById('copy-cli-btn-text');
            
            navigator.clipboard.writeText(commandEl.textContent).then(() => {
                btnText.textContent = 'Copied!';
                setTimeout(() => btnText.textContent = 'Copy', 2000);
            });
        }
        
        // ========================================
        // CLI VERIFICATION MODAL (Skip Jstz Verification)
        // ========================================
        
        let pendingCliVerifyHashlock = null;
        
        function showCliVerifyModal(hashLock) {
            pendingCliVerifyHashlock = hashLock;
            
            const modal = document.getElementById('cli-verify-modal');
            const commandEl = document.getElementById('cli-verify-command');
            const confirmBtn = document.getElementById('cli-verify-confirm-btn');
            
            // Build the CLI command
            const command = `jstz run "jstz://${CONFIG.jstz.contractAddress}/swap/${hashLock}" -n privatenet -m GET`;
            commandEl.textContent = command;
            
            // Reset checkboxes
            document.getElementById('cli-check-1').checked = false;
            document.getElementById('cli-check-2').checked = false;
            document.getElementById('cli-check-3').checked = false;
            confirmBtn.disabled = true;
            
            // Add event listeners to checkboxes
            ['cli-check-1', 'cli-check-2', 'cli-check-3'].forEach(id => {
                document.getElementById(id).onchange = updateCliVerifyButton;
            });
            
            // Show modal with animation
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => modal.style.opacity = '1', 10);
        }
        
        function updateCliVerifyButton() {
            const check1 = document.getElementById('cli-check-1').checked;
            const check2 = document.getElementById('cli-check-2').checked;
            const check3 = document.getElementById('cli-check-3').checked;
            const confirmBtn = document.getElementById('cli-verify-confirm-btn');
            
            confirmBtn.disabled = !(check1 && check2 && check3);
        }
        
        function closeCliVerifyModal() {
            const modal = document.getElementById('cli-verify-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                pendingCliVerifyHashlock = null;
            }, 300);
        }
        
        function copyCliVerifyCommand() {
            const commandEl = document.getElementById('cli-verify-command');
            const btnText = document.getElementById('copy-cli-verify-text');
            
            navigator.clipboard.writeText(commandEl.textContent).then(() => {
                btnText.textContent = 'Copied!';
                setTimeout(() => btnText.textContent = 'Copy', 2000);
            });
        }
        
        function confirmCliVerification() {
            if (!pendingCliVerifyHashlock) return;
            
            const hashLock = pendingCliVerifyHashlock;
            closeCliVerifyModal();
            
            // Mark as verified (user takes responsibility)
            state.aliceSwapVerified = true;
            state.aliceSwapChain = 'jstz';
            state.currentSwapId = hashLock;
            state.hash = hashLock;
            
            // Update UI
            const aliceDetails = document.getElementById('alice-swap-details');
            const actionBtn = document.getElementById('main-action-btn');
            const verifyJstzBtn = document.getElementById('verify-jstz-btn');
            const skipVerifyBtn = document.getElementById('skip-verify-btn');
            
            aliceDetails.classList.remove('hidden');
            document.getElementById('alice-swap-amount').textContent = '(Verified via CLI)';
            document.getElementById('alice-swap-expiry').textContent = '(Check CLI output)';
            document.getElementById('alice-swap-sender').textContent = '(Check CLI output)';
            document.getElementById('alice-swap-chain').textContent = 'Jstz';
            document.getElementById('alice-swap-status').textContent = 'CLI VERIFIED';
            document.getElementById('alice-swap-status').className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500/20 text-orange-400';
            
            // Hide verification buttons
            if (verifyJstzBtn) verifyJstzBtn.classList.add('hidden');
            if (skipVerifyBtn) skipVerifyBtn.classList.add('hidden');
            
            // Enable the main action button
            actionBtn.disabled = false;
            actionBtn.innerHTML = `<span>Match Swap</span><i class="fa-solid fa-arrow-right"></i>`;
            actionBtn.className = "w-full py-4 rounded-xl text-lg font-bold bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-400 hover:to-yellow-400 text-black shadow-lg flex items-center justify-center gap-2 transition-all";
            
            log(`‚úÖ Swap marked as verified via CLI`, 'success');
            log(`‚ö†Ô∏è You are responsible for verifying the swap details`, 'warning');
        }
        
        // ========================================
        // SUCCESS CELEBRATION MODAL
        // ========================================
        
        function showSuccessModal(config) {
            const {
                type = 'success', // 'claim', 'refund', 'initiate', 'match', 'success'
                title = 'Success!',
                subtitle = 'Your transaction was successful',
                amount = null,
                token = 'XTZ',
                chain = 'etherlink',
                txHash = null,
                hashlock = null,
                recipient = null,
                sender = null,
                explorerUrl = null,
                extraActions = [] // [{label, onClick, primary}]
            } = config;
            
            const modal = document.getElementById('success-modal');
            const content = document.getElementById('success-modal-content');
            const iconEl = document.getElementById('success-modal-icon');
            const titleEl = document.getElementById('success-modal-title');
            const subtitleEl = document.getElementById('success-modal-subtitle');
            const detailsEl = document.getElementById('success-modal-details');
            const actionsEl = document.getElementById('success-modal-actions');
            
            // Configure icon based on type
            const icons = {
                claim: { icon: 'fa-gift', gradient: 'from-yellow-400 to-orange-500', shadow: 'shadow-yellow-500/50' },
                refund: { icon: 'fa-rotate-left', gradient: 'from-blue-400 to-cyan-500', shadow: 'shadow-blue-500/50' },
                initiate: { icon: 'fa-lock', gradient: 'from-purple-400 to-pink-500', shadow: 'shadow-purple-500/50' },
                match: { icon: 'fa-handshake', gradient: 'from-green-400 to-emerald-500', shadow: 'shadow-green-500/50' },
                success: { icon: 'fa-check', gradient: 'from-green-400 to-emerald-600', shadow: 'shadow-green-500/50' }
            };
            
            const iconConfig = icons[type] || icons.success;
            iconEl.className = `w-20 h-20 rounded-full bg-gradient-to-br ${iconConfig.gradient} flex items-center justify-center mx-auto mb-6 shadow-lg ${iconConfig.shadow} animate-bounce-once`;
            iconEl.innerHTML = `<i class="fa-solid ${iconConfig.icon} text-4xl text-white"></i>`;
            
            // Update border color
            content.className = content.className.replace(/border-\w+-500\/30/g, '');
            const borderColors = {
                claim: 'border-yellow-500/30',
                refund: 'border-blue-500/30',
                initiate: 'border-purple-500/30',
                match: 'border-green-500/30',
                success: 'border-green-500/30'
            };
            content.classList.add(borderColors[type] || borderColors.success);
            
            // Set title and subtitle
            titleEl.textContent = title;
            subtitleEl.textContent = subtitle;
            
            // Build details HTML
            let detailsHtml = '<div class="space-y-3">';
            
            if (amount) {
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Amount</span>
                        <span class="text-white font-bold text-lg">${amount} ${token}</span>
                    </div>
                `;
            }
            
            if (chain) {
                const chainConfig = {
                    etherlink: { name: 'Etherlink', icon: '‚ü†', color: 'text-ether-green' },
                    jstz: { name: 'Jstz', icon: 'üü°', color: 'text-jstz-accent' }
                };
                const c = chainConfig[chain] || { name: chain, icon: 'üîó', color: 'text-white' };
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Network</span>
                        <span class="${c.color} font-semibold">${c.icon} ${c.name}</span>
                    </div>
                `;
            }
            
            if (recipient) {
                const shortRecipient = recipient.length > 16 ? `${recipient.substring(0, 8)}...${recipient.slice(-6)}` : recipient;
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Recipient</span>
                        <span class="text-white font-mono text-sm">${shortRecipient}</span>
                    </div>
                `;
            }
            
            if (sender) {
                const shortSender = sender.length > 16 ? `${sender.substring(0, 8)}...${sender.slice(-6)}` : sender;
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Sender</span>
                        <span class="text-white font-mono text-sm">${shortSender}</span>
                    </div>
                `;
            }
            
            if (hashlock) {
                const shortHash = hashlock.length > 20 ? `${hashlock.substring(0, 10)}...${hashlock.slice(-8)}` : hashlock;
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Swap ID</span>
                        <span class="text-white font-mono text-xs bg-black/30 px-2 py-1 rounded">${shortHash}</span>
                    </div>
                `;
            }
            
            if (txHash) {
                const shortTx = txHash.length > 20 ? `${txHash.substring(0, 10)}...${txHash.slice(-8)}` : txHash;
                detailsHtml += `
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Tx Hash</span>
                        <span class="text-white font-mono text-xs bg-black/30 px-2 py-1 rounded">${shortTx}</span>
                    </div>
                `;
            }
            
            detailsHtml += '</div>';
            
            // Add explorer link if available
            if (explorerUrl) {
                detailsHtml += `
                    <a href="${explorerUrl}" target="_blank" class="mt-4 flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-white transition py-2 border-t border-white/5">
                        <i class="fa-solid fa-external-link"></i>
                        View on Explorer
                    </a>
                `;
            }
            
            detailsEl.innerHTML = detailsHtml;
            
            // Build action buttons
            let actionsHtml = `
                <button onclick="closeSuccessModal()" class="flex-1 py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-gray-300 font-semibold transition-all border border-white/10">
                    Close
                </button>
            `;
            
            extraActions.forEach(action => {
                if (action.primary) {
                    actionsHtml += `
                        <button onclick="${action.onClick}; closeSuccessModal();" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r ${iconConfig.gradient} text-white font-bold shadow-lg transition-all hover:opacity-90">
                            ${action.label}
                        </button>
                    `;
                } else {
                    actionsHtml += `
                        <button onclick="${action.onClick}" class="flex-1 py-3 px-4 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold transition-all">
                            ${action.label}
                        </button>
                    `;
                }
            });
            
            actionsEl.innerHTML = actionsHtml;
            
            // Show modal with animation
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            content.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                modal.style.opacity = '1';
                content.style.transform = 'scale(1)';
            }, 10);
            
            // Play celebration sound
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdX6IkJGNhXx2cWxqaWxwdXuBho2TmJygnpyZlZGNiYaBfXp4d3Z2dnh6fICEiIyQk5aYmpubnJybnJubmpmYl5aVlJOSkZCPjo2Mi4qJiIeHh4eHh4iIiYqLjI2Oj5CRkpOUlZaXl5iZmZqam5ubnJycnJycnJycnJycm5ubm5qampmZmJiXl5aWlZWUlJOTkpKRkZCQj4+OjY2MjIuLioqJiYiIh4eGhoWFhYWEhISEhISEhIODg4OCgoKCgoKBgYGBgYCAgICAgH9/f39/f39/fn5+fn5+fn5+fn5+fn5+fn5+fn5+');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
        }
        
        function closeSuccessModal() {
            const modal = document.getElementById('success-modal');
            const content = document.getElementById('success-modal-content');
            
            modal.style.opacity = '0';
            content.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    </script>
</body>
</html>

